<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panneaux de grille</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        h1 {
            color: #333;
        }
        h2 {
            color: #555;
            margin-top: 30px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .sheet-title {
            margin-top: 40px;
            color: #333;
            border-bottom: 2px solid #333;
            padding-bottom: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sheet-title .toggle-icon {
            font-size: 18px;
            transition: transform 0.3s;
        }
        .sheet-title .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }
        #loading {
            text-align: center;
            margin: 20px;
            font-style: italic;
        }
        .error {
            color: red;
            font-weight: bold;
            display: none;
        }
        .total-cell {
            background-color: #e6f2ff;
            font-weight: bold;
            text-align: right;
        }
        .sheet-container {
            margin-bottom: 40px;
        }
        .sheet-content {
            display: none;
            transition: height 0.3s ease;
        }
        .file-container {
            margin-bottom: 60px;
            padding-bottom: 20px;
            border-bottom: 3px dashed #ccc;
        }
        .file-title {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
            border-left: 5px solid #4CAF50;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .file-content {
            display: none;
            transition: height 0.3s ease;
        }
        /* Styles pour la recherche de site */
        .search-container {
            margin: 20px 0;
            padding: 20px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .search-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .search-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        #quantity-filter {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }

        .search-input {
            padding: 8px;
            width: 100px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .search-select {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            flex-grow: 1;
            max-width: 400px;
        }
        .search-button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .search-button:hover {
            background-color: #45a049;
        }
        #site-result {
            margin-top: 20px;
            display: none;
        }
        .result-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #45a049;
            padding-bottom: 5px;
        }
        .result-table {
            width: 100%;
            border-collapse: collapse;
        }
        .result-table th {
            background-color: #4CAF50;
            color: white;
            padding: 12px;
            text-align: left;
        }
        .result-table tr:hover {
            background-color: #f1f1f1;
        }
        .result-table td {
            padding: 10px;
        }
        .price-cell {
            text-align: right;
            font-weight: bold;
            color: #2c7fb8;
        }
        .toggle-all-btn {
            margin: 10px 0;
            padding: 8px 15px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .toggle-all-btn:hover {
            background-color: #0b7dda;
        }
        .no-result {
            padding: 20px;
            text-align: center;
            color: #d9534f;
            font-style: italic;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
        }

        /* Styles pour la popup d'authentification */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* S'assurer que la popup est au-dessus de tout */
        }

        .auth-container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            width: 300px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .auth-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            color: #333;
        }

        .auth-form-group {
            margin-bottom: 15px;
        }

        .auth-form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .auth-form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .auth-button {
            width: 100%;
            padding: 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .auth-button:hover {
            background-color: #45a049;
        }

        .auth-error {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 15px;
            text-align: center;
            display: none;
        }

        #site-result {
            margin-top: 30px;
            padding: 15px;
            border: 1px solid #4CAF50;
            border-radius: 5px;
            background-color: #f7fff7;
        }

        .reset-button {
            margin-top: 15px;
            padding: 10px 20px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .reset-button:hover {
            background-color: #d32f2f;
        }

        .transport-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 20px;
            margin-bottom: 10px; /* Ajoute un peu d'espace vertical entre les options */
        }

        .transport-option label {
            margin-right: 5px;
            white-space: nowrap; /* Empêche le texte de passer à la ligne */
        }

        .radio-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .radio-group input[type="radio"] {
            margin-left: 10px;
            margin-right: 3px; /* Espace entre le bouton radio et son label */
        }

        /* S'assurer que tous les labels sont bien alignés */
        .radio-group label {
            margin-right: 10px;
        }

        .total-quantity-display {
            background-color: #e6f2ff;
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
            font-size: 16px;
        }

        #total-quantity-value {
            font-weight: bold;
            color: #2c7fb8;
            font-size: 18px;
        }

        .site-header {
            width: 100%;
            background-color: white;
            padding: 10px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            text-align: center;
        }

        .site-header img {
            max-width: 100%;
            height: auto;
            max-height: 80px;
        }

        /* Styles pour le header avec les deux logos */
        .site-header {
            width: 100%;
            background-color: white;
            padding: 10px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            text-align: center;
        }

        .logo-moscatelli {
            min-height: 100px;
            min-width: 150px;
        }

        .logo-cnr {
            min-height: 300px;
            min-width: 150px;
            object-fit: contain;
            unc sybau js nd t u ng m wrkg
        }

        /* Styles spécifiques pour le conteneur des logos */
        .logos-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 50px; /* Espace entre les deux logos */
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px 0;
        }
    </style>
</head>
<body>
<!-- Ajoutez ce bloc header avant la popup d'authentification -->
<header class="site-header">
    <div class="logos-container">
        <img src="entreprises_moscatelli_cover.jpg" alt="Moscatelli - Chaudronnerie Tuyauterie Mécanique Maintenance Ventilation" class="logo-moscatelli">
        <img src="cnr_logo_encapsule-_q.png" alt="CNR" class="logo-cnr">
    </div>
</header>
<!-- Popup d'authentification -->
<div id="authModal" class="auth-modal">
    <div class="auth-container">
        <div class="auth-title">Authentification requise</div>
        <form id="authForm">
            <div class="auth-form-group">
                <label for="username">Identifiant</label>
                <input type="text" id="username" required>
            </div>
            <div class="auth-form-group">
                <label for="password">Mot de passe</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit" class="auth-button">Valider</button>
            <div id="authError" class="auth-error">Identifiant ou mot de passe incorrect</div>
        </form>
    </div>
</div>

<h1>Formulaire de sélection</h1>

<!-- Conteneur pour la recherche par site -->
<div class="search-container">
    <div class="search-title">Recherche par site</div>
    <div class="search-form">
        <select id="site-select" class="search-select">
            <option value="">Sélectionnez un site...</option>
            <!-- Les options seront ajoutées dynamiquement en JavaScript -->
        </select>
        <button id="search-site-button" class="search-button">Rechercher</button>
    </div>

    <!-- Options de transport (initialement masquées) -->
    <div id="transport-options" class="search-form" style="display: none;">

        <div class="transport-option">
            <label>Transport barreaux:</label>
            <div class="radio-group">
                <input type="radio" id="transport-barreaux-oui" name="transport-barreaux" value="oui">
                <label for="transport-barreaux-oui">Oui</label>
                <input type="radio" id="transport-barreaux-non" name="transport-barreaux" value="non" checked>
                <label for="transport-barreaux-non">Non</label>
            </div>
        </div>


        <!-- Option Manutention (modifiée pour être cohérente) -->
        <div id="manutention-container" class="transport-option" style="display: none;">
            <label>Manutention:</label>
            <div class="radio-group">
                <input type="radio" id="manutention-oui" name="manutention" value="oui">
                <label for="manutention-oui">Oui</label>
                <input type="radio" id="manutention-non" name="manutention" value="non" checked>
                <label for="manutention-non">Non</label>
            </div>
        </div>

        <!-- À ajouter après les boutons radio de manutention -->
        <div id="manutention-days-container" style="display: none; margin-top: 10px; margin-left: 20px;">
            <label for="manutention-days">½ journées de manutention:</label>
            <input type="number" id="manutention-days" class="search-input" min="1" value="1" style="width: 60px;">
        </div>

        <!-- Option Grue (modifiée pour être cohérente) -->
        <div id="dechargement-container" class="transport-option" style="display: none;">
            <label>Grue à prévoir sur le site:</label>
            <div class="radio-group">
                <input type="radio" id="dechargement-oui" name="dechargement" value="oui">
                <label for="dechargement-oui">Oui</label>
                <input type="radio" id="dechargement-non" name="dechargement" value="non" checked>
                <label for="dechargement-non">Non</label>
            </div>
        </div>



        <button id="validate-transport-button" class="search-button">Valider les options</button>
    </div>

    <!-- Filtre de repère (initialement masqué) -->
    <div id="repere-filter" class="search-form" style="display: none;">
        <select id="repere-select" class="search-select">
            <option value="">Sélectionnez un repère...</option>
            <!-- Les options seront ajoutées dynamiquement en JavaScript -->
        </select>
        <button id="search-repere-button" class="search-button">Filtrer</button>
    </div>

    <!-- Formulaire de quantité (initialement masqué) -->
    <div id="quantity-filter" class="search-form" style="display: none;">
        <div>
            <label for="quantity-input">Quantité:</label>
            <input type="number" id="quantity-input" class="search-input" min="1" value="1">
        </div>
        <button id="calculate-button" class="search-button">Valider</button>
    </div>
    <div id="site-result" style="display: none;"></div>
</div>

<div class="toggle-controls">
    <button id="toggle-all-btn" class="toggle-all-btn">Afficher tous les tableaux</button>
</div>

<div id="loading">Chargement des données Excel...</div>
<div id="excel-data"></div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Variables pour stocker les données
        let allItemsBySite = {};
        let allSites = [];
        let filesDataGlobal = {};
        let allTablesVisible = false;
        // Variables pour le transport (ajoutez ces lignes)
        let transportPanneaux = "non";
        let transportBarreaux = "non";
        let dechargement = "non";
        let manutention = "non";

        // Configuration de l'authentification
        const authModal = document.getElementById('authModal');
        const authForm = document.getElementById('authForm');
        const authError = document.getElementById('authError');

        // Stocker les identifiants valides
        const validCredentials = [
            { username: "admin", password: "admin123" },
            { username: "cnrtemp", password: "mdpTemp25" }
        ];

        // Empêcher le défilement du contenu lorsque la popup est active
        document.body.style.overflow = 'hidden';

        // Fonction pour initialiser l'application après authentification
        function initializeApp() {
            // Permettre le défilement à nouveau
            document.body.style.overflow = 'auto';

            // Charger les données Excel
            loadExcelData();
        }

        // Gestionnaire de soumission du formulaire d'authentification
        authForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Vérifier les identifiants
            const isValid = validCredentials.some(cred =>
                cred.username === username && cred.password === password
            );

            if (isValid) {
                // Authentification réussie
                authModal.style.display = 'none';
                initializeApp();
            } else {
                // Authentification échouée
                authError.style.display = 'block';
                setTimeout(() => {
                    authError.style.display = 'none';
                }, 3000);
            }
        });

        // Fonction pour échapper le HTML
        function escapeHtml(unsafe) {
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Fonction pour formater les nombres
        function formatNumber(number) {
            return new Intl.NumberFormat('fr-FR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(number);
        }

        // Fonction pour extraire les sites et leurs items CCTP associés
        function extractSiteData(data) {
            const sites = [];
            const itemsBySite = {};

            // Liste des sites connus
            const knownSites = [
                "DTHR", "DTRS", "DTRI", "DTRM",
                "SEYSSEL", "CHAUTAGNE_BELLEY_BREGNIER-CORDON", "SAULT-BRENAZ",
                "PIERRE-BENITE", "VAUGRIS", "PEAGE DE ROUSSILLON", "SAINT VALLIER",
                "BOURG-LES-VALENCE", "BEAUCHASTEL / LOGIS - NEUF", "BEAUCHASTEL",
                "LOGIS-NEUF", "MONTELIMAR", "DONZERE MONDRAGON",
                "AVIGNON", "SAUVETERRE", "CADEROUSSE", "VALLABREGUES",
                "AVIGNON/SAUVETERRE/CADEROUSSE VALLABREGUES"
            ];

            // Variable pour suivre le site actuel
            let currentSite = null;
            let itemsForCurrentSite = [];

            // Analyser les données uniquement pour le fichier BPU_vrai.xlsx
            for (const fileKey in data) {
                if (fileKey !== 'file1' || !data[fileKey].data) continue;

                const fileData = data[fileKey].data;

                // Parcourir les feuilles du fichier
                for (const sheetName in fileData) {
                    const sheetData = fileData[sheetName];

                    // Trouver l'index de départ (la ligne avec "Item CCTP")
                    let startIndex = -1;
                    for (let i = 0; i < sheetData.length; i++) {
                        const row = sheetData[i];
                        if (row && row[0] === "Item CCTP ") {
                            startIndex = i + 1; // Commencer à la ligne suivante
                            break;
                        }
                    }

                    if (startIndex === -1) continue;

                    // Parcourir les lignes à partir de l'index de départ
                    for (let i = startIndex; i < sheetData.length; i++) {
                        const row = sheetData[i];

                        if (!row || row.length === 0) continue;

                        const itemCCTP = row[0];
                        const description = row[1] || "";
                        const sousTotal = row[8] || 0; // Colonne "Sous-total"

                        // Si c'est un site connu
                        if (itemCCTP && (
                            knownSites.includes(itemCCTP) ||
                            (!/\s/.test(itemCCTP) && !/\d/.test(itemCCTP) && !sousTotal)
                        )) {
                            // C'est un site
                            if (currentSite && itemsForCurrentSite.length > 0) {
                                // Pour gérer les occurrences multiples d'un même site
                                if (!itemsBySite[currentSite]) {
                                    itemsBySite[currentSite] = [];
                                }
                                // Ajouter les items comme un nouveau groupe pour ce site
                                itemsBySite[currentSite] = itemsBySite[currentSite].concat(itemsForCurrentSite);
                            }

                            // Nouveau site courant
                            currentSite = itemCCTP;
                            if (!sites.includes(currentSite)) {
                                sites.push(currentSite);
                            }
                            itemsForCurrentSite = [];
                        }
                        // Si c'est un item CCTP (a un sous-total > 0)
                        else if (itemCCTP && currentSite && sousTotal > 0) {
                            // C'est un item CCTP avec un sous-total
                            itemsForCurrentSite.push({
                                code: itemCCTP,
                                description: description,
                                sousTotal: sousTotal
                            });
                        }
                    }

                    // Sauvegarder les items du dernier site
                    if (currentSite && itemsForCurrentSite.length > 0) {
                        if (!itemsBySite[currentSite]) {
                            itemsBySite[currentSite] = [];
                        }
                        // Ajouter les items comme un nouveau groupe pour ce site
                        itemsBySite[currentSite] = itemsBySite[currentSite].concat(itemsForCurrentSite);
                    }
                }
            }

            return {
                sites: sites.filter(site => site && itemsBySite[site] && itemsBySite[site].length > 0),
                itemsBySite: itemsBySite
            };
        }

        // Fonction pour créer les tableaux HTML pour chaque feuille
        function renderSheetData(data, productTotals, filePath) {
            let html = '';
            const isWeightFile = filePath.includes('ref');

            for (const sheetName in data) {
                const sheetData = data[sheetName];
                const sheetProductTotals = productTotals[sheetName] || { products: {}, rows: {} };
                const sheetId = `sheet-${filePath.replace(/\./g, '-')}-${sheetName.replace(/\s+/g, '-')}`;
                const contentId = `content-${sheetId}`;

                html += `<div class="sheet-container">`;
                html += `<h2 class="sheet-title" data-target="${contentId}">
                            Feuille: ${escapeHtml(sheetName)}
                            <span class="toggle-icon collapsed">▼</span>
                        </h2>`;

                html += `<div id="${contentId}" class="sheet-content">`;
                if (sheetData && sheetData.length > 0) {
                    html += '<table>';

                    // En-têtes (limités aux 14 premières colonnes)
                    html += '<tr>';
                    for (let i = 0; i < Math.min(14, sheetData[0].length); i++) {
                        html += `<th>${escapeHtml(sheetData[0][i] || '')}</th>`;
                    }

                    // Ajouter une colonne pour le total uniquement pour le premier fichier (BPU_vrai.xlsx)
                    if (!isWeightFile) {
                        html += `<th>Total</th>`;
                    }
                    html += '</tr>';

                    // Données
                    for (let i = 1; i < sheetData.length; i++) {
                        html += '<tr>';
                        for (let j = 0; j < Math.min(14, sheetData[i].length); j++) {
                            html += `<td>${escapeHtml(sheetData[i][j] || '')}</td>`;
                        }

                        // Afficher le total uniquement pour le premier fichier
                        if (!isWeightFile) {
                            const rowValue = sheetProductTotals.rows[i] || 0;
                            html += `<td class="total-cell">${formatNumber(rowValue)} €</td>`;
                        }

                        html += '</tr>';
                    }

                    html += '</table>';
                } else {
                    html += '<p>Aucune donnée dans cette feuille</p>';
                }
                html += `</div>`; // Fin de sheet-content
                html += `</div>`; // Fin de sheet-container
            }

            return html;
        }

        // Fonction pour créer l'affichage complet des fichiers
        function renderExcelFiles(filesData) {
            let html = '';

            // Parcourir chaque fichier
            for (const fileKey in filesData) {
                const fileData = filesData[fileKey];
                const fileId = `file-${fileKey}`;
                const contentId = `content-${fileId}`;

                if (fileData.error) {
                    html += `<div class="file-container">`;
                    html += `<div class="file-title" data-target="${contentId}">
                                Fichier: ${escapeHtml(fileData.filePath || fileKey)}
                                <span class="toggle-icon collapsed">▼</span>
                            </div>`;
                    html += `<div id="${contentId}" class="file-content">`;
                    html += `<div class="error" style="display:block;">${escapeHtml(fileData.error)}</div>`;
                    html += `</div>`;
                    html += `</div>`;
                    continue;
                }

                html += `<div class="file-container">`;
                html += `<div class="file-title" data-target="${contentId}">
                            Fichier: ${escapeHtml(fileData.filePath)}
                            <span class="toggle-icon collapsed">▼</span>
                        </div>`;

                html += `<div id="${contentId}" class="file-content">`;
                // Ajouter les données de chaque feuille du fichier
                html += renderSheetData(fileData.data, fileData.productTotals, fileData.filePath);
                html += `</div>`;

                html += `</div>`;
            }

            return html;
        }

        // Fonction pour remplir le sélecteur de sites
        function populateSiteSelect(sites) {
            const selectElement = document.getElementById('site-select');

            // Sites à exclure
            const sitesToExclude = [
                "AVIGNON/SAUVETERRE/CADEROUSSE VALLABREGUES",
                "BEAUCHASTEL",
                "LOGIS-NEUF"
            ];

            // Filtrer les sites exclus
            const filteredSites = sites.filter(site =>
                site && !sitesToExclude.includes(site)
            );

            // Trier les sites par ordre alphabétique
            filteredSites.sort();

            // Vider d'abord le sélecteur (sauf l'option par défaut)
            while (selectElement.options.length > 1) {
                selectElement.remove(1);
            }

            // Ajouter chaque site comme option
            filteredSites.forEach(site => {
                if (!site) return; // Ignorer les sites vides

                const option = document.createElement('option');
                option.value = site;
                option.textContent = site;
                selectElement.appendChild(option);
            });
        }

// Fonction pour remplir le sélecteur de repères pour un site donné
        function populateRepereSelect(site) {
            const selectElement = document.getElementById('repere-select');
            const repereFilterDiv = document.getElementById('repere-filter');

            // Vider d'abord le sélecteur (sauf l'option par défaut)
            while (selectElement.options.length > 1) {
                selectElement.remove(1);
            }

            // Récupérer les items pour le site sélectionné
            let items = [];

            // Cas spécial pour "BEAUCHASTEL / LOGIS - NEUF" (combiner les deux sites)
            if (site === "BEAUCHASTEL / LOGIS - NEUF") {
                // Récupérer les items de Beauchastel
                const itemsBeauchastel = allItemsBySite["BEAUCHASTEL"] || [];
                // Récupérer les items de Logis-Neuf
                const itemsLogisNeuf = allItemsBySite["LOGIS-NEUF"] || [];
                // Combiner les deux ensembles d'items
                items = [...itemsBeauchastel, ...itemsLogisNeuf];
            } else {
                // Comportement standard pour les autres sites
                items = allItemsBySite[site] || [];
            }

            if (items.length === 0) {
                repereFilterDiv.style.display = 'none';
                return;
            }

            // Créer un Set pour éviter les doublons de descriptions
            const reperes = new Set();

            // Mots à bannir
            const motsABannir = ['entretoise', 'capot', 'attache'];

            // Ajouter chaque description unique qui contient le mot "Panneaux" (ou variations)
            // et qui ne contient aucun des mots bannis
            items.forEach(item => {
                if (item.description) {
                    const description = item.description.toLowerCase();

                    // Vérifier si la description contient un mot lié à "panneau"
                    const contientPanneau = description.includes('panneau') ||
                        description.includes('panneaux') ||
                        description.includes('pannaux');

                    // Vérifier si la description contient un des mots bannis
                    const contientMotBanni = motsABannir.some(mot => description.includes(mot));

                    // Ajouter seulement si c'est un panneau sans mot banni
                    if (contientPanneau && !contientMotBanni) {
                        reperes.add(item.description);
                    }
                }
            });

            // Convertir en array et trier
            const reperesArray = Array.from(reperes).sort();

            // Si aucun repère correspondant aux critères n'est trouvé, masquer le filtre
            if (reperesArray.length === 0) {
                repereFilterDiv.style.display = 'none';
                return;
            }

            // Ajouter chaque repère comme option
            reperesArray.forEach(repere => {
                const option = document.createElement('option');
                option.value = repere;
                option.textContent = repere;
                selectElement.appendChild(option);
            });

            // Afficher le filtre de repère
            repereFilterDiv.style.display = 'flex';
        }

        // Fonction de recherche par site
        function searchBySite() {
            const resultDiv = document.getElementById('site-result');
            const transportOptionsDiv = document.getElementById('transport-options');

            // Retirons cette ligne qui masque le tableau résultat
            // resultDiv.style.display = 'none';

            const selectedSite = document.getElementById('site-select').value;

            // Vérifier qu'un site est sélectionné
            if (!selectedSite) {
                // resultDiv.innerHTML = `<div class="no-result">Veuillez sélectionner un site</div>`;
                // Éviter de modifier le contenu du tableau résultat si déjà présent
                // Masquer le filtre de repère et les options de transport
                document.getElementById('repere-filter').style.display = 'none';
                transportOptionsDiv.style.display = 'none';
                return;
            }

            // Récupérer les items pour le site sélectionné
            const items = allItemsBySite[selectedSite] || [];

            if (items.length === 0) {
                // resultDiv.innerHTML = `<div class="no-result">Aucun item trouvé pour le site "${escapeHtml(selectedSite)}"</div>`;
                // Éviter de modifier le contenu du tableau résultat si déjà présent
                // Masquer le filtre de repère et les options de transport
                document.getElementById('repere-filter').style.display = 'none';
                transportOptionsDiv.style.display = 'none';
                return;
            }

            // Remplir le sélecteur de repères
            populateRepereSelect(selectedSite);

            // Afficher les options de transport
            transportOptionsDiv.style.display = 'flex';
        }

// Fonction de filtrage par repère
        function filterByRepere() {
            const resultDiv = document.getElementById('site-result');
            const selectedSite = document.getElementById('site-select').value;
            const selectedRepere = document.getElementById('repere-select').value;
            const quantityFilterDiv = document.getElementById('quantity-filter');

            // Supprimons cette ligne qui masque le div de résultat
            // resultDiv.style.display = 'none';

            // Vérifier qu'un site et un repère sont sélectionnés
            if (!selectedSite || !selectedRepere) {
                quantityFilterDiv.style.display = 'none';
                return;
            }

            // Récupérer les items pour le site sélectionné
            let allItems = [];

            // Cas spécial pour "BEAUCHASTEL / LOGIS - NEUF"
            if (selectedSite === "BEAUCHASTEL / LOGIS - NEUF") {
                const itemsBeauchastel = allItemsBySite["BEAUCHASTEL"] || [];
                const itemsLogisNeuf = allItemsBySite["LOGIS-NEUF"] || [];
                allItems = [...itemsBeauchastel, ...itemsLogisNeuf];
            } else {
                allItems = allItemsBySite[selectedSite] || [];
            }

            // Filtrer les items par repère
            const filteredItems = allItems.filter(item => item.description === selectedRepere);

            if (filteredItems.length === 0) {
                // Supprimons/modifions cette partie qui remplace le contenu du résultat
                // resultDiv.innerHTML = `<div class="no-result">Aucun item trouvé pour le repère "${escapeHtml(selectedRepere)}"</div>`;
                // Au lieu de cela, affichons une alerte non bloquante
                alert(`Aucun item trouvé pour le repère "${selectedRepere}"`);
                quantityFilterDiv.style.display = 'none';
                return;
            }

            // Stocker les items filtrés dans une variable globale pour la fonction de calcul
            window.currentFilteredItems = filteredItems;

            // Afficher le formulaire de quantité
            quantityFilterDiv.style.display = 'flex';

            // Réinitialiser la quantité à 1
            document.getElementById('quantity-input').value = 1;
        }

// Fonction pour valider les options de transport pour un site
        function validateTransportOptions() {
            const selectedSite = document.getElementById('site-select').value;

            // Vérifier qu'un site est sélectionné
            if (!selectedSite) {
                alert("Veuillez sélectionner un site.");
                return;
            }

            // Si c'est la première fois que l'on ajoute un résultat
            if (!window.cumulativeResults) {
                window.cumulativeResults = [];
            }

            // Récupérer le nombre de demi-journées si la manutention est "oui"
            let nbDemiJournees = 0;
            if (manutention === "oui") {
                nbDemiJournees = parseInt(document.getElementById('manutention-days').value) || 1;
                if (nbDemiJournees < 1) {
                    nbDemiJournees = 1;
                    document.getElementById('manutention-days').value = 1;
                }
            }

            // Vérifier si une ligne d'options de transport existe déjà pour ce site
            const existingTransportIndex = window.cumulativeResults.findIndex(
                result => result.isTransportOnly && result.site === selectedSite
            );

            if (existingTransportIndex !== -1) {
                // Une entrée existe déjà, mettre à jour plutôt qu'ajouter
                window.cumulativeResults[existingTransportIndex].transportPanneaux = transportPanneaux;
                window.cumulativeResults[existingTransportIndex].transportBarreaux = transportBarreaux;
                window.cumulativeResults[existingTransportIndex].dechargement = dechargement;
                window.cumulativeResults[existingTransportIndex].manutention = manutention;

                // Ajouter le nombre de demi-journées seulement si manutention est "oui"
                if (manutention === "oui") {
                    window.cumulativeResults[existingTransportIndex].manutentionDays = nbDemiJournees;
                } else {
                    // Supprimer la propriété si elle existe
                    delete window.cumulativeResults[existingTransportIndex].manutentionDays;
                }
            } else {
                // Aucune entrée existante, ajouter une nouvelle
                const entryId = 'transport-' + Date.now();

                const newEntry = {
                    id: entryId,
                    site: selectedSite,
                    isTransportOnly: true,
                    transportPanneaux: transportPanneaux,
                    transportBarreaux: transportBarreaux,
                    dechargement: dechargement,
                    manutention: manutention
                };

                // Ajouter le nombre de demi-journées seulement si manutention est "oui"
                if (manutention === "oui") {
                    newEntry.manutentionDays = nbDemiJournees;
                }

                window.cumulativeResults.push(newEntry);
            }

            // Mettre à jour l'affichage du tableau
            updateResultsTable();
        }



        // Fonction pour masquer les fichiers Excel
        function hideExcelData() {
            const excelDataContainer = document.getElementById('excel-data');
            if (excelDataContainer) {
                excelDataContainer.style.display = 'none';
            }

            // Masquer également le bouton de toggle qui contrôle l'affichage des tableaux
            const toggleButton = document.getElementById('toggle-all-btn');
            if (toggleButton) {
                toggleButton.style.display = 'none';
            }

            // Masquer le titre "Affichage des fichiers Excel"
            const titleElements = document.getElementsByTagName('h1');
            for (let i = 0; i < titleElements.length; i++) {
                if (titleElements[i].innerText === 'Affichage des fichiers Excel') {
                    titleElements[i].style.display = 'none';
                }
            }

            // Masquer le div de contrôle des tableaux
            const toggleControls = document.querySelector('.toggle-controls');
            if (toggleControls) {
                toggleControls.style.display = 'none';
            }
        }

// Fonction de calcul avec quantité
        function calculateWithQuantity() {
            const resultDiv = document.getElementById('site-result');
            const quantityInput = document.getElementById('quantity-input');
            const selectedRepere = document.getElementById('repere-select').value;
            const selectedSite = document.getElementById('site-select').value;

            // Vérifier que la quantité est valide
            const quantity = parseInt(quantityInput.value, 10);
            if (isNaN(quantity) || quantity < 1) {
                quantityInput.value = 1;
                return;
            }

            // Vérifier que nous avons des items filtrés
            if (!window.currentFilteredItems || window.currentFilteredItems.length === 0) {
                return;
            }

            // Initialiser le tableau de résultats si nécessaire
            if (!window.cumulativeResults) {
                window.cumulativeResults = [];
            }

            // Supprimer le code qui ajoutait automatiquement la ligne d'options de transport

            // Calculer le total pour les items filtrés avec la quantité
            let totalAmount = 0;
            window.currentFilteredItems.forEach(item => {
                totalAmount += parseFloat(item.sousTotal) || 0;
            });

            // Multiplier par la quantité
            const finalAmount = totalAmount * quantity;

            // Générer un ID unique pour l'entrée de produit
            const productEntryId = 'product-' + Date.now();

            // Ajouter le produit au tableau cumulé
            window.cumulativeResults.push({
                id: productEntryId,
                site: selectedSite,
                description: selectedRepere,
                quantity: quantity,
                totalPrice: finalAmount
            });

            // Mettre à jour l'affichage du tableau
            updateResultsTable();
        }

        /**
         * Calcule et affiche les forfaits logistique et suivi
         * Cette fonction est appelée à chaque mise à jour du tableau récapitulatif
         */
        function calculerEtAfficherForfaits() {
            // Vérifier si nous avons des résultats dans le tableau récapitulatif
            if (!window.cumulativeResults || window.cumulativeResults.length === 0) {
                console.log("Aucun forfait (aucun panneau sélectionné)");
                return {
                    logistique: 0,
                    suivi: 0,
                    total: 0
                };
            }

            // Calculer la quantité totale de panneaux
            let quantiteTotalePanneaux = 0;

            window.cumulativeResults.forEach(result => {
                quantiteTotalePanneaux += parseInt(result.quantity) || 0;
            });

            // Déterminer les forfaits unitaires en fonction de la quantité
            let forfaitLogistiqueUnitaire = calculerForfaitLogistique(quantiteTotalePanneaux);
            let forfaitSuiviUnitaire = calculerForfaitSuivi(quantiteTotalePanneaux);

            // Calculer les forfaits totaux (forfait unitaire * quantité totale)
            let forfaitLogistiqueTotal = forfaitLogistiqueUnitaire * quantiteTotalePanneaux;
            let forfaitSuiviTotal = forfaitSuiviUnitaire * quantiteTotalePanneaux;
            let forfaitTotal = forfaitLogistiqueTotal + forfaitSuiviTotal;

            // Afficher les résultats dans la console
            console.log("Nombre total de panneaux: " + quantiteTotalePanneaux);
            console.log("Forfait logistique unitaire: " + forfaitLogistiqueUnitaire.toFixed(2) + " €");
            console.log("Forfait logistique total: " + forfaitLogistiqueTotal.toFixed(2) + " €");
            console.log("Forfait suivi unitaire: " + forfaitSuiviUnitaire.toFixed(2) + " €");
            console.log("Forfait suivi total: " + forfaitSuiviTotal.toFixed(2) + " €");
            console.log("Total des forfaits: " + forfaitTotal.toFixed(2) + " €");

            return {
                logistique: forfaitLogistiqueTotal,
                suivi: forfaitSuiviTotal,
                total: forfaitTotal
            };
        }

        /**
         * Calcule le forfait logistique unitaire en fonction de la quantité totale de panneaux
         *
         * @param {number} quantiteTotalePanneaux - Nombre total de panneaux
         * @return {number} Le montant du forfait logistique unitaire
         */
        function calculerForfaitLogistique(quantiteTotalePanneaux) {
            // Déterminer le forfait en fonction de la quantité
            if (quantiteTotalePanneaux <= 0) {
                return 0; // Pas de forfait si pas de panneaux
            } else if (quantiteTotalePanneaux <= 25) {
                return 213.78; // 0 à 25 panneaux
            } else if (quantiteTotalePanneaux <= 50) {
                return 187.06; // 26 à 50 panneaux
            } else if (quantiteTotalePanneaux <= 75) {
                return 160.34; // 51 à 75 panneaux
            } else {
                return 133.61; // Au-delà de 75 panneaux
            }
        }

        /**
         * Calcule le forfait suivi unitaire en fonction de la quantité totale de panneaux
         *
         * @param {number} quantiteTotalePanneaux - Nombre total de panneaux
         * @return {number} Le montant du forfait suivi unitaire
         */
        function calculerForfaitSuivi(quantiteTotalePanneaux) {
            // Déterminer le forfait en fonction de la quantité
            if (quantiteTotalePanneaux <= 0) {
                return 0; // Pas de forfait si pas de panneaux
            } else if (quantiteTotalePanneaux <= 25) {
                return 394.88; // 0 à 25 panneaux
            } else if (quantiteTotalePanneaux <= 50) {
                return 334.88; // 26 à 50 panneaux
            } else if (quantiteTotalePanneaux <= 75) {
                return 274.88; // 51 à 75 panneaux
            } else {
                return 214.87; // Au-delà de 75 panneaux
            }
        }

        /**
         * Calcule le prix des soudages de barreaux pour les panneaux supérieurs à St-Vallier
         * Cette fonction est appelée à chaque mise à jour du tableau récapitulatif
         *
         * @return {number} Le prix total des soudages de barreaux
         */
        function calculerPrixSoudageBarreaux() {
            // Vérifier si nous avons des résultats dans le tableau récapitulatif
            if (!window.cumulativeResults || window.cumulativeResults.length === 0) {
                console.log("Prix soudage barreaux: 0 € (aucun panneau sélectionné)");
                return 0;
            }

            // Compteur pour les panneaux supérieurs de St-Vallier
            let nbPanneauxSupStVallier = 0;

            // Parcourir tous les panneaux dans le tableau récapitulatif
            window.cumulativeResults.forEach(result => {
                // Vérifier si c'est un panneau sur le site St-Vallier
                const estStVallier = result.site &&
                    (result.site.toUpperCase().includes("SAINT VALLIER") ||
                        result.site.toUpperCase().includes("ST VALLIER") ||
                        result.site.toUpperCase().includes("ST-VALLIER"));

                // Vérifier si c'est un panneau supérieur
                const estPanneauSuperieur = result.description &&
                    (result.description.toLowerCase().includes("supérieur") ||
                        result.description.toLowerCase().includes("superieur"));

                // Si c'est un panneau supérieur à St-Vallier, ajouter sa quantité au compteur
                if (estStVallier && estPanneauSuperieur) {
                    const quantite = parseInt(result.quantity) || 0;
                    nbPanneauxSupStVallier += quantite;
                }
            });

            // Calculer le prix total des soudages de barreaux
            const prixUnitaireSoudage = 533.56;
            const prixTotalSoudage = nbPanneauxSupStVallier * prixUnitaireSoudage;

            // Afficher les résultats dans la console
            console.log("Nombre de panneaux supérieurs à St-Vallier: " + nbPanneauxSupStVallier);
            console.log("Prix unitaire du soudage de barreaux: " + prixUnitaireSoudage.toFixed(2) + " €");
            console.log("Prix total des soudages de barreaux: " + prixTotalSoudage.toFixed(2) + " €");

            return prixTotalSoudage;
        }

        /**
         * Calcule le prix du transport des barreaux pour chaque site
         * Cette fonction est appelée à chaque mise à jour du tableau récapitulatif
         *
         * @return {Object} Objet contenant les prix de transport par site et le prix total
         */
        /**
         * Calcule le prix du transport des barreaux pour chaque site
         * Cette fonction est appelée à chaque mise à jour du tableau récapitulatif
         *
         * @return {Object} Objet contenant les prix de transport par site et le prix total
         */
        function calculerPrixTransportBarreaux() {
            console.log("=== DÉBUT DU CALCUL DU PRIX DE TRANSPORT DES BARREAUX ===");

            // Vérifier si nous avons des résultats dans le tableau récapitulatif
            if (!window.cumulativeResults || window.cumulativeResults.length === 0) {
                console.log("Prix transport barreaux: 0 € (aucun panneau sélectionné)");
                return { total: 0, detailParSite: {} };
            }

            console.log("Nombre d'éléments dans le tableau récapitulatif:", window.cumulativeResults.length);
            console.log("Contenu du tableau récapitulatif:", JSON.stringify(window.cumulativeResults, null, 2));

            // Objet pour stocker les informations par site
            const sitesInfo = {};
            // Objet pour suivre les sites qui ont l'option de transport des barreaux activée
            const sitesAvecTransportBarreaux = {};

            // Vérifier d'abord quels sites ont l'option "transport barreaux" sur "oui"
            console.log("Recherche des sites avec option transport barreaux...");
            window.cumulativeResults.forEach((result, index) => {
                console.log(`Analyse de l'élément ${index}:`, result);

                if (!result.site) {
                    console.log("  Pas de site spécifié, ignoré");
                    return;
                }

                // Vérifier si l'élément a la propriété transportBarreaux
                if (result.transportBarreaux) {
                    console.log(`  Trouvé option transport barreaux pour le site ${result.site}: ${result.transportBarreaux}`);

                    // Vérifier si l'option est sur "oui"
                    const estTransportActive = result.transportBarreaux.toLowerCase() === "oui";

                    console.log(`  Option transport active: ${estTransportActive}`);

                    // Marquer ce site comme ayant l'option de transport activée
                    if (estTransportActive) {
                        sitesAvecTransportBarreaux[result.site] = true;
                    }
                }
            });

            console.log("Sites avec transport barreaux activé:", sitesAvecTransportBarreaux);

            // Pour chaque panneau, calculer le poids selon le type (inférieur/supérieur)
            console.log("Calcul des poids par site...");
            window.cumulativeResults.forEach((result, index) => {
                if (!result.site) {
                    console.log(`Élément ${index} sans site, ignoré`);
                    return;
                }

                // Ignorer l'élément s'il a isTransportOnly = true (c'est une option, pas un panneau)
                if (result.isTransportOnly) {
                    console.log(`Élément ${index} est une option de transport, ignoré pour le calcul de poids`);
                    return;
                }

                // Ignorer les sites qui n'ont pas l'option transport barreaux activée
                if (!sitesAvecTransportBarreaux[result.site]) {
                    console.log(`Site ${result.site} n'a pas l'option transport barreaux activée, ignoré`);
                    return;
                }

                console.log(`Analyse panneau ${index}:`, result);

                // Initialiser les infos du site si nécessaire
                if (!sitesInfo[result.site]) {
                    sitesInfo[result.site] = {
                        poidsTotal: 0,
                        nombrePanneauxInferieurs: 0,
                        nombrePanneauxSuperieurs: 0,
                        prixUnitaire: 0
                    };
                    console.log(`  Initialisation des infos pour le site ${result.site}`);
                }

                // Déterminer le prix unitaire selon le site
                sitesInfo[result.site].prixUnitaire = getPrixUnitaireTransport(result.site);
                console.log(`  Prix unitaire pour ${result.site}: ${sitesInfo[result.site].prixUnitaire} €`);

                // Vérifier si c'est un panneau (il doit avoir une description)
                if (!result.description) {
                    console.log(`  Pas de description, ignoré`);
                    return;
                }

                // Ignorer les entrées qui ne sont pas des panneaux
                if (!result.description.toLowerCase().includes("panneau")) {
                    console.log(`  Pas un panneau, ignoré`);
                    return;
                }

                // Déterminer si c'est un panneau inférieur ou supérieur
                const estPanneauSuperieur = result.description.toLowerCase().includes("supérieur") ||
                    result.description.toLowerCase().includes("superieur");

                const estPanneauInferieur = result.description.toLowerCase().includes("inférieur") ||
                    result.description.toLowerCase().includes("inferieur");

                console.log(`  Est panneau supérieur: ${estPanneauSuperieur}`);
                console.log(`  Est panneau inférieur: ${estPanneauInferieur}`);

                // Obtenir la quantité
                const quantite = parseInt(result.quantity) || 0;
                console.log(`  Quantité: ${quantite}`);

                // Calculer le poids et l'ajouter au poids total du site
                if (estPanneauSuperieur) {
                    sitesInfo[result.site].nombrePanneauxSuperieurs += quantite;
                    const poidsAjoute = quantite * 0.4284;
                    sitesInfo[result.site].poidsTotal += poidsAjoute;
                    console.log(`  Ajout de ${quantite} panneaux supérieurs (${poidsAjoute.toFixed(4)} tonnes)`);
                } else if (estPanneauInferieur) {
                    sitesInfo[result.site].nombrePanneauxInferieurs += quantite;
                    const poidsAjoute = quantite * 0.2676;
                    sitesInfo[result.site].poidsTotal += poidsAjoute;
                    console.log(`  Ajout de ${quantite} panneaux inférieurs (${poidsAjoute.toFixed(4)} tonnes)`);
                } else {
                    console.log(`  Type de panneau non identifié, ignoré`);
                }
            });

            console.log("Résumé des informations par site après calcul des poids:", sitesInfo);

            // Calculer le prix de transport pour chaque site et le prix total
            let prixTotalTransport = 0;
            const detailParSite = {};

            console.log("Calcul des prix de transport par site...");
            for (const site in sitesInfo) {
                const info = sitesInfo[site];
                console.log(`Calcul pour le site ${site}:`);

                // Calculer le nombre de camions nécessaires (arrondi à l'entier supérieur)
                const nombreCamions = Math.ceil(info.poidsTotal / 19);
                console.log(`  Poids total: ${info.poidsTotal.toFixed(4)} tonnes`);
                console.log(`  Nombre de camions nécessaires: ${nombreCamions}`);

                // Calculer le prix de transport pour ce site
                const prixTransportSite = nombreCamions * info.prixUnitaire;
                console.log(`  Prix unitaire: ${info.prixUnitaire.toFixed(2)} €`);
                console.log(`  Prix transport pour ce site: ${prixTransportSite.toFixed(2)} €`);

                // Ajouter au prix total
                prixTotalTransport += prixTransportSite;
                console.log(`  Prix total cumulé: ${prixTotalTransport.toFixed(2)} €`);

                // Stocker les détails pour ce site
                detailParSite[site] = {
                    nombrePanneauxInferieurs: info.nombrePanneauxInferieurs,
                    nombrePanneauxSuperieurs: info.nombrePanneauxSuperieurs,
                    poidsTotal: info.poidsTotal,
                    nombreCamions: nombreCamions,
                    prixUnitaire: info.prixUnitaire,
                    prixTransport: prixTransportSite
                };

                // Afficher les détails dans la console
                console.log(`Site: ${site}`);
                console.log(`  Panneaux inférieurs: ${info.nombrePanneauxInferieurs} (${(info.nombrePanneauxInferieurs * 0.2676).toFixed(4)} tonnes)`);
                console.log(`  Panneaux supérieurs: ${info.nombrePanneauxSuperieurs} (${(info.nombrePanneauxSuperieurs * 0.4284).toFixed(4)} tonnes)`);
                console.log(`  Poids total: ${info.poidsTotal.toFixed(4)} tonnes`);
                console.log(`  Nombre de camions: ${nombreCamions}`);
                console.log(`  Prix unitaire: ${info.prixUnitaire.toFixed(2)} €`);
                console.log(`  Prix transport: ${prixTransportSite.toFixed(2)} €`);
            }

            console.log(`Prix total du transport des barreaux: ${prixTotalTransport.toFixed(2)} €`);
            console.log("=== FIN DU CALCUL DU PRIX DE TRANSPORT DES BARREAUX ===");

            return {
                total: prixTotalTransport,
                detailParSite: detailParSite
            };
        }

        /**
         * Détermine le prix unitaire du transport selon le site
         *
         * @param {string} site - Nom du site
         * @return {number} Prix unitaire du transport
         */
        function getPrixUnitaireTransport(site) {
            const siteUpper = site.toUpperCase();

            // Groupe 1 (1545.60 €)
            if (siteUpper.includes("SEYSSEL") ||
                siteUpper.includes("CHAUTAGNE") ||
                siteUpper.includes("BELLEY") ||
                siteUpper.includes("BREGNIER-CORDON") ||
                siteUpper.includes("SAULT-BRENAZ")) {
                return 1545.60;
            }

            // Groupe 2 (1360.80 €)
            if (siteUpper.includes("PIERRE-BENITE") ||
                siteUpper.includes("VAUGRIS") ||
                siteUpper.includes("PEAGE DE ROUSSILLON") ||
                siteUpper.includes("SAINT VALLIER") ||
                siteUpper.includes("ST VALLIER") ||
                siteUpper.includes("ST-VALLIER")) {
                return 1360.80;
            }

            // Groupe 3 (1108.80 €)
            if (siteUpper.includes("BOURG-LES-VALENCE") ||
                siteUpper.includes("MONTELIMAR") ||
                siteUpper.includes("BEAUCHASTEL") ||
                siteUpper.includes("LOGIS-NEUF")) {
                return 1108.80;
            }

            // Groupe 4 (947.52 €)
            if (siteUpper.includes("DONZERE MONDRAGON") ||
                siteUpper.includes("AVIGNON") ||
                siteUpper.includes("SAUVETERRE") ||
                siteUpper.includes("CADEROUSSE") ||
                siteUpper.includes("VALLABREGUES")) {
                return 947.52;
            }

            // Par défaut, retourner le prix le plus bas
            return 947.52;
        }

        /**
         * Calcule le prix de la manutention pour chaque site
         * Cette fonction est appelée à chaque mise à jour du tableau récapitulatif
         *
         * @return {Object} Objet contenant les prix de manutention par site et le prix total
         */
        function calculerPrixManutention() {
            console.log("=== DÉBUT DU CALCUL DU PRIX DE MANUTENTION ===");

            // Vérifier si nous avons des résultats dans le tableau récapitulatif
            if (!window.cumulativeResults || window.cumulativeResults.length === 0) {
                console.log("Prix manutention: 0 € (aucun site avec manutention activée)");
                return { total: 0, detailParSite: {} };
            }

            console.log("Contenu du tableau récapitulatif:", JSON.stringify(window.cumulativeResults, null, 2));

            // Calculer le prix de la manutention pour chaque site
            let prixTotalManutention = 0;
            const detailParSite = {};

            // Parcourir tous les éléments dans le tableau récapitulatif
            window.cumulativeResults.forEach((result, index) => {
                // Ignorer les éléments qui ne sont pas des options de transport
                if (!result.isTransportOnly) {
                    return;
                }

                // Ignorer les sites qui n'ont pas l'option manutention activée
                if (result.manutention !== "oui" || !result.manutentionDays) {
                    return;
                }

                const site = result.site;
                const nbDemiJournees = parseInt(result.manutentionDays) || 0;

                if (nbDemiJournees <= 0) {
                    return;
                }

                // Déterminer le prix unitaire selon le site
                const prixUnitaire = getPrixUnitaireManutention(site);
                console.log(`Site ${site}: prix unitaire manutention = ${prixUnitaire} €`);

                // Calculer le prix de manutention pour ce site
                const prixManutentionSite = nbDemiJournees * prixUnitaire;
                console.log(`Site ${site}: ${nbDemiJournees} demi-journée(s) * ${prixUnitaire} € = ${prixManutentionSite} €`);

                // Ajouter au prix total
                prixTotalManutention += prixManutentionSite;

                // Stocker les détails pour ce site
                detailParSite[site] = {
                    nbDemiJournees: nbDemiJournees,
                    prixUnitaire: prixUnitaire,
                    prixManutention: prixManutentionSite
                };
            });

            console.log(`Prix total de la manutention: ${prixTotalManutention.toFixed(2)} €`);
            console.log("=== FIN DU CALCUL DU PRIX DE MANUTENTION ===");

            return {
                total: prixTotalManutention,
                detailParSite: detailParSite
            };
        }

        /**
         * Détermine le prix unitaire de la manutention selon le site
         *
         * @param {string} site - Nom du site
         * @return {number} Prix unitaire de la manutention
         */
        function getPrixUnitaireManutention(site) {
            const siteUpper = site.toUpperCase();

            // Groupe 1 (1467.84 €)
            if (siteUpper.includes("SEYSSEL") ||
                siteUpper.includes("CHAUTAGNE") ||
                siteUpper.includes("BELLEY") ||
                siteUpper.includes("BREGNIER-CORDON") ||
                siteUpper.includes("SAULT-BRENAZ")) {
                return 1467.84;
            }

            // Groupe 2 (829.34 €)
            if (siteUpper.includes("PIERRE-BENITE") ||
                siteUpper.includes("VAUGRIS") ||
                siteUpper.includes("PEAGE DE ROUSSILLON") ||
                siteUpper.includes("SAINT VALLIER") ||
                siteUpper.includes("ST VALLIER") ||
                siteUpper.includes("ST-VALLIER")) {
                return 829.34;
            }

            // Groupe 3 (721.57 €)
            if (siteUpper.includes("BOURG-LES-VALENCE") ||
                siteUpper.includes("MONTELIMAR") ||
                siteUpper.includes("BEAUCHASTEL") ||
                siteUpper.includes("LOGIS-NEUF")) {
                return 721.57;
            }

            // Groupe 4 (584.60 €)
            if (siteUpper.includes("DONZERE MONDRAGON") ||
                siteUpper.includes("AVIGNON") ||
                siteUpper.includes("SAUVETERRE") ||
                siteUpper.includes("CADEROUSSE") ||
                siteUpper.includes("VALLABREGUES")) {
                return 584.60;
            }

            // Par défaut, retourner le prix le plus bas
            return 584.60;
        }

        /**
         * Calcule le prix du grutage et l'ajoute au prix total de la manutention
         * Cette fonction est appelée après calculerPrixManutention()
         *
         * @return {Object} Objet contenant les prix de grutage par site et le prix total
         */
        function calculerPrixGrutage() {
            console.log("=== DÉBUT DU CALCUL DU PRIX DE GRUTAGE ===");

            // Vérifier si nous avons des résultats dans le tableau récapitulatif
            if (!window.cumulativeResults || window.cumulativeResults.length === 0) {
                console.log("Prix grutage: 0 € (aucun site avec grutage activé)");
                return { total: 0, detailParSite: {} };
            }

            // Calculer le prix du grutage pour chaque site
            let prixTotalGrutage = 0;
            const detailParSite = {};

            // Parcourir tous les éléments dans le tableau récapitulatif
            window.cumulativeResults.forEach((result, index) => {
                // Ignorer les éléments qui ne sont pas des options de transport
                if (!result.isTransportOnly) {
                    return;
                }

                // Vérifier si l'option de déchargement (grutage) est activée
                if (result.dechargement !== "oui") {
                    return;
                }

                const site = result.site;

                // Pour le grutage, on utilise le même nombre de demi-journées que pour la manutention si elle est activée
                // Sinon, on considère une demi-journée par défaut
                let nbDemiJournees = 1;
                if (result.manutention === "oui" && result.manutentionDays) {
                    nbDemiJournees = parseInt(result.manutentionDays) || 1;
                }

                // Le prix unitaire du grutage est fixe: 882 €
                const prixUnitaireGrutage = 882;

                // Calculer le prix du grutage pour ce site
                const prixGrutageSite = nbDemiJournees * prixUnitaireGrutage;
                console.log(`Site ${site}: ${nbDemiJournees} demi-journée(s) * ${prixUnitaireGrutage} € = ${prixGrutageSite} €`);

                // Ajouter au prix total
                prixTotalGrutage += prixGrutageSite;

                // Stocker les détails pour ce site
                detailParSite[site] = {
                    nbDemiJournees: nbDemiJournees,
                    prixUnitaire: prixUnitaireGrutage,
                    prixGrutage: prixGrutageSite
                };
            });

            console.log(`Prix total du grutage: ${prixTotalGrutage.toFixed(2)} €`);
            console.log("=== FIN DU CALCUL DU PRIX DE GRUTAGE ===");

            return {
                total: prixTotalGrutage,
                detailParSite: detailParSite
            };
        }

        /**
         * Calcule le prix total en additionnant tous les prix calculés
         * Cette fonction est appelée après tous les autres calculs
         *
         * @return {Object} Objet contenant les détails de tous les prix et le prix total
         */
        function calculerPrixTotal() {
            console.log("=== DÉBUT DU CALCUL DU PRIX TOTAL ===");

            // Calculer ou récupérer tous les prix
            let prixForfaits = 0;
            try {
                const resultForfaits = calculerEtAfficherForfaits();
                prixForfaits = resultForfaits.total || 0;
            } catch (error) {
                console.error("Erreur lors du calcul des forfaits:", error);
            }

            let prixSoudage = 0;
            try {
                prixSoudage = calculerPrixSoudageBarreaux() || 0;
            } catch (error) {
                console.error("Erreur lors du calcul du prix des soudages de barreaux:", error);
            }

            let prixTransportBarreaux = 0;
            try {
                const resultTransport = calculerPrixTransportBarreaux();
                prixTransportBarreaux = resultTransport.total || 0;
            } catch (error) {
                console.error("Erreur lors du calcul du prix du transport des barreaux:", error);
            }

            let prixManutention = 0;
            try {
                const resultManutention = calculerPrixManutention();
                prixManutention = resultManutention.total || 0;
            } catch (error) {
                console.error("Erreur lors du calcul du prix de la manutention:", error);
            }

            let prixGrutage = 0;
            try {
                const resultGrutage = calculerPrixGrutage();
                prixGrutage = resultGrutage.total || 0;
            } catch (error) {
                console.error("Erreur lors du calcul du prix du grutage:", error);
            }

            // Calculer le prix total
            const prixTotal = prixForfaits + prixSoudage + prixTransportBarreaux + prixManutention + prixGrutage;

            console.log("Détail des prix:");
            console.log(`- Forfaits (logistique et suivi): ${prixForfaits.toFixed(2)} €`);
            console.log(`- Soudage des barreaux: ${prixSoudage.toFixed(2)} €`);
            console.log(`- Transport des barreaux: ${prixTransportBarreaux.toFixed(2)} €`);
            console.log(`- Manutention: ${prixManutention.toFixed(2)} €`);
            console.log(`- Grutage: ${prixGrutage.toFixed(2)} €`);
            console.log(`PRIX TOTAL: ${prixTotal.toFixed(2)} €`);
            console.log("=== FIN DU CALCUL DU PRIX TOTAL ===");

            return {
                prixForfaits: prixForfaits,
                prixSoudage: prixSoudage,
                prixTransportBarreaux: prixTransportBarreaux,
                prixManutention: prixManutention,
                prixGrutage: prixGrutage,
                prixTotal: prixTotal
            };
        }


// Fonction pour mettre à jour l'affichage du tableau de résultats
        function updateResultsTable() {
            const resultDiv = document.getElementById('site-result');

            // Si aucun résultat, masquer le tableau
            if (!window.cumulativeResults || window.cumulativeResults.length === 0) {
                resultDiv.style.display = 'none';
                return;
            }

            // Calculer la quantité totale de panneaux
            let totalQuantity = 0;
            for (const result of window.cumulativeResults) {
                // Ne compter que les lignes qui ne sont pas des transports et qui ont une quantité
                if (!result.isTransportOnly && result.quantity) {
                    totalQuantity += parseInt(result.quantity, 10);
                }
            }

            // Calculer le prix total
            let prixTotalDetails = { prixTotal: 0 };
            try {
                prixTotalDetails = calculerPrixTotal();
            } catch (error) {
                console.error("Erreur lors du calcul du prix total:", error);
            }

            // Préparer le HTML des résultats cumulés avec les totaux
            let totalInfoHtml = `
        <div class="total-quantity-display">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>Quantité totale de panneaux:</strong>
                    <span id="total-quantity-value">${totalQuantity}</span>
                </div>
                <div>
                    <strong>Prix total:</strong>
                    <span id="total-price-value" style="font-size: 20px; color: #e01b24;">${formatNumber(prixTotalDetails.prixTotal)} €</span>
                </div>
            </div>
        </div>
    `;

            // Préparation du tableau récapitulatif
            let finalResultsHtml = `
        <div class="result-title">Récapitulatif total</div>
        ${totalInfoHtml}
        <table class="result-table">
            <tr>
                <th>Site</th>
                <th>Repère de panneaux</th>
                <th>Quantité</th>
                <th>Transport Barreaux</th>
                <th>Manutention</th>
                <th>Grue</th>
                <th>Action</th>
            </tr>
    `;

            // Afficher tous les items du tableau cumulatif
            for (const result of window.cumulativeResults) {
                // Pour les entrées qui sont uniquement de transport
                if (result.isTransportOnly) {
                    // Préparation de l'affichage de la manutention
                    let manutentionDisplay = result.manutention || 'non';
                    if (result.manutention === 'oui' && result.manutentionDays) {
                        manutentionDisplay = `${result.manutention} (${result.manutentionDays} demi-journée${result.manutentionDays > 1 ? 's' : ''})`;
                    }

                    finalResultsHtml += `
                <tr id="row-${result.id}" style="background-color: #f0f8ff;">
                    <td>${escapeHtml(result.site)}</td>
                    <td colspan="2" style="text-align: center; font-style: italic;">Options</td>
                    <td>${result.transportBarreaux}</td>
                    <td>${result.dechargement || 'non'}</td>
                    <td>${manutentionDisplay}</td>
                    <td>
                        <button class="delete-row-btn" data-id="${result.id}"
                                style="background-color: #f44336; color: white; border: none;
                                       padding: 5px 10px; border-radius: 3px; cursor: pointer;">
                            Supprimer
                        </button>
                    </td>
                </tr>
            `;
                } else {
                    // Pour les entrées normales (produits)
                    finalResultsHtml += `
                <tr id="row-${result.id}">
                    <td>${escapeHtml(result.site)}</td>
                    <td>${escapeHtml(result.description || '')}</td>
                    <td>${result.quantity || ''}</td>
                    <td>${result.transportPanneaux || ''}</td>
                    <td>${result.transportBarreaux || ''}</td>
                    <td>${result.dechargement || ''}</td>
                    <td>${result.manutention || ''}</td>
                    <td>
                        <button class="delete-row-btn" data-id="${result.id}"
                                style="background-color: #f44336; color: white; border: none;
                                       padding: 5px 10px; border-radius: 3px; cursor: pointer;">
                            Supprimer
                        </button>
                    </td>
                </tr>
            `;
                }
            }

            finalResultsHtml += `
        </table>
        <button id="reset-results" class="reset-button">Tout réinitialiser</button>
    `;

            // Afficher les résultats finaux
            resultDiv.innerHTML = finalResultsHtml;
            resultDiv.style.display = 'block';

            // Ajouter événements pour les boutons
            setupResultButtonEvents();

            // Calculer le prix total (tous les calculs sont gérés dans cette fonction)
            try {
                calculerPrixTotal();
            } catch (error) {
                console.error("Erreur lors du calcul du prix total:", error);
            }
        }

// Fonction pour configurer les événements des boutons de résultat
        function setupResultButtonEvents() {
            // Réinitialisation
            document.getElementById('reset-results').addEventListener('click', function() {
                window.cumulativeResults = [];
                updateResultsTable();
            });

            // Boutons de suppression
            document.querySelectorAll('.delete-row-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const idToRemove = this.getAttribute('data-id');
                    window.cumulativeResults = window.cumulativeResults.filter(item => item.id !== idToRemove);
                    updateResultsTable();
                });
            });
        }

        // Fonction pour configurer les gestionnaires d'événements
        function setupEventHandlers() {
            // Gestionnaire pour le bouton de recherche par site
            document.getElementById('search-site-button').addEventListener('click', function() {
                searchBySite();
                // Masquer le formulaire de quantité
                document.getElementById('quantity-filter').style.display = 'none';

                // Réinitialiser les boutons radio à leur valeur par défaut
                document.getElementById('transport-barreaux-non').checked = true;
                document.getElementById('dechargement-non').checked = true;
                transportPanneaux = "non";
                transportBarreaux = "non";
                dechargement = "non";
            });

            // Gestionnaires d'événements pour les boutons radio de transport barreaux
            document.querySelectorAll('input[name="transport-barreaux"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    transportBarreaux = this.value;
                    console.log("Transport barreaux:", transportBarreaux);

                    // Afficher ou masquer l'option de manutention
                    const manutentionContainer = document.getElementById('manutention-container');

                    if (transportBarreaux === "oui") {
                        manutentionContainer.style.display = "block";  // Afficher l'option de manutention
                    } else {
                        manutentionContainer.style.display = "none";   // Masquer l'option de manutention

                        // Réinitialiser l'option de manutention à "non"
                        document.getElementById('manutention-non').checked = true;
                        manutention = "non";

                    }
                });
            });

            // Gestionnaires d'événements pour les boutons radio de déchargement
            document.querySelectorAll('input[name="dechargement"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    dechargement = this.value;
                    console.log("Déchargement:", dechargement);
                });
            });

            // Gestionnaires d'événements pour les boutons radio de manutention
            document.querySelectorAll('input[name="manutention"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    manutention = this.value;
                    console.log("Manutention:", manutention);

                    // Afficher ou masquer le champ de nombre de demi-journées
                    const manutentionDaysContainer = document.getElementById('manutention-days-container');
                    const dechargementContainer = document.getElementById('dechargement-container');

                    if (manutention === "oui") {
                        manutentionDaysContainer.style.display = "block";
                        dechargementContainer.style.display = "block";  // Afficher l'option de grue
                    } else {
                        manutentionDaysContainer.style.display = "none";
                        dechargementContainer.style.display = "none";   // Masquer l'option de grue

                        // Réinitialiser l'option de déchargement à "non"
                        document.getElementById('dechargement-non').checked = true;
                        dechargement = "non";
                    }
                });
            });

            document.getElementById('manutention-days').addEventListener('change', function() {
                manutentionDays = parseInt(this.value) || 1;
                if (manutentionDays < 1) {
                    this.value = 1;
                    manutentionDays = 1;
                }
                console.log("Nombre de demi-journées de manutention:", manutentionDays);

                // Si le tableau récapitulatif est déjà affiché, le mettre à jour
                if (window.cumulativeResults && window.cumulativeResults.length > 0) {
                    updateResultsTable();
                }
            });

            // Dans setupEventHandlers()
            document.getElementById('validate-transport-button').addEventListener('click', function() {
                validateTransportOptions();
            });


// Gestionnaire pour la touche Entrée dans le sélecteur de site
            document.getElementById('site-select').addEventListener('change', function() {
                searchBySite();
                // Réinitialiser le sélecteur de repère
                document.getElementById('repere-select').value = '';
                // Masquer le formulaire de quantité
                document.getElementById('quantity-filter').style.display = 'none';
                document.getElementById('dechargement-container').style.display = 'none';

                document.getElementById('transport-barreaux-non').checked = true;
                document.getElementById('dechargement-non').checked = true;
                transportPanneaux = "non";
                transportBarreaux = "non";
                dechargement = "non";
            });


            // Gestionnaire pour le bouton de filtrage par repère
            document.getElementById('search-repere-button').addEventListener('click', function() {
                filterByRepere();
            });

            // Gestionnaire pour le changement de sélection de repère
            document.getElementById('repere-select').addEventListener('change', function() {
                filterByRepere();
            });

            // Gestionnaire pour le bouton de calcul
            document.getElementById('calculate-button').addEventListener('click', function() {
                calculateWithQuantity();
            });

            // Gestionnaire pour la touche Entrée dans le champ de quantité
            document.getElementById('quantity-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    calculateWithQuantity();
                }
            });

            // Gestionnaire pour le changement de valeur dans le champ de quantité
            document.getElementById('quantity-input').addEventListener('input', function() {
            });

            // Gestionnaire pour les titres de fichiers
            document.querySelectorAll('.file-title').forEach(fileTitle => {
                fileTitle.addEventListener('click', function() {
                    const contentId = this.getAttribute('data-target');
                    const contentElement = document.getElementById(contentId);
                    const iconElement = this.querySelector('.toggle-icon');

                    if (contentElement.style.display === 'block') {
                        contentElement.style.display = 'none';
                        iconElement.classList.add('collapsed');
                    } else {
                        contentElement.style.display = 'block';
                        iconElement.classList.remove('collapsed');
                    }
                });
            });

            // Gestionnaire pour les titres de feuilles
            document.querySelectorAll('.sheet-title').forEach(sheetTitle => {
                sheetTitle.addEventListener('click', function() {
                    const contentId = this.getAttribute('data-target');
                    const contentElement = document.getElementById(contentId);
                    const iconElement = this.querySelector('.toggle-icon');

                    if (contentElement.style.display === 'block') {
                        contentElement.style.display = 'none';
                        iconElement.classList.add('collapsed');
                    } else {
                        contentElement.style.display = 'block';
                        iconElement.classList.remove('collapsed');
                    }
                });
            });

            // Gestionnaire pour le bouton "Afficher/Masquer tous"
            document.getElementById('toggle-all-btn').addEventListener('click', function() {
                const fileContents = document.querySelectorAll('.file-content');
                const sheetContents = document.querySelectorAll('.sheet-content');
                const fileIcons = document.querySelectorAll('.file-title .toggle-icon');
                const sheetIcons = document.querySelectorAll('.sheet-title .toggle-icon');

                if (allTablesVisible) {
                    // Masquer tous les tableaux
                    fileContents.forEach(content => {
                        content.style.display = 'none';
                    });
                    sheetContents.forEach(content => {
                        content.style.display = 'none';
                    });
                    fileIcons.forEach(icon => {
                        icon.classList.add('collapsed');
                    });
                    sheetIcons.forEach(icon => {
                        icon.classList.add('collapsed');
                    });
                    this.textContent = 'Afficher tous les tableaux';
                } else {
                    // Afficher tous les tableaux
                    fileContents.forEach(content => {
                        content.style.display = 'block';
                    });
                    sheetContents.forEach(content => {
                        content.style.display = 'block';
                    });
                    fileIcons.forEach(icon => {
                        icon.classList.remove('collapsed');
                    });
                    sheetIcons.forEach(icon => {
                        icon.classList.remove('collapsed');
                    });
                    this.textContent = 'Masquer tous les tableaux';
                }

                allTablesVisible = !allTablesVisible;
            });
        }

        // Récupérer les données Excel via AJAX
        fetch('get_excel_data.php')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erreur réseau: ' + response.status);
                }
                return response.json();
            })
            .then(response => {
                document.getElementById('loading').style.display = 'none';

                // Stocker les données pour la recherche
                filesDataGlobal = response;

                // Extraire les sites et leurs items associés
                const siteData = extractSiteData(response);
                allSites = siteData.sites;
                allItemsBySite = siteData.itemsBySite;

                // Remplir le sélecteur de sites
                populateSiteSelect(allSites);

                // Rendre les données Excel (nous les gardons pour la fonctionnalité)
                document.getElementById('excel-data').innerHTML = renderExcelFiles(response);

                // Configuration des gestionnaires d'événements après le rendu
                setupEventHandlers();

                // Masquer les données Excel
                hideExcelData();
            })
            .catch(error => {
                document.getElementById('loading').style.display = 'none';

                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Erreur: ' + error.message;

                document.getElementById('excel-data').appendChild(errorDiv);
            });
    });
</script>
</body>
</html>