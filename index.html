<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affichage des fichiers Excel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        h1 {
            color: #333;
        }
        h2 {
            color: #555;
            margin-top: 30px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .sheet-title {
            margin-top: 40px;
            color: #333;
            border-bottom: 2px solid #333;
            padding-bottom: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sheet-title .toggle-icon {
            font-size: 18px;
            transition: transform 0.3s;
        }
        .sheet-title .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }
        #loading {
            text-align: center;
            margin: 20px;
            font-style: italic;
        }
        .error {
            color: red;
            font-weight: bold;
            display: none;
        }
        .total-cell {
            background-color: #e6f2ff;
            font-weight: bold;
            text-align: right;
        }
        .sheet-container {
            margin-bottom: 40px;
        }
        .sheet-content {
            display: none;
            transition: height 0.3s ease;
        }
        .file-container {
            margin-bottom: 60px;
            padding-bottom: 20px;
            border-bottom: 3px dashed #ccc;
        }
        .file-title {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
            border-left: 5px solid #4CAF50;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .file-content {
            display: none;
            transition: height 0.3s ease;
        }
        /* Styles pour la recherche de produit */
        .search-container {
            margin: 20px 0;
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .search-input {
            padding: 8px;
            width: 250px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .search-button {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #product-result {
            margin-top: 15px;
            display: none;
        }
        #product-result table {
            width: auto;
            min-width: 300px;
        }
        .no-result {
            color: #d9534f;
            font-style: italic;
        }
        .toggle-all-btn {
            margin: 10px 0;
            padding: 8px 15px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .toggle-all-btn:hover {
            background-color: #0b7dda;
        }
    </style>
</head>
<body>
<h1>Affichage des fichiers Excel</h1>

<!-- Conteneur pour la recherche de produit -->
<div class="search-container">
    <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
        <div>
            <label for="product-search">Nom du produit:</label>
            <input type="text" id="product-search" class="search-input" placeholder="Nom du produit...">
        </div>

        <div>
            <label for="weight-search">Poids:</label>
            <input type="number" id="weight-search" class="search-input" placeholder="Poids...">
        </div>

        <button id="search-button" class="search-button">Rechercher</button>
    </div>

    <div id="product-result"></div>
</div>

<div class="toggle-controls">
    <button id="toggle-all-btn" class="toggle-all-btn">Afficher tous les tableaux</button>
</div>

<div id="loading">Chargement des données Excel...</div>
<div id="excel-data"></div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Variables pour stocker les données
        let allProductTotals = {};
        let filesDataGlobal = {};
        let allTablesVisible = false;

        // Fonction pour échapper le HTML
        function escapeHtml(unsafe) {
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Fonction pour formater les nombres
        function formatNumber(number) {
            return new Intl.NumberFormat('fr-FR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(number);
        }

        // Fonction pour créer les tableaux HTML pour chaque feuille
        function renderSheetData(data, productTotals, filePath) {
            let html = '';
            const isWeightFile = filePath.includes('ref');

            for (const sheetName in data) {
                const sheetData = data[sheetName];
                const sheetProductTotals = productTotals[sheetName] || { products: {}, rows: {} };
                const sheetId = `sheet-${filePath.replace(/\./g, '-')}-${sheetName.replace(/\s+/g, '-')}`;
                const contentId = `content-${sheetId}`;

                html += `<div class="sheet-container">`;
                html += `<h2 class="sheet-title" data-target="${contentId}">
                            Feuille: ${escapeHtml(sheetName)}
                            <span class="toggle-icon collapsed">▼</span>
                        </h2>`;

                html += `<div id="${contentId}" class="sheet-content">`;
                if (sheetData && sheetData.length > 0) {
                    html += '<table>';

                    // En-têtes
                    html += '<tr>';
                    for (const headerCell of sheetData[0]) {
                        html += `<th>${escapeHtml(headerCell || '')}</th>`;
                    }

                    // Ajouter une colonne pour le total uniquement pour le premier fichier (BPU_vrai.xlsx)
                    if (!isWeightFile) {
                        html += `<th>Total</th>`;
                    }
                    html += '</tr>';

                    // Données
                    for (let i = 1; i < sheetData.length; i++) {
                        html += '<tr>';
                        for (const cell of sheetData[i]) {
                            html += `<td>${escapeHtml(cell || '')}</td>`;
                        }

                        // Afficher le total uniquement pour le premier fichier
                        if (!isWeightFile) {
                            const rowValue = sheetProductTotals.rows[i] || 0;
                            html += `<td class="total-cell">${formatNumber(rowValue)} €</td>`;
                        }

                        html += '</tr>';
                    }

                    html += '</table>';
                } else {
                    html += '<p>Aucune donnée dans cette feuille</p>';
                }
                html += `</div>`; // Fin de sheet-content
                html += `</div>`; // Fin de sheet-container
            }

            return html;
        }

        // Fonction pour créer l'affichage complet des fichiers
        function renderExcelFiles(filesData) {
            let html = '';

            // Parcourir chaque fichier
            for (const fileKey in filesData) {
                const fileData = filesData[fileKey];
                const fileId = `file-${fileKey}`;
                const contentId = `content-${fileId}`;

                if (fileData.error) {
                    html += `<div class="file-container">`;
                    html += `<div class="file-title" data-target="${contentId}">
                                Fichier: ${escapeHtml(fileData.filePath || fileKey)}
                                <span class="toggle-icon collapsed">▼</span>
                            </div>`;
                    html += `<div id="${contentId}" class="file-content">`;
                    html += `<div class="error" style="display:block;">${escapeHtml(fileData.error)}</div>`;
                    html += `</div>`;
                    html += `</div>`;
                    continue;
                }

                html += `<div class="file-container">`;
                html += `<div class="file-title" data-target="${contentId}">
                            Fichier: ${escapeHtml(fileData.filePath)}
                            <span class="toggle-icon collapsed">▼</span>
                        </div>`;

                html += `<div id="${contentId}" class="file-content">`;
                // Ajouter les données de chaque feuille du fichier
                html += renderSheetData(fileData.data, fileData.productTotals, fileData.filePath);
                html += `</div>`;

                html += `</div>`;

                // Stocker les totaux des produits pour la recherche
                for (const sheetName in fileData.productTotals) {
                    const fileSheetKey = `${fileKey}_${sheetName}`;
                    allProductTotals[fileSheetKey] = fileData.productTotals[sheetName];
                }
            }

            return html;
        }

        // Fonction de recherche unifiée pour produit et poids
        function searchProducts() {
            const resultDiv = document.getElementById('product-result');
            resultDiv.style.display = 'block';

            const productName = document.getElementById('product-search').value.trim().toLowerCase();
            const weightInput = document.getElementById('weight-search').value.trim();

            // Vérifier qu'au moins un critère est fourni
            if (productName === '' && weightInput === '') {
                resultDiv.innerHTML = `<p class="no-result">Veuillez entrer au moins un critère de recherche</p>`;
                return;
            }

            // Convertir le poids en nombre si fourni
            const searchWeight = weightInput ? parseFloat(weightInput) : null;
            if (weightInput !== '' && isNaN(searchWeight)) {
                resultDiv.innerHTML = `<p class="no-result">Veuillez entrer un poids valide</p>`;
                return;
            }

            // Tableaux pour stocker les résultats
            let productsFoundByName = [];
            let productsFoundByWeight = [];
            let finalResults = [];

            // 1. Recherche par nom de produit dans BPU_vrai.xlsx
            if (productName !== '') {
                for (const sheetKey in allProductTotals) {
                    if (sheetKey.startsWith('file1_')) {
                        const sheetProducts = allProductTotals[sheetKey].products || {};

                        for (const [produit, total] of Object.entries(sheetProducts)) {
                            if (produit.toLowerCase() === productName) {
                                productsFoundByName.push({
                                    name: produit,
                                    price: total,
                                    weight: null // On ne connaît pas encore le poids
                                });
                            }
                        }
                    }
                }
            }

            // 2. Recherche par poids dans ref.xlsx
            if (searchWeight !== null) {
                const weightFileData = filesDataGlobal.file2?.data || {};

                for (const sheetName in weightFileData) {
                    const sheetData = weightFileData[sheetName];

                    if (sheetData && sheetData.length > 1) {
                        // Trouver les colonnes du produit et du poids
                        const headers = sheetData[0];
                        let produitCol = -1;
                        let poidsCol = -1;

                        headers.forEach((header, index) => {
                            const headerLower = String(header).toLowerCase();
                            if (headerLower.includes('produit') || headerLower.includes('product')) {
                                produitCol = index;
                            }
                            if (headerLower.includes('poid') || headerLower.includes('weight')) {
                                poidsCol = index;
                            }
                        });

                        // Si on ne trouve pas les colonnes et qu'il y a au moins 2 colonnes, utiliser les deux premières
                        if (produitCol === -1 && poidsCol === -1 && headers.length >= 2) {
                            produitCol = 0;
                            poidsCol = 1;
                        }

                        // Parcourir les lignes pour trouver les produits avec le poids recherché
                        for (let i = 1; i < sheetData.length; i++) {
                            const row = sheetData[i];
                            if (row.length > Math.max(produitCol, poidsCol)) {
                                const produit = row[produitCol];
                                const poids = parseFloat(row[poidsCol]);

                                if (!isNaN(poids) && Math.abs(poids - searchWeight) < 0.0001) {
                                    productsFoundByWeight.push({
                                        name: produit,
                                        price: null, // On ne connaît pas encore le prix
                                        weight: poids
                                    });
                                }
                            }
                        }
                    }
                }
            }

            // 3. Combiner les résultats selon les critères fournis
            if (productName !== '' && searchWeight !== null) {
                // Les deux critères sont fournis, on cherche les correspondances exactes
                for (const prodByName of productsFoundByName) {
                    for (const prodByWeight of productsFoundByWeight) {
                        if (prodByName.name.toLowerCase() === prodByWeight.name.toLowerCase()) {
                            finalResults.push({
                                name: prodByName.name,
                                price: prodByName.price,
                                weight: prodByWeight.weight
                            });
                        }
                    }
                }
            } else if (productName !== '') {
                // Seulement recherche par nom
                // Pour chaque produit trouvé par nom, chercher son poids dans ref.xlsx
                for (const prod of productsFoundByName) {
                    const weightFileData = filesDataGlobal.file2?.data || {};

                    let foundWeight = false;
                    for (const sheetName in weightFileData) {
                        const sheetData = weightFileData[sheetName];

                        if (sheetData && sheetData.length > 1) {
                            const headers = sheetData[0];
                            let produitCol = -1;
                            let poidsCol = -1;

                            headers.forEach((header, index) => {
                                const headerLower = String(header).toLowerCase();
                                if (headerLower.includes('produit') || headerLower.includes('product')) {
                                    produitCol = index;
                                }
                                if (headerLower.includes('poid') || headerLower.includes('weight')) {
                                    poidsCol = index;
                                }
                            });

                            if (produitCol === -1 && poidsCol === -1 && headers.length >= 2) {
                                produitCol = 0;
                                poidsCol = 1;
                            }

                            for (let i = 1; i < sheetData.length; i++) {
                                const row = sheetData[i];
                                if (row.length > Math.max(produitCol, poidsCol)) {
                                    const produit = row[produitCol];
                                    const poids = parseFloat(row[poidsCol]);

                                    if (produit.toLowerCase() === prod.name.toLowerCase()) {
                                        prod.weight = poids;
                                        foundWeight = true;
                                        break;
                                    }
                                }
                            }
                        }

                        if (foundWeight) break;
                    }

                    finalResults.push(prod);
                }
            } else if (searchWeight !== null) {
                // Seulement recherche par poids
                // Pour chaque produit trouvé par poids, chercher son prix dans BPU_vrai
                for (const prod of productsFoundByWeight) {
                    for (const sheetKey in allProductTotals) {
                        if (sheetKey.startsWith('file1_')) {
                            const sheetProducts = allProductTotals[sheetKey].products || {};

                            if (prod.name.toLowerCase() in sheetProducts ||
                                Object.keys(sheetProducts).some(p => p.toLowerCase() === prod.name.toLowerCase())) {

                                // Trouver la clé exacte (insensible à la casse)
                                const matchedProduct = Object.keys(sheetProducts).find(
                                    p => p.toLowerCase() === prod.name.toLowerCase()
                                );

                                if (matchedProduct) {
                                    prod.price = sheetProducts[matchedProduct];
                                }
                            }
                        }
                    }

                    finalResults.push(prod);
                }
            }

            // 4. Afficher les résultats
            if (finalResults.length > 0) {
                resultsHtml = `
                    <table>
                        <tr>
                            <th>Produit</th>
                            <th>Poids</th>
                            <th>Prix total</th>
                        </tr>
                `;

                for (const result of finalResults) {
                    const productName = escapeHtml(result.name);
                    const weightDisplay = result.weight !== null ? formatNumber(result.weight) + " kg" : "Non disponible";
                    const priceDisplay = result.price !== null ? formatNumber(result.price) + " €" : "Non disponible";

                    resultsHtml += `
                        <tr>
                            <td>${productName}</td>
                            <td>${weightDisplay}</td>
                            <td class="total-cell">${priceDisplay}</td>
                        </tr>
                    `;
                }

                resultsHtml += `</table>`;
                resultDiv.innerHTML = resultsHtml;
            } else {
                let message = "Aucun produit ne correspond aux critères";
                if (productName !== '') {
                    message += ` pour le nom "${escapeHtml(productName)}"`;
                }
                if (searchWeight !== null) {
                    message += productName !== '' ? " et" : " pour";
                    message += ` le poids de ${formatNumber(searchWeight)} kg`;
                }

                resultDiv.innerHTML = `<p class="no-result">${message}</p>`;
            }
        }

        // Gérer le clic sur le bouton de recherche
        document.getElementById('search-button').addEventListener('click', function() {
            searchProducts();
        });

        // Gérer la touche Entrée dans les champs de recherche
        document.getElementById('product-search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchProducts();
            }
        });

        document.getElementById('weight-search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchProducts();
            }
        });

        // Gestion des boutons d'affichage/masquage
        function setupToggleHandlers() {
            // Gestionnaire pour les titres de fichiers
            document.querySelectorAll('.file-title').forEach(fileTitle => {
                fileTitle.addEventListener('click', function() {
                    const contentId = this.getAttribute('data-target');
                    const contentElement = document.getElementById(contentId);
                    const iconElement = this.querySelector('.toggle-icon');

                    if (contentElement.style.display === 'block') {
                        contentElement.style.display = 'none';
                        iconElement.classList.add('collapsed');
                    } else {
                        contentElement.style.display = 'block';
                        iconElement.classList.remove('collapsed');
                    }
                });
            });

            // Gestionnaire pour les titres de feuilles
            document.querySelectorAll('.sheet-title').forEach(sheetTitle => {
                sheetTitle.addEventListener('click', function() {
                    const contentId = this.getAttribute('data-target');
                    const contentElement = document.getElementById(contentId);
                    const iconElement = this.querySelector('.toggle-icon');

                    if (contentElement.style.display === 'block') {
                        contentElement.style.display = 'none';
                        iconElement.classList.add('collapsed');
                    } else {
                        contentElement.style.display = 'block';
                        iconElement.classList.remove('collapsed');
                    }
                });
            });

            // Gestionnaire pour le bouton "Afficher/Masquer tous"
            document.getElementById('toggle-all-btn').addEventListener('click', function() {
                const fileContents = document.querySelectorAll('.file-content');
                const sheetContents = document.querySelectorAll('.sheet-content');
                const fileIcons = document.querySelectorAll('.file-title .toggle-icon');
                const sheetIcons = document.querySelectorAll('.sheet-title .toggle-icon');

                if (allTablesVisible) {
                    // Masquer tous les tableaux
                    fileContents.forEach(content => {
                        content.style.display = 'none';
                    });
                    sheetContents.forEach(content => {
                        content.style.display = 'none';
                    });
                    fileIcons.forEach(icon => {
                        icon.classList.add('collapsed');
                    });
                    sheetIcons.forEach(icon => {
                        icon.classList.add('collapsed');
                    });
                    this.textContent = 'Afficher tous les tableaux';
                } else {
                    // Afficher tous les tableaux
                    fileContents.forEach(content => {
                        content.style.display = 'block';
                    });
                    sheetContents.forEach(content => {
                        content.style.display = 'block';
                    });
                    fileIcons.forEach(icon => {
                        icon.classList.remove('collapsed');
                    });
                    sheetIcons.forEach(icon => {
                        icon.classList.remove('collapsed');
                    });
                    this.textContent = 'Masquer tous les tableaux';
                }

                allTablesVisible = !allTablesVisible;
            });
        }

        // Récupérer les données Excel via AJAX
        fetch('get_excel_data.php')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erreur réseau: ' + response.status);
                }
                return response.json();
            })
            .then(response => {
                document.getElementById('loading').style.display = 'none';

                // Stocker les données pour la recherche
                filesDataGlobal = response;

                // Stocker les totaux pour la recherche
                for (const fileKey in response) {
                    const fileData = response[fileKey];
                    if (!fileData.error && fileData.productTotals) {
                        for (const sheetName in fileData.productTotals) {
                            const fileSheetKey = `${fileKey}_${sheetName}`;
                            allProductTotals[fileSheetKey] = fileData.productTotals[sheetName];
                        }
                    }
                }

                document.getElementById('excel-data').innerHTML = renderExcelFiles(response);

                // Configuration des gestionnaires d'événements après le rendu
                setupToggleHandlers();
            })
            .catch(error => {
                document.getElementById('loading').style.display = 'none';

                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Erreur: ' + error.message;

                document.getElementById('excel-data').appendChild(errorDiv);
            });
    });
</script>
</body>
</html>