<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panneaux de grille</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        h1 {
            color: #333;
        }
        h2 {
            color: #555;
            margin-top: 30px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .sheet-title {
            margin-top: 40px;
            color: #333;
            border-bottom: 2px solid #333;
            padding-bottom: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sheet-title .toggle-icon {
            font-size: 18px;
            transition: transform 0.3s;
        }
        .sheet-title .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }
        #loading {
            text-align: center;
            margin: 20px;
            font-style: italic;
        }
        .error {
            color: red;
            font-weight: bold;
            display: none;
        }
        .total-cell {
            background-color: #e6f2ff;
            font-weight: bold;
            text-align: right;
        }
        .sheet-container {
            margin-bottom: 40px;
        }
        .sheet-content {
            display: none;
            transition: height 0.3s ease;
        }
        .file-container {
            margin-bottom: 60px;
            padding-bottom: 20px;
            border-bottom: 3px dashed #ccc;
        }
        .file-title {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: bold;
            border-left: 5px solid #4CAF50;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .file-content {
            display: none;
            transition: height 0.3s ease;
        }
        /* Styles pour la recherche de site */
        .search-container {
            margin: 20px 0;
            padding: 20px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .search-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .search-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        #quantity-filter {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }

        .search-input {
            padding: 8px;
            width: 100px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .search-select {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            flex-grow: 1;
            max-width: 400px;
        }
        .search-button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .search-button:hover {
            background-color: #45a049;
        }
        #site-result {
            margin-top: 20px;
            display: none;
        }
        .result-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #45a049;
            padding-bottom: 5px;
        }
        .result-table {
            width: 100%;
            border-collapse: collapse;
        }
        .result-table th {
            background-color: #4CAF50;
            color: white;
            padding: 12px;
            text-align: left;
        }
        .result-table tr:hover {
            background-color: #f1f1f1;
        }
        .result-table td {
            padding: 10px;
        }
        .price-cell {
            text-align: right;
            font-weight: bold;
            color: #2c7fb8;
        }
        .toggle-all-btn {
            margin: 10px 0;
            padding: 8px 15px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .toggle-all-btn:hover {
            background-color: #0b7dda;
        }
        .no-result {
            padding: 20px;
            text-align: center;
            color: #d9534f;
            font-style: italic;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
        }

        /* Styles pour la popup d'authentification */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* S'assurer que la popup est au-dessus de tout */
        }

        .auth-container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            width: 300px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .auth-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            color: #333;
        }

        .auth-form-group {
            margin-bottom: 15px;
        }

        .auth-form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .auth-form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .auth-button {
            width: 100%;
            padding: 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .auth-button:hover {
            background-color: #45a049;
        }

        .auth-error {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 15px;
            text-align: center;
            display: none;
        }

        #site-result {
            margin-top: 30px;
            padding: 15px;
            border: 1px solid #4CAF50;
            border-radius: 5px;
            background-color: #f7fff7;
        }

        .reset-button {
            margin-top: 15px;
            padding: 10px 20px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .reset-button:hover {
            background-color: #d32f2f;
        }

        .transport-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 20px;
            margin-bottom: 10px; /* Ajoute un peu d'espace vertical entre les options */
        }

        .transport-option label {
            margin-right: 5px;
            white-space: nowrap; /* Empêche le texte de passer à la ligne */
        }

        .radio-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .radio-group input[type="radio"] {
            margin-left: 10px;
            margin-right: 3px; /* Espace entre le bouton radio et son label */
        }

        /* S'assurer que tous les labels sont bien alignés */
        .radio-group label {
            margin-right: 10px;
        }

        .total-quantity-display {
            background-color: #e6f2ff;
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
            font-size: 16px;
        }

        #total-quantity-value {
            font-weight: bold;
            color: #2c7fb8;
            font-size: 18px;
        }

        .site-header {
            width: 100%;
            background-color: white;
            padding: 10px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            text-align: center;
        }

        .site-header img {
            max-width: 100%;
            height: auto;
            max-height: 80px;
        }

        /* Styles pour le header avec les deux logos */
        .site-header {
            width: 100%;
            background-color: white;
            padding: 10px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            text-align: center;
        }

        .logo-moscatelli {
            min-height: 100px;
            min-width: 150px;
        }

        .logo-cnr {
            min-height: 300px;
            min-width: 150px;
            object-fit: contain;
        }

        /* Styles spécifiques pour le conteneur des logos */
        .logos-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 50px; /* Espace entre les deux logos */
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px 0;
        }

        .export-button {
            padding: 10px 20px;
            background-color: #0096FF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .export-button:hover {
            background-color: #89CFF0;
        }

        .export-button:disabled {
            background-color: #87CEEB;
            cursor: not-allowed;
        }

    </style>
</head>
<body>
<!-- Ajoutez ce bloc header avant la popup d'authentification -->
<header class="site-header">
    <div class="logos-container">
        <img src="entreprises_moscatelli_cover.jpg" alt="Moscatelli - Chaudronnerie Tuyauterie Mécanique Maintenance Ventilation" class="logo-moscatelli">
        <img src="cnr_logo_encapsule-_q.png" alt="CNR" class="logo-cnr">
    </div>
</header>
<!-- Popup d'authentification -->
<div id="authModal" class="auth-modal">
    <div class="auth-container">
        <div class="auth-title">Authentification requise</div>
        <form id="authForm">
            <div class="auth-form-group">
                <label for="username">Identifiant</label>
                <input type="text" id="username" required>
            </div>
            <div class="auth-form-group">
                <label for="password">Mot de passe</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit" class="auth-button">Valider</button>
            <div id="authError" class="auth-error">Identifiant ou mot de passe incorrect</div>
        </form>
    </div>
</div>

<h1>Formulaire de sélection</h1>

<!-- Conteneur pour la recherche par site -->
<div class="search-container">
    <div class="search-title">Recherche par site</div>
    <div class="search-form">
        <select id="site-select" class="search-select">
            <option value="">Sélectionnez un site...</option>
            <!-- Les options seront ajoutées dynamiquement en JavaScript -->
        </select>
        <button id="search-site-button" class="search-button">Rechercher</button>
    </div>

    <!-- Options de transport barreaux (initialement masquées) -->
    <div id="transport-options" class="search-form" style="display: none;">
        <!-- Transport barreaux -->
        <div class="transport-option">
            <label>Transport barreaux:</label>
            <div class="radio-group">
                <input type="radio" id="transport-barreaux-oui" name="transport-barreaux" value="oui">
                <label for="transport-barreaux-oui">Oui</label>
                <input type="radio" id="transport-barreaux-non" name="transport-barreaux" value="non" checked>
                <label for="transport-barreaux-non">Non</label>
            </div>
        </div>

        <!-- Manutention (masquée par défaut) -->
        <div id="manutention-container" class="transport-option" style="display: none; margin-left: 20px;">
            <label>Manutention:</label>
            <div class="radio-group">
                <input type="radio" id="manutention-oui" name="manutention" value="oui">
                <label for="manutention-oui">Oui</label>
                <input type="radio" id="manutention-non" name="manutention" value="non" checked>
                <label for="manutention-non">Non</label>
            </div>
        </div>

        <!-- Nombre de demi-journées (masqué par défaut) -->
        <div id="manutention-days-container" style="display: none; margin-top: 10px; margin-left: 40px;">
            <label for="manutention-days">½ journées de manutention:</label>
            <input type="number" id="manutention-days" class="search-input" min="1" value="1" style="width: 60px;">
        </div>

        <!-- Déchargement/Grue (masqué par défaut) -->
        <div id="dechargement-container" class="transport-option" style="display: none; margin-left: 20px;">
            <label>Grue à prévoir sur le site:</label>
            <div class="radio-group">
                <input type="radio" id="dechargement-oui" name="dechargement" value="oui">
                <label for="dechargement-oui">Oui</label>
                <input type="radio" id="dechargement-non" name="dechargement" value="non" checked>
                <label for="dechargement-non">Non</label>
            </div>
        </div>
    </div>

    <!-- Options de transport panneaux (initialement masquées) -->
    <div id="transport-panneaux-options" class="search-form" style="display: none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
        <!-- Transport panneaux -->
        <div class="transport-option">
            <label>Transport panneaux:</label>
            <div class="radio-group">
                <input type="radio" id="transport-panneaux-oui" name="transport-panneaux" value="oui">
                <label for="transport-panneaux-oui">Oui</label>
                <input type="radio" id="transport-panneaux-non" name="transport-panneaux" value="non" checked>
                <label for="transport-panneaux-non">Non</label>
            </div>
        </div>

        <!-- Manutention panneaux (masquée par défaut) -->
        <div id="manutention-panneaux-container" class="transport-option" style="display: none; margin-left: 20px;">
            <label>Manutention panneaux:</label>
            <div class="radio-group">
                <input type="radio" id="manutention-panneaux-oui" name="manutention-panneaux" value="oui">
                <label for="manutention-panneaux-oui">Oui</label>
                <input type="radio" id="manutention-panneaux-non" name="manutention-panneaux" value="non" checked>
                <label for="manutention-panneaux-non">Non</label>
            </div>
        </div>

        <!-- Grutage panneaux (masqué par défaut) -->
        <div id="grutage-panneaux-container" class="transport-option" style="display: none; margin-left: 20px;">
            <label>Grue à prévoir sur le site:</label>
            <div class="radio-group">
                <input type="radio" id="grutage-panneaux-oui" name="grutage-panneaux" value="oui">
                <label for="grutage-panneaux-oui">Oui</label>
                <input type="radio" id="grutage-panneaux-non" name="grutage-panneaux" value="non" checked>
                <label for="grutage-panneaux-non">Non</label>
            </div>
        </div>
    </div>

    <!-- Options d'emballage (initialement masquées) -->
    <div id="emballage-options" class="search-form" style="display: none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
        <!-- Emballage -->
        <div class="transport-option">
            <label>Emballage panneaux:</label>
            <div class="radio-group">
                <input type="radio" id="emballage-oui" name="emballage" value="oui">
                <label for="emballage-oui">Oui</label>
                <input type="radio" id="emballage-non" name="emballage" value="non" checked>
                <label for="emballage-non">Non</label>
            </div>
        </div>
    </div>

    <!-- Options d'entretoises (initialement masquées) -->
    <div id="entretoises-options" class="search-form" style="display: none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
        <!-- Entretoises fournies par CNR -->
        <div class="transport-option">
            <label>Entretoises fournies par CNR:</label>
            <div class="radio-group">
                <input type="radio" id="entretoises-cnr-oui" name="entretoises-cnr" value="oui">
                <label for="entretoises-cnr-oui">Oui</label>
                <input type="radio" id="entretoises-cnr-non" name="entretoises-cnr" value="non" checked>
                <label for="entretoises-cnr-non">Non</label>
            </div>
        </div>

        <!-- Type d'entretoises (masqué par défaut) -->
        <div id="entretoises-type-container" class="transport-option" style="display: none; margin-left: 20px;">
            <div class="radio-group">
                <input type="radio" id="entretoises-type-partiel" name="entretoises-type" value="partiel" checked>
                <label for="entretoises-type-partiel">Partiel</label>
                <input type="radio" id="entretoises-type-tous" name="entretoises-type" value="tous">
                <label for="entretoises-type-tous">Tous</label>
            </div>
        </div>
    </div>


    <!-- Bouton de validation commun aux deux sections -->
    <div class="search-form" style="margin-top: 20px;">
        <button id="validate-transport-button" class="search-button">Valider les options</button>
    </div>


    <!-- Filtre de repère (initialement masqué) -->
    <div id="repere-filter" class="search-form" style="display: none;">
        <select id="repere-select" class="search-select">
            <option value="">Sélectionnez un repère...</option>
            <!-- Les options seront ajoutées dynamiquement en JavaScript -->
        </select>
        <button id="search-repere-button" class="search-button">Filtrer</button>
    </div>

    <!-- Formulaire de quantité (initialement masqué) -->
    <div id="quantity-filter" class="search-form" style="display: none;">
        <div>
            <label for="quantity-input">Quantité:</label>
            <input type="number" id="quantity-input" class="search-input" min="1" value="1">
            <button id="calculate-button" class="search-button">Valider (soyez sûr d'avoir finalisé votre commande)</button>
        </div>

    </div>

    <!-- Sélection d'entretoises spécifiques (initialement masquée) -->
    <div id="entretoises-selection" class="search-form" style="display: none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
        <div class="search-title">Sélection d'entretoises spécifiques</div>
        <div style="margin: 10px 0;">
            <p id="entretoise-info">Veuillez sélectionner une entretoise pour ce panneau.</p>
        </div>
        <select id="entretoise-select" class="search-select">
            <option value="">Sélectionnez une entretoise...</option>
            <!-- Les options seront ajoutées dynamiquement en JavaScript -->
        </select>

        <!-- CHAMP DE QUANTITÉ D'ENTRETOISES -->
        <div id="entretoise-quantity-container" class="search-form" style="display: none; margin-top: 15px;">
            <div>
                <label for="entretoise-quantity-input">Quantité d'entretoises:</label>
                <input type="number" id="entretoise-quantity-input" class="search-input" min="1" value="1" style="width: 80px;">
            </div>
            <button id="add-entretoise-button" class="search-button">Ajouter entretoise</button>
        </div>


        <div id="entretoises-selected" style="margin-top: 15px; display: none;">
            <div class="search-title">Entretoises sélectionnées</div>
            <ul id="entretoises-list" style="list-style-type: none; padding: 0;"></ul>
        </div>
    </div>




    <div id="site-result" style="display: none;"></div>
</div>

<div class="toggle-controls">
    <button id="toggle-all-btn" class="toggle-all-btn">Afficher tous les tableaux</button>
</div>

<div id="loading">Chargement des données Excel...</div>
<div id="excel-data"></div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Variables pour stocker les données
        let allItemsBySite = {};
        let allSites = [];
        let filesDataGlobal = {};
        let allTablesVisible = false;
        // Variables pour le transport (ajoutez ces lignes)
        let transportBarreaux = "non";
        let dechargement = "non";
        let manutention = "non";
        let transportPanneaux = "non";
        let manutentionPanneaux = "non";
        let grutagePanneaux = "non";
        let emballage = "non";
        let entretoisesParCNR = "non";
        let entretoisesType = "partiel";
        let entretoisesParPanneaux = {};
        let currentPanneauWithEntretoises = null;
        let selectedEntretoises = [];

        // Configuration de l'authentification
        const authModal = document.getElementById('authModal');
        const authForm = document.getElementById('authForm');
        const authError = document.getElementById('authError');

        // Stocker les identifiants valides
        const validCredentials = [
            { username: "admin", password: "admin123" },
            { username: "cnrtemp", password: "mdpTemp25" }
        ];

        // Empêcher le défilement du contenu lorsque la popup est active
        document.body.style.overflow = 'hidden';

        // Fonction pour initialiser l'application après authentification
        function initializeApp() {
            // Permettre le défilement à nouveau
            document.body.style.overflow = 'auto';

            // Charger les données Excel
            loadExcelData();
        }

        // Gestionnaire de soumission du formulaire d'authentification
        authForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Vérifier les identifiants
            const isValid = validCredentials.some(cred =>
                cred.username === username && cred.password === password
            );

            if (isValid) {
                // Authentification réussie
                authModal.style.display = 'none';
                initializeApp();
            } else {
                // Authentification échouée
                authError.style.display = 'block';
                setTimeout(() => {
                    authError.style.display = 'none';
                }, 3000);
            }
        });

        // Fonction pour échapper le HTML
        function escapeHtml(unsafe) {
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Fonction pour formater les nombres
        function formatNumber(number) {
            return new Intl.NumberFormat('fr-FR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(number);
        }

        // Fonction pour extraire les sites et leurs items CCTP associés
        function extractSiteData(data) {
            const sites = [];
            const itemsBySite = {};

            // Liste des sites connus
            const knownSites = [
                "DTHR", "DTRS", "DTRI", "DTRM",
                "SEYSSEL", "CHAUTAGNE_BELLEY_BREGNIER-CORDON", "SAULT-BRENAZ",
                "PIERRE-BENITE", "VAUGRIS", "PEAGE DE ROUSSILLON", "SAINT VALLIER",
                "BOURG-LES-VALENCE", "BEAUCHASTEL / LOGIS - NEUF", "BEAUCHASTEL",
                "LOGIS-NEUF", "MONTELIMAR", "DONZERE MONDRAGON",
                "AVIGNON", "SAUVETERRE", "CADEROUSSE", "VALLABREGUES",
                "AVIGNON/SAUVETERRE/CADEROUSSE VALLABREGUES"
            ];

            // Variable pour suivre le site actuel
            let currentSite = null;
            let itemsForCurrentSite = [];

            // Analyser les données uniquement pour le fichier BPU_vrai.xlsx
            for (const fileKey in data) {
                if (fileKey !== 'file1' || !data[fileKey].data) continue;

                const fileData = data[fileKey].data;

                // Parcourir les feuilles du fichier
                for (const sheetName in fileData) {
                    const sheetData = fileData[sheetName];

                    // Trouver l'index de départ (la ligne avec "Item CCTP")
                    let startIndex = -1;
                    for (let i = 0; i < sheetData.length; i++) {
                        const row = sheetData[i];
                        if (row && row[0] === "Item CCTP ") {
                            startIndex = i + 1; // Commencer à la ligne suivante
                            break;
                        }
                    }

                    if (startIndex === -1) continue;

                    // Parcourir les lignes à partir de l'index de départ
                    for (let i = startIndex; i < sheetData.length; i++) {
                        const row = sheetData[i];

                        if (!row || row.length === 0) continue;

                        const itemCCTP = row[0];
                        const description = row[1] || "";
                        const sousTotal = row[8] || 0; // Colonne "Sous-total"

                        // Si c'est un site connu
                        if (itemCCTP && (
                            knownSites.includes(itemCCTP) ||
                            (!/\s/.test(itemCCTP) && !/\d/.test(itemCCTP) && !sousTotal)
                        )) {
                            // C'est un site
                            if (currentSite && itemsForCurrentSite.length > 0) {
                                // Pour gérer les occurrences multiples d'un même site
                                if (!itemsBySite[currentSite]) {
                                    itemsBySite[currentSite] = [];
                                }
                                // Ajouter les items comme un nouveau groupe pour ce site
                                itemsBySite[currentSite] = itemsBySite[currentSite].concat(itemsForCurrentSite);
                            }

                            // Nouveau site courant
                            currentSite = itemCCTP;
                            if (!sites.includes(currentSite)) {
                                sites.push(currentSite);
                            }
                            itemsForCurrentSite = [];
                        }
                        // Si c'est un item CCTP (a un sous-total > 0)
                        else if (itemCCTP && currentSite && sousTotal > 0) {
                            // C'est un item CCTP avec un sous-total
                            itemsForCurrentSite.push({
                                code: itemCCTP,
                                description: description,
                                sousTotal: sousTotal
                            });
                        }
                    }

                    // Sauvegarder les items du dernier site
                    if (currentSite && itemsForCurrentSite.length > 0) {
                        if (!itemsBySite[currentSite]) {
                            itemsBySite[currentSite] = [];
                        }
                        // Ajouter les items comme un nouveau groupe pour ce site
                        itemsBySite[currentSite] = itemsBySite[currentSite].concat(itemsForCurrentSite);
                    }
                }
            }

            return {
                sites: sites.filter(site => site && itemsBySite[site] && itemsBySite[site].length > 0),
                itemsBySite: itemsBySite
            };
        }

        // Fonction pour créer les tableaux HTML pour chaque feuille
        function renderSheetData(data, productTotals, filePath) {
            let html = '';
            const isWeightFile = filePath.includes('ref');

            for (const sheetName in data) {
                const sheetData = data[sheetName];
                const sheetProductTotals = productTotals[sheetName] || { products: {}, rows: {} };
                const sheetId = `sheet-${filePath.replace(/\./g, '-')}-${sheetName.replace(/\s+/g, '-')}`;
                const contentId = `content-${sheetId}`;

                html += `<div class="sheet-container">`;
                html += `<h2 class="sheet-title" data-target="${contentId}">
                            Feuille: ${escapeHtml(sheetName)}
                            <span class="toggle-icon collapsed">▼</span>
                        </h2>`;

                html += `<div id="${contentId}" class="sheet-content">`;
                if (sheetData && sheetData.length > 0) {
                    html += '<table>';

                    // En-têtes (limités aux 14 premières colonnes)
                    html += '<tr>';
                    for (let i = 0; i < Math.min(14, sheetData[0].length); i++) {
                        html += `<th>${escapeHtml(sheetData[0][i] || '')}</th>`;
                    }

                    // Ajouter une colonne pour le total uniquement pour le premier fichier (BPU_vrai.xlsx)
                    if (!isWeightFile) {
                        html += `<th>Total</th>`;
                    }
                    html += '</tr>';

                    // Données
                    for (let i = 1; i < sheetData.length; i++) {
                        html += '<tr>';
                        for (let j = 0; j < Math.min(14, sheetData[i].length); j++) {
                            html += `<td>${escapeHtml(sheetData[i][j] || '')}</td>`;
                        }

                        // Afficher le total uniquement pour le premier fichier
                        if (!isWeightFile) {
                            const rowValue = sheetProductTotals.rows[i] || 0;
                            html += `<td class="total-cell">${formatNumber(rowValue)} €</td>`;
                        }

                        html += '</tr>';
                    }

                    html += '</table>';
                } else {
                    html += '<p>Aucune donnée dans cette feuille</p>';
                }
                html += `</div>`; // Fin de sheet-content
                html += `</div>`; // Fin de sheet-container
            }

            return html;
        }

        // Fonction pour créer l'affichage complet des fichiers
        function renderExcelFiles(filesData) {
            let html = '';

            // Parcourir chaque fichier
            for (const fileKey in filesData) {
                const fileData = filesData[fileKey];
                const fileId = `file-${fileKey}`;
                const contentId = `content-${fileId}`;

                if (fileData.error) {
                    html += `<div class="file-container">`;
                    html += `<div class="file-title" data-target="${contentId}">
                                Fichier: ${escapeHtml(fileData.filePath || fileKey)}
                                <span class="toggle-icon collapsed">▼</span>
                            </div>`;
                    html += `<div id="${contentId}" class="file-content">`;
                    html += `<div class="error" style="display:block;">${escapeHtml(fileData.error)}</div>`;
                    html += `</div>`;
                    html += `</div>`;
                    continue;
                }

                html += `<div class="file-container">`;
                html += `<div class="file-title" data-target="${contentId}">
                            Fichier: ${escapeHtml(fileData.filePath)}
                            <span class="toggle-icon collapsed">▼</span>
                        </div>`;

                html += `<div id="${contentId}" class="file-content">`;
                // Ajouter les données de chaque feuille du fichier
                html += renderSheetData(fileData.data, fileData.productTotals, fileData.filePath);
                html += `</div>`;

                html += `</div>`;
            }

            return html;
        }

        // Fonction pour remplir le sélecteur de sites
        function populateSiteSelect(sites) {
            const selectElement = document.getElementById('site-select');

            // Sites à exclure
            const sitesToExclude = [
                "AVIGNON/SAUVETERRE/CADEROUSSE VALLABREGUES",
                "BEAUCHASTEL",
                "LOGIS-NEUF"
            ];

            // Filtrer les sites exclus
            const filteredSites = sites.filter(site =>
                site && !sitesToExclude.includes(site)
            );

            // Trier les sites par ordre alphabétique
            filteredSites.sort();

            // Vider d'abord le sélecteur (sauf l'option par défaut)
            while (selectElement.options.length > 1) {
                selectElement.remove(1);
            }

            // Ajouter chaque site comme option
            filteredSites.forEach(site => {
                if (!site) return; // Ignorer les sites vides

                const option = document.createElement('option');
                option.value = site;
                option.textContent = site;
                selectElement.appendChild(option);
            });
        }

// Fonction pour remplir le sélecteur de repères pour un site donné
        function populateRepereSelect(site) {
            const selectElement = document.getElementById('repere-select');
            const repereFilterDiv = document.getElementById('repere-filter');

            // Vider d'abord le sélecteur (sauf l'option par défaut)
            while (selectElement.options.length > 1) {
                selectElement.remove(1);
            }

            // Récupérer les items pour le site sélectionné
            let items = [];

            // Cas spécial pour "BEAUCHASTEL / LOGIS - NEUF" (combiner les deux sites)
            if (site === "BEAUCHASTEL / LOGIS - NEUF") {
                // Récupérer les items de Beauchastel
                const itemsBeauchastel = allItemsBySite["BEAUCHASTEL"] || [];
                // Récupérer les items de Logis-Neuf
                const itemsLogisNeuf = allItemsBySite["LOGIS-NEUF"] || [];
                // Combiner les deux ensembles d'items
                items = [...itemsBeauchastel, ...itemsLogisNeuf];
            } else {
                // Comportement standard pour les autres sites
                items = allItemsBySite[site] || [];
            }

            if (items.length === 0) {
                repereFilterDiv.style.display = 'none';
                return;
            }

            // Créer un Set pour éviter les doublons de descriptions
            const reperes = new Set();

            // Mots à bannir
            const motsABannir = ['entretoise', 'attache'];

            // Ajouter chaque description unique qui contient le mot "Panneaux" (ou variations)
            // et qui ne contient aucun des mots bannis
            items.forEach(item => {
                if (item.description) {
                    const description = item.description.toLowerCase();

                    // Vérifier si la description contient un mot lié à "panneau"
                    const contientPanneau = description.includes('panneau') ||
                        description.includes('panneaux') ||
                        description.includes('pannaux');

                    // Vérifier si la description contient un des mots bannis
                    const contientMotBanni = motsABannir.some(mot => description.includes(mot));

                    // Ajouter seulement si c'est un panneau sans mot banni
                    if (contientPanneau && !contientMotBanni) {
                        reperes.add(item.description);
                    }
                }
            });

            // Convertir en array et trier
            const reperesArray = Array.from(reperes).sort();

            // Si aucun repère correspondant aux critères n'est trouvé, masquer le filtre
            if (reperesArray.length === 0) {
                repereFilterDiv.style.display = 'none';
                return;
            }

            // Ajouter chaque repère comme option
            reperesArray.forEach(repere => {
                const option = document.createElement('option');
                option.value = repere;
                option.textContent = repere;
                selectElement.appendChild(option);
            });

            // Afficher le filtre de repère
            repereFilterDiv.style.display = 'flex';
        }

// Fonction de recherche par site
        function searchBySite() {
            const resultDiv = document.getElementById('site-result');
            const transportOptionsDiv = document.getElementById('transport-options');
            const transportPanneauxOptionsDiv = document.getElementById('transport-panneaux-options');
            const emballageOptionsDiv = document.getElementById('emballage-options');
            const entretoiseOptionsDiv = document.getElementById('entretoises-options');
            const repereFilterDiv = document.getElementById('repere-filter');

            // Sélectionner le site choisi
            const selectedSite = document.getElementById('site-select').value;

            // Vérifier qu'un site est sélectionné
            if (!selectedSite) {
                // Masquer le filtre de repère et les options de transport
                repereFilterDiv.style.display = 'none';
                transportOptionsDiv.style.display = 'none';
                transportPanneauxOptionsDiv.style.display = 'none';
                emballageOptionsDiv.style.display = 'none';
                entretoiseOptionsDiv.style.display = 'none';
                entretoiseSelectionDiv.style.display = 'none';
                return;
            }

            // Récupérer les items pour le site sélectionné
            const items = allItemsBySite[selectedSite] || [];

            if (items.length === 0) {
                // Masquer le filtre de repère et les options de transport
                repereFilterDiv.style.display = 'none';
                transportOptionsDiv.style.display = 'none';
                transportPanneauxOptionsDiv.style.display = 'none';
                emballageOptionsDiv.style.display = 'none';
                entretoiseOptionsDiv.style.display = 'none';
                entretoiseSelectionDiv.style.display = 'none';
                return;
            }

            // Remplir le sélecteur de repères
            populateRepereSelect(selectedSite);

            // Vérifier si le site a déjà une ligne d'options dans le tableau récapitulatif
            if (siteHasOptionsInRecap(selectedSite)) {
                // Si oui, afficher le sélecteur de repère
                repereFilterDiv.style.display = 'flex';
            } else {
                // Sinon, masquer le sélecteur de repère
                repereFilterDiv.style.display = 'none';
            }

            // Afficher les options de transport (barreaux, panneaux, emballage et entretoises)
            transportOptionsDiv.style.display = 'flex';
            transportPanneauxOptionsDiv.style.display = 'flex';
            emballageOptionsDiv.style.display = 'flex';
            entretoiseOptionsDiv.style.display = 'flex';

            // Réinitialiser les boutons radio à leur valeur par défaut
            document.getElementById('transport-barreaux-non').checked = true;
            document.getElementById('transport-panneaux-non').checked = true;
            document.getElementById('manutention-non').checked = true;
            document.getElementById('dechargement-non').checked = true;
            document.getElementById('manutention-panneaux-non').checked = true;
            document.getElementById('grutage-panneaux-non').checked = true;
            document.getElementById('emballage-non').checked = true;

            // Réinitialiser les options d'entretoises
            document.getElementById('entretoises-cnr-non').checked = true;
            document.getElementById('entretoises-type-partiel').checked = true;

            // Réinitialiser les variables globales
            transportBarreaux = "non";
            transportPanneaux = "non";
            manutention = "non";
            dechargement = "non";
            manutentionPanneaux = "non";
            grutagePanneaux = "non";
            emballage = "non";
            entretoisesParCNR = "non";
            entretoisesType = "partiel";

            // Masquer les options dépendantes
            document.getElementById('manutention-container').style.display = 'none';
            document.getElementById('manutention-days-container').style.display = 'none';
            document.getElementById('dechargement-container').style.display = 'none';
            document.getElementById('manutention-panneaux-container').style.display = 'none';
            document.getElementById('grutage-panneaux-container').style.display = 'none';
            document.getElementById('entretoises-type-container').style.display = 'none';
        }

        /**
         * Vérifie si un site a déjà une ligne d'options dans le tableau récapitulatif
         * @param {string} site - Le nom du site à vérifier
         * @returns {boolean} - true si le site a déjà une ligne d'options, false sinon
         */
        function siteHasOptionsInRecap(site) {
            // Si le tableau récapitulatif n'existe pas encore, retourner false
            if (!window.cumulativeResults || window.cumulativeResults.length === 0) {
                return false;
            }

            // Chercher une ligne d'options pour ce site
            return window.cumulativeResults.some(result =>
                result.isTransportOnly === true && result.site === site
            );
        }


// Fonction sécurisée pour accéder aux éléments DOM
        function getElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Élément avec l'ID '${id}' introuvable dans le DOM`);
                return null;
            }
            return element;
        }

// Fonction pour vérifier si nous devons afficher le sélecteur d'entretoises spécifiques
        function shouldShowEntretoiseSelection() {
            return entretoisesParCNR === "oui" && entretoisesType === "partiel";
        }

// Version sécurisée de filterByRepere
        function filterByRepere() {
            const selectedSite = getElement('site-select')?.value || '';
            const selectedRepere = getElement('repere-select')?.value || '';
            const quantityFilterDiv = getElement('quantity-filter');
            const entretoiseSelectionDiv = getElement('entretoises-selection');

            // Vérifier qu'un site et un repère sont sélectionnés
            if (!selectedSite || !selectedRepere) {
                if (quantityFilterDiv) quantityFilterDiv.style.display = 'none';
                if (entretoiseSelectionDiv) entretoiseSelectionDiv.style.display = 'none';
                return;
            }

            // Récupérer les items pour le site sélectionné
            let allItems = [];

            // Cas spécial pour "BEAUCHASTEL / LOGIS - NEUF"
            if (selectedSite === "BEAUCHASTEL / LOGIS - NEUF") {
                const itemsBeauchastel = allItemsBySite["BEAUCHASTEL"] || [];
                const itemsLogisNeuf = allItemsBySite["LOGIS-NEUF"] || [];
                allItems = [...itemsBeauchastel, ...itemsLogisNeuf];
            } else {
                allItems = allItemsBySite[selectedSite] || [];
            }

            // Filtrer les items par repère
            const filteredItems = allItems.filter(item => item.description === selectedRepere);

            if (filteredItems.length === 0) {
                alert(`Aucun item trouvé pour le repère "${selectedRepere}"`);
                if (quantityFilterDiv) quantityFilterDiv.style.display = 'none';
                if (entretoiseSelectionDiv) entretoiseSelectionDiv.style.display = 'none';
                return;
            }

            // Stocker les items filtrés dans une variable globale pour la fonction de calcul
            window.currentFilteredItems = filteredItems;

            // CORRECTION 5: Réinitialiser les entretoises pour le nouveau panneau
            resetEntretoisesForNewPanneau(selectedRepere);

            // Vérifier si nous devons afficher le sélecteur d'entretoises spécifiques
            if (shouldShowEntretoiseSelection() && entretoiseSelectionDiv) {
                // Afficher le sélecteur d'entretoises spécifiques
                entretoiseSelectionDiv.style.display = 'block';

                // Populer le sélecteur d'entretoises avec le site et le panneau
                try {
                    populateEntretoiseSelect(selectedSite, selectedRepere);
                } catch (error) {
                    console.error("Erreur lors du remplissage du sélecteur d'entretoises:", error);
                }
            } else if (entretoiseSelectionDiv) {
                // Masquer le sélecteur d'entretoises spécifiques
                entretoiseSelectionDiv.style.display = 'none';
            }

            // Afficher le formulaire de quantité
            if (quantityFilterDiv) {
                quantityFilterDiv.style.display = 'flex';
            }

            // Réinitialiser la quantité à 1
            const quantityInput = getElement('quantity-input');
            if (quantityInput) {
                quantityInput.value = 1;
            }
        }

// Fonction pour mettre à jour le texte d'information sur les entretoises
        function updateEntretoiseInfo() {
            const infoElement = getElement('entretoise-info');
            if (!infoElement) return;

            const quantityInput = getElement('quantity-input');
            const panneauQuantity = quantityInput ? (parseInt(quantityInput.value) || 1) : 1;

            if (!selectedEntretoises || selectedEntretoises.length === 0) {
                infoElement.textContent = `Veuillez sélectionner une pièce pour ce panneau (quantité de panneaux: ${panneauQuantity}).`;
            } else {
                let totalPieces = 0;
                selectedEntretoises.forEach(entretoise => {
                    const qtyFromFile = entretoise.quantityFromFile || 1;
                    totalPieces += qtyFromFile * panneauQuantity;
                });

                infoElement.textContent = `Vous avez sélectionné ${selectedEntretoises.length} type(s) de pièces pour un total de ${totalPieces} pièces (calcul automatique).`;
            }
        }

        // Fonction pour extraire les correspondances entretoises-panneaux du fichier NomenclatureEntretoise.xlsx
        function extractEntretoisesMapping(data) {
            console.log("Extraction des correspondances pièces-panneaux...");
            const mappings = {};

            // Vérifier si les données sont disponibles
            if (!data || !data.file3 || !data.file3.data) {
                console.warn("Données de NomenclatureEntretoise.xlsx non disponibles");
                return mappings;
            }

            const fileData = data.file3.data;

            // Parcourir chaque feuille
            for (const sheetName in fileData) {
                console.log(`Traitement de la feuille: ${sheetName}`);
                const sheetData = fileData[sheetName];

                // Vérifier si la feuille contient des données
                if (!sheetData || sheetData.length < 2) {
                    console.log("Feuille sans données, ignorée");
                    continue;
                }

                // Trouver les colonnes correspondant aux en-têtes
                const headerRow = sheetData[0] || [];
                const tableStarts = [];

                // Rechercher les positions de toutes les colonnes "REPERE" ou "Repere"
                for (let colIndex = 0; colIndex < headerRow.length; colIndex++) {
                    const cellValue = String(headerRow[colIndex] || '').trim().toUpperCase();
                    if (cellValue === 'REPERE') {
                        // Trouvé le début d'un tableau
                        tableStarts.push({
                            repereCol: colIndex,
                            planCol: colIndex + 1, // N°PLAN est généralement la colonne suivante
                            qteCol: colIndex + 2,  // QTE est généralement deux colonnes plus loin
                            nomCol: colIndex + 3   // NOM est généralement trois colonnes plus loin
                        });
                        console.log(`Tableau trouvé à la colonne ${colIndex}`);
                    }
                }

                // Si aucun tableau n'est trouvé, passer à la feuille suivante
                if (tableStarts.length === 0) {
                    console.log("Aucun tableau trouvé dans cette feuille");
                    continue;
                }

                // Traiter chaque tableau
                for (const tableInfo of tableStarts) {
                    const { repereCol, planCol, qteCol, nomCol } = tableInfo;

                    // Vérifier que les colonnes sont valides
                    if (nomCol >= headerRow.length) {
                        console.log(`Colonnes invalides pour le tableau commençant à ${repereCol}, ignoré`);
                        continue;
                    }

                    // Vérifier les noms des colonnes pour confirmer qu'il s'agit bien d'un tableau
                    const repereHeader = String(headerRow[repereCol] || '').trim().toUpperCase();
                    const nomHeader = String(headerRow[nomCol] || '').trim().toUpperCase();

                    if (repereHeader !== 'REPERE' || nomHeader !== 'NOM') {
                        console.log(`En-têtes invalides: ${repereHeader}, ${nomHeader}, ignoré`);
                        continue;
                    }

                    console.log(`Tableau confirmé: REPERE à ${repereCol}, NOM à ${nomCol}`);

                    // Trouver la ligne du panneau (généralement la première ligne de données)
                    let currentPanneauInfo = null;

                    // Parcourir les lignes pour traiter le tableau
                    for (let rowIndex = 1; rowIndex < sheetData.length; rowIndex++) {
                        const row = sheetData[rowIndex];
                        if (!row || row.length <= nomCol) continue;

                        const repere = String(row[repereCol] || '').trim();
                        const nom = String(row[nomCol] || '').trim();
                        const qte = row[qteCol] ? parseInt(row[qteCol]) : 1;

                        // Si le repère est vide ou '-' et le nom contient un site connu, c'est un panneau
                        if ((repere === '' || repere === '-') && isPanneauName(nom)) {
                            // Trouvé un panneau
                            const panneauInfo = extractPanneauSiteInfo(nom);
                            if (panneauInfo) {
                                currentPanneauInfo = panneauInfo;
                                console.log(`Panneau trouvé: ${nom}, site: ${panneauInfo.site}, panneau: ${panneauInfo.panneau}`);
                            }
                            continue;
                        }

                        // Si nous avons un panneau courant et que cette ligne est une pièce (a un nom)
                        if (currentPanneauInfo && nom && nom.trim() !== '') {
                            const { site, panneau } = currentPanneauInfo;
                            const panneauKey = `${site}|${panneau}`;

                            // Créer une clé supplémentaire pour les cas spéciaux comme AVIGNON G1, G2, etc.
                            let specialKey = null;
                            if (site === "AVIGNON" && panneau.match(/G\d+/i)) {
                                const panneauCode = panneau.match(/G\d+/i)[0];
                                specialKey = `AVIGNON|${panneauCode}`;
                            }

                            // Initialiser le tableau pour ce panneau s'il n'existe pas
                            if (!mappings[panneauKey]) {
                                mappings[panneauKey] = [];
                            }

                            // Ajouter la pièce au mapping
                            const pieceEntry = {
                                repere: repere,
                                nom: nom,
                                quantite: qte,
                                noPlan: String(row[planCol] || '').trim()
                            };

                            mappings[panneauKey].push(pieceEntry);
                            console.log(`Pièce ajoutée pour ${panneauKey}: ${repere} - ${nom} (${qte})`);

                            // Si une clé spéciale existe, l'ajouter également
                            if (specialKey && specialKey !== panneauKey) {
                                if (!mappings[specialKey]) {
                                    mappings[specialKey] = [];
                                }
                                mappings[specialKey].push(pieceEntry);
                                console.log(`Pièce ajoutée pour clé spéciale ${specialKey}: ${repere} - ${nom} (${qte})`);
                            }
                        }
                    }
                }
            }

            console.log("Correspondances pièces-panneaux extraites:", mappings);
            return mappings;
        }

// Fonction auxiliaire améliorée pour extraire le site et le panneau à partir du nom
        function extractPanneauSiteInfo(nom) {
            const nom_upper = nom.toUpperCase();

            // Liste des sites connus
            const knownSites = [
                "DTHR", "DTRS", "DTRI", "DTRM",
                "SEYSSEL", "CHAUTAGNE_BELLEY_BREGNIER-CORDON", "CHAUTAGNE", "BELLEY", "BREGNIER-CORDON", "SAULT-BRENAZ",
                "PIERRE-BENITE", "VAUGRIS", "PEAGE DE ROUSSILLON", "SAINT VALLIER", "ST VALLIER",
                "BOURG-LES-VALENCE", "BEAUCHASTEL", "LOGIS-NEUF",
                "MONTELIMAR", "DONZERE MONDRAGON",
                "AVIGNON", "SAUVETERRE", "CADEROUSSE", "VALLABREGUES"
            ];

            // Trouver le site dans le nom
            let site = null;
            for (const knownSite of knownSites) {
                if (nom_upper.includes(knownSite)) {
                    site = knownSite;
                    break;
                }
            }

            // Si site est CHAUTAGNE, BELLEY ou BREGNIER-CORDON, le convertir en site combiné
            if (site === "CHAUTAGNE" || site === "BELLEY" || site === "BREGNIER-CORDON") {
                site = "CHAUTAGNE_BELLEY_BREGNIER-CORDON";
            }

            // Si aucun site n'est trouvé explicitement
            if (!site) {
                // Pour les panneaux comme "PANNEAU INF BELLEY", extraire le site à la fin
                const match = nom_upper.match(/PANNEAU\s+(INF|SUP)\s+(.+)/i);
                if (match && match[2]) {
                    const potentialSite = match[2].trim();
                    // Vérifier si ce site est connu
                    for (const knownSite of knownSites) {
                        if (potentialSite.includes(knownSite) || knownSite.includes(potentialSite)) {
                            site = knownSite;

                            // Si site est CHAUTAGNE, BELLEY ou BREGNIER-CORDON, le convertir en site combiné
                            if (site === "CHAUTAGNE" || site === "BELLEY" || site === "BREGNIER-CORDON") {
                                site = "CHAUTAGNE_BELLEY_BREGNIER-CORDON";
                            }

                            break;
                        }
                    }
                }
            }

            // Si toujours pas de site, regarder s'il y a un pattern connu comme "AVIGNON G1"
            if (!site) {
                const match = nom_upper.match(/^([A-Z]+)\s+([A-Z0-9]+)$/i);
                if (match && match[1]) {
                    const potentialSite = match[1].trim();
                    // Vérifier si ce site est connu
                    for (const knownSite of knownSites) {
                        if (potentialSite.includes(knownSite) || knownSite.includes(potentialSite)) {
                            site = knownSite;

                            // Si site est CHAUTAGNE, BELLEY ou BREGNIER-CORDON, le convertir en site combiné
                            if (site === "CHAUTAGNE" || site === "BELLEY" || site === "BREGNIER-CORDON") {
                                site = "CHAUTAGNE_BELLEY_BREGNIER-CORDON";
                            }

                            break;
                        }
                    }
                }
            }

            // Si toujours pas de site trouvé
            if (!site) {
                console.log(`Aucun site reconnu dans le nom: ${nom}`);
                return null;
            }

            // Extraire le panneau
            let panneau = nom.replace(new RegExp(site.replace("_", ".*"), 'i'), '').trim();

            // Si le panneau est vide ou ne contient qu'un espace, utiliser le nom complet
            if (!panneau || panneau === '') {
                panneau = nom;
            }

            // Cas spécial pour AVIGNON G1, G2, etc.
            if (site === "AVIGNON" && nom_upper.match(/G\d+/i)) {
                panneau = nom_upper.match(/G\d+/i)[0];
            }

            // Traiter les cas spéciaux
            if (nom_upper.includes("PANNEAU INF")) {
                panneau = "PANNEAU INFERIEUR";
            } else if (nom_upper.includes("PANNEAU SUP")) {
                panneau = "PANNEAU SUPERIEUR";
            } else if (nom_upper.match(/^ST[-\s]?VALLIER\s+P\d+X?$/i)) {
                // Pour les panneaux comme "ST VALLIER P3"
                panneau = nom;
            }

            return { site, panneau };
        }


// Fonction pour vérifier si un nom contient un panneau
        function isPanneauName(nom) {
            const nom_upper = nom.toUpperCase();

            // Liste des sites connus
            const knownSites = [
                "DTHR", "DTRS", "DTRI", "DTRM",
                "SEYSSEL", "CHAUTAGNE", "BELLEY", "BREGNIER-CORDON", "SAULT-BRENAZ",
                "PIERRE-BENITE", "VAUGRIS", "PEAGE DE ROUSSILLON", "SAINT VALLIER", "ST VALLIER",
                "BOURG-LES-VALENCE", "BEAUCHASTEL", "LOGIS-NEUF",
                "MONTELIMAR", "DONZERE MONDRAGON",
                "AVIGNON", "SAUVETERRE", "CADEROUSSE", "VALLABREGUES"
            ];

            // Vérifier si le nom contient l'un des sites connus
            const containsSite = knownSites.some(site => nom_upper.includes(site));

            // Vérifier si le nom contient "PANNEAU" ou des mots-clés spécifiques
            const isPanneau = nom_upper.includes("PANNEAU") ||
                nom_upper.includes("INF") ||
                nom_upper.includes("SUP") ||
                /^[A-Z]+ [A-Z0-9]+$/i.test(nom); // Pattern comme "AVIGNON G1"

            return containsSite || isPanneau;
        }

// Fonction pour extraire le site et le panneau à partir du nom
        function extractPanneauSiteInfo(nom) {
            const nom_upper = nom.toUpperCase();

            // Liste des sites connus
            const knownSites = [
                "DTHR", "DTRS", "DTRI", "DTRM",
                "SEYSSEL", "CHAUTAGNE", "BELLEY", "BREGNIER-CORDON", "SAULT-BRENAZ",
                "PIERRE-BENITE", "VAUGRIS", "PEAGE DE ROUSSILLON", "SAINT VALLIER", "ST VALLIER",
                "BOURG-LES-VALENCE", "BEAUCHASTEL", "LOGIS-NEUF",
                "MONTELIMAR", "DONZERE MONDRAGON",
                "AVIGNON", "SAUVETERRE", "CADEROUSSE", "VALLABREGUES"
            ];

            // Trouver le site dans le nom
            let site = null;
            for (const knownSite of knownSites) {
                if (nom_upper.includes(knownSite)) {
                    site = knownSite;
                    break;
                }
            }

            // Si aucun site n'est trouvé explicitement
            if (!site) {
                // Pour les panneaux comme "PANNEAU INF BELLEY", extraire le site à la fin
                const match = nom_upper.match(/PANNEAU\s+(INF|SUP)\s+(.+)/i);
                if (match && match[2]) {
                    const potentialSite = match[2].trim();
                    // Vérifier si ce site est connu
                    for (const knownSite of knownSites) {
                        if (potentialSite.includes(knownSite) || knownSite.includes(potentialSite)) {
                            site = knownSite;
                            break;
                        }
                    }
                }
            }

            // Si toujours pas de site, regarder s'il y a un pattern connu comme "AVIGNON G1"
            if (!site) {
                const match = nom_upper.match(/^([A-Z]+)\s+([A-Z0-9]+)$/i);
                if (match && match[1]) {
                    const potentialSite = match[1].trim();
                    // Vérifier si ce site est connu
                    for (const knownSite of knownSites) {
                        if (potentialSite.includes(knownSite) || knownSite.includes(potentialSite)) {
                            site = knownSite;
                            break;
                        }
                    }
                }
            }

            // Si toujours pas de site trouvé
            if (!site) {
                console.log(`Aucun site reconnu dans le nom: ${nom}`);
                return null;
            }

            // Extraire le panneau
            let panneau = nom.replace(new RegExp(site, 'i'), '').trim();

            // Si le panneau est vide ou ne contient qu'un espace, utiliser le nom complet
            if (!panneau || panneau === '') {
                panneau = nom;
            }

            // Traiter les cas spéciaux
            if (nom_upper.includes("PANNEAU INF")) {
                panneau = "PANNEAU INFERIEUR";
            } else if (nom_upper.includes("PANNEAU SUP")) {
                panneau = "PANNEAU SUPERIEUR";
            } else if (nom_upper.match(/^ST[-\s]?VALLIER\s+P\d+X?$/i)) {
                // Pour les panneaux comme "ST VALLIER P3"
                panneau = nom;
            } else if (site === "AVIGNON" && nom_upper.match(/G\d+$/)) {
                // Pour les panneaux comme "AVIGNON G1"
                panneau = nom;
            }

            return { site, panneau };
        }

// Fonction auxiliaire pour extraire les informations de site et panneau à partir du nom de feuille
        function extractPanneauInfoFromSheetName(sheetName) {
            // Liste des sites connus
            const knownSites = [
                "DTHR", "DTRS", "DTRI", "DTRM",
                "SEYSSEL", "CHAUTAGNE", "BELLEY", "BREGNIER-CORDON", "SAULT-BRENAZ",
                "PIERRE-BENITE", "VAUGRIS", "PEAGE DE ROUSSILLON", "SAINT VALLIER", "ST VALLIER",
                "BOURG-LES-VALENCE", "BEAUCHASTEL", "LOGIS-NEUF",
                "MONTELIMAR", "DONZERE MONDRAGON",
                "AVIGNON", "SAUVETERRE", "CADEROUSSE", "VALLABREGUES"
            ];

            // Convertir en majuscules pour la comparaison
            const sheetNameUpper = sheetName.toUpperCase();

            // Chercher le site dans le nom de feuille
            let siteTrouve = null;
            for (const site of knownSites) {
                if (sheetNameUpper.includes(site)) {
                    siteTrouve = site;
                    break;
                }
            }

            // Si aucun site n'est trouvé, essayer d'extraire à partir de motifs courants
            if (!siteTrouve) {
                // Essayer de trouver un pattern comme "Site - Panneau"
                const sitePattern = /^([A-Za-z\s\-]+)\s*[-:]\s*(.+)$/;
                const match = sheetNameUpper.match(sitePattern);
                if (match) {
                    siteTrouve = match[1].trim();
                }
            }

            // Si toujours pas de site, utiliser le nom de la feuille comme identifiant
            if (!siteTrouve) {
                console.log(`Aucun site reconnu dans le nom de feuille: ${sheetName}`);
                return null;
            }

            // Extraire le nom du panneau du nom de feuille
            // Cela peut être complexe selon le format, mais essayons quelques patterns

            // Pattern 1: "Site - Panneau"
            let panneauPattern = new RegExp(`${siteTrouve}\\s*[-:]\\s*(.+)`, 'i');
            let panneauMatch = sheetNameUpper.match(panneauPattern);

            if (panneauMatch) {
                return {
                    site: siteTrouve,
                    panneau: panneauMatch[1].trim()
                };
            }

            // Pattern 2: Nom de feuille contient le site et quelque chose d'autre
            panneauPattern = new RegExp(`${siteTrouve}\\s+(.+)`, 'i');
            panneauMatch = sheetNameUpper.match(panneauPattern);

            if (panneauMatch) {
                return {
                    site: siteTrouve,
                    panneau: panneauMatch[1].trim()
                };
            }

            // Si aucun pattern ne correspond, utiliser le nom de feuille comme panneau
            return {
                site: siteTrouve,
                panneau: sheetName.replace(new RegExp(siteTrouve, 'i'), '').trim() || "PANNEAU"
            };
        }

        // Nouvelle fonction pour gérer la sélection d'une entretoise
        function handleEntretoiseSelection() {
            const entretoiseSelect = getElement('entretoise-select');
            const quantityContainer = getElement('entretoise-quantity-container');
            const quantityInput = getElement('entretoise-quantity-input');

            if (!entretoiseSelect || !quantityContainer) return;

            const selectedIndex = entretoiseSelect.selectedIndex;

            if (selectedIndex < 1) {
                // Aucune entretoise sélectionnée, masquer le champ de quantité
                quantityContainer.style.display = 'none';
            } else {
                // Entretoise sélectionnée, afficher le champ de quantité
                quantityContainer.style.display = 'flex';

                // Réinitialiser la quantité à 1
                if (quantityInput) {
                    quantityInput.value = 1;
                }
            }
        }


// Fonction pour remplir le sélecteur d'entretoises spécifiques
        function populateEntretoiseSelect(site, panneau) {
            console.log(`Remplissage du sélecteur pour site: ${site}, panneau: ${panneau}`);
            const selectElement = getElement('entretoise-select');
            const quantityContainer = getElement('entretoise-quantity-container');

            if (!selectElement) {
                console.error("Élément select pour entretoises non trouvé");
                return;
            }

            // Vider d'abord le sélecteur (sauf l'option par défaut)
            while (selectElement.options.length > 1) {
                selectElement.remove(1);
            }

            // Masquer le champ de quantité par défaut
            if (quantityContainer) {
                quantityContainer.style.display = 'none';
            }

            // Chercher les pièces correspondant à ce panneau
            let pieces = [];
            let siteMatch = false;
            let panneauMatch = false;

            // Normaliser le site et le panneau pour faciliter les comparaisons
            const siteNormalized = site.toUpperCase().trim();
            const panneauNormalized = panneau.toUpperCase().trim();

            // Détecter s'il s'agit d'un panneau inférieur ou supérieur
            const isPanneauInferieur = panneauNormalized.includes('INF') || panneauNormalized.includes('INFERIEUR');
            const isPanneauSuperieur = panneauNormalized.includes('SUP') || panneauNormalized.includes('SUPERIEUR');

            console.log(`Type de panneau: ${isPanneauInferieur ? 'Inférieur' : (isPanneauSuperieur ? 'Supérieur' : 'Non spécifié')}`);

            // Gestion du site combiné
            let searchSites = [siteNormalized];
            if (siteNormalized === "CHAUTAGNE_BELLEY_BREGNIER-CORDON") {
                searchSites = ["CHAUTAGNE", "BELLEY", "BREGNIER-CORDON", "CHAUTAGNE_BELLEY_BREGNIER-CORDON"];
            } else if (siteNormalized === "CHAUTAGNE" || siteNormalized === "BELLEY" || siteNormalized === "BREGNIER-CORDON") {
                searchSites = ["CHAUTAGNE", "BELLEY", "BREGNIER-CORDON", "CHAUTAGNE_BELLEY_BREGNIER-CORDON"];
            }

            console.log(`Recherche de pièces pour ${searchSites.join(", ")} - ${panneauNormalized}`);

            // Parcourir toutes les clés dans entretoisesParPanneaux
            for (const key in entretoisesParPanneaux) {
                // Décomposer la clé en site et panneau
                const [keySite, keyPanneau] = key.split('|').map(part => part.toUpperCase().trim());

                console.log(`Examen de la clé: ${key} (${keySite} | ${keyPanneau})`);

                // Vérifier la correspondance du site avec l'un des sites de recherche
                const sitesMatch = searchSites.some(searchSite =>
                    keySite === searchSite || keySite.includes(searchSite) || searchSite.includes(keySite)
                );

                if (sitesMatch) {
                    siteMatch = true;
                    console.log(`  Site correspondant: ${keySite}`);

                    // Pour Chautagne_Belley_Bregnier-Cordon, vérifier aussi le type de panneau (inf/sup)
                    if ((siteNormalized === "CHAUTAGNE_BELLEY_BREGNIER-CORDON" ||
                            siteNormalized === "CHAUTAGNE" ||
                            siteNormalized === "BELLEY" ||
                            siteNormalized === "BREGNIER-CORDON") &&
                        (isPanneauInferieur || isPanneauSuperieur)) {

                        const isKeyPanneauInferieur = keyPanneau.includes('INF') || keyPanneau.includes('INFERIEUR');
                        const isKeyPanneauSuperieur = keyPanneau.includes('SUP') || keyPanneau.includes('SUPERIEUR');

                        // Vérifier si le type de panneau correspond
                        if ((isPanneauInferieur && !isKeyPanneauInferieur) ||
                            (isPanneauSuperieur && !isKeyPanneauSuperieur)) {
                            // Types de panneaux différents, passer à la clé suivante
                            console.log(`  Type de panneau différent, ignoré`);
                            continue;
                        }
                    }

                    // Cas spécial pour AVIGNON G1, G2, etc.
                    if (siteNormalized === "AVIGNON") {
                        // Extraire le numéro de panneau (G1, G2, etc.) du panneau actuel
                        const panneauCodeMatch = panneauNormalized.match(/G\d+/i);
                        const keyPanneauCodeMatch = keyPanneau.match(/G\d+/i);

                        if (panneauCodeMatch && keyPanneauCodeMatch) {
                            if (panneauCodeMatch[0].toUpperCase() === keyPanneauCodeMatch[0].toUpperCase()) {
                                console.log(`  Correspondance spéciale AVIGNON: ${panneauCodeMatch[0]} === ${keyPanneauCodeMatch[0]}`);
                                pieces = entretoisesParPanneaux[key];
                                panneauMatch = true;
                                break;
                            }
                        }
                    }
                    // Cas général
                    else if (keyPanneau === panneauNormalized || keyPanneau.includes(panneauNormalized) || panneauNormalized.includes(keyPanneau)) {
                        console.log(`  Panneau correspondant: ${keyPanneau}`);
                        pieces = entretoisesParPanneaux[key];
                        panneauMatch = true;
                        break;
                    }
                }
            }

            // Si aucune correspondance exacte n'est trouvée, recherche plus large
            if (pieces.length === 0) {
                console.log("Aucune correspondance exacte, recherche plus large...");

                // Chercher des correspondances partielles pour les panneaux AVIGNON G1, G2, etc.
                if (siteNormalized === "AVIGNON" && panneauNormalized.match(/G\d+/i)) {
                    const panneauCode = panneauNormalized.match(/G\d+/i)[0].toUpperCase();
                    console.log(`Recherche spéciale pour AVIGNON ${panneauCode}`);

                    for (const key in entretoisesParPanneaux) {
                        const keyUpper = key.toUpperCase();
                        if (keyUpper.includes("AVIGNON") && keyUpper.includes(panneauCode)) {
                            console.log(`Trouvé correspondance: ${key}`);
                            pieces = entretoisesParPanneaux[key];
                            break;
                        }
                    }
                }
                // Cas spécial pour le site combiné
                else if (searchSites.length > 1) {
                    for (const key in entretoisesParPanneaux) {
                        const [keySite, keyPanneau] = key.split('|').map(part => part.toUpperCase().trim());
                        const sitesMatch = searchSites.some(searchSite =>
                            keySite === searchSite || keySite.includes(searchSite) || searchSite.includes(keySite)
                        );

                        if (sitesMatch) {
                            // Pour Chautagne_Belley_Bregnier-Cordon, vérifier aussi le type de panneau (inf/sup)
                            if (isPanneauInferieur || isPanneauSuperieur) {
                                const isKeyPanneauInferieur = keyPanneau.includes('INF') || keyPanneau.includes('INFERIEUR');
                                const isKeyPanneauSuperieur = keyPanneau.includes('SUP') || keyPanneau.includes('SUPERIEUR');

                                // Vérifier si le type de panneau correspond
                                if ((isPanneauInferieur && !isKeyPanneauInferieur) ||
                                    (isPanneauSuperieur && !isKeyPanneauSuperieur)) {
                                    // Types de panneaux différents, passer à la clé suivante
                                    continue;
                                }
                            }

                            if (keyPanneau.includes(panneauNormalized) || panneauNormalized.includes(keyPanneau)) {
                                console.log(`Trouvé correspondance pour site combiné: ${key}`);
                                pieces = entretoisesParPanneaux[key];
                                break;
                            }
                        }
                    }
                }
            }

            // Si toujours aucune pièce trouvée, recherche par mot-clé dans toutes les clés
            if (pieces.length === 0 && siteMatch) {
                console.log("Recherche par mot-clé...");

                // Extraire des mots-clés potentiels du nom du panneau
                let keywords = panneauNormalized.split(/\s+/);
                keywords = keywords.filter(word => word.length > 1); // Ignorer les mots trop courts

                console.log(`Mots-clés: ${keywords.join(', ')}`);

                for (const key in entretoisesParPanneaux) {
                    const [keySite, keyPanneau] = key.split('|').map(part => part.toUpperCase().trim());

                    // Vérifier si l'un des sites de recherche est présent dans la clé
                    const sitesMatch = searchSites.some(searchSite => keySite.includes(searchSite));

                    if (sitesMatch) {
                        // Pour Chautagne_Belley_Bregnier-Cordon, vérifier aussi le type de panneau (inf/sup)
                        if (isPanneauInferieur || isPanneauSuperieur) {
                            const isKeyPanneauInferieur = keyPanneau.includes('INF') || keyPanneau.includes('INFERIEUR');
                            const isKeyPanneauSuperieur = keyPanneau.includes('SUP') || keyPanneau.includes('SUPERIEUR');

                            // Vérifier si le type de panneau correspond
                            if ((isPanneauInferieur && !isKeyPanneauInferieur) ||
                                (isPanneauSuperieur && !isKeyPanneauSuperieur)) {
                                // Types de panneaux différents, passer à la clé suivante
                                continue;
                            }
                        }

                        // Vérifier si l'un des mots-clés est présent dans la clé
                        for (const keyword of keywords) {
                            if (keyPanneau.includes(keyword)) {
                                console.log(`Trouvé mot-clé ${keyword} dans ${key}`);
                                pieces = entretoisesParPanneaux[key];
                                break;
                            }
                        }

                        if (pieces.length > 0) break;
                    }
                }
            }

            // Si aucune pièce n'est toujours pas trouvée, utiliser un dernier recours
            if (pieces.length === 0) {
                console.log("Aucune pièce trouvée avec les méthodes précédentes, recherche large...");

                // Pour le dernier recours, trouver n'importe quelle entrée contenant l'un des sites
                for (const key in entretoisesParPanneaux) {
                    const [keySite, keyPanneau] = key.split('|').map(part => part.toUpperCase().trim());
                    const sitesMatch = searchSites.some(searchSite => keySite.includes(searchSite));

                    if (sitesMatch) {
                        // Pour Chautagne_Belley_Bregnier-Cordon, vérifier aussi le type de panneau (inf/sup)
                        if (isPanneauInferieur || isPanneauSuperieur) {
                            const isKeyPanneauInferieur = keyPanneau.includes('INF') || keyPanneau.includes('INFERIEUR');
                            const isKeyPanneauSuperieur = keyPanneau.includes('SUP') || keyPanneau.includes('SUPERIEUR');

                            // Vérifier si le type de panneau correspond
                            if ((isPanneauInferieur && !isKeyPanneauInferieur) ||
                                (isPanneauSuperieur && !isKeyPanneauSuperieur)) {
                                // Types de panneaux différents, passer à la clé suivante
                                continue;
                            }
                        }

                        console.log(`Dernier recours: utilisation de ${key}`);
                        pieces = entretoisesParPanneaux[key];
                        break;
                    }
                }
            }

            console.log(`Nombre total de pièces trouvées: ${pieces.length}`);

            // Filtrer les pièces pour ne garder que celles contenant "entretoise" ou "plaque"
            const filteredPieces = pieces.filter(piece => {
                const nomLower = (piece.nom || '').toLowerCase();
                return nomLower.includes('entretoise') || nomLower.includes('plaque');
            });

            console.log(`Nombre de pièces après filtrage (entretoises/plaques): ${filteredPieces.length}`);

            // Trier les pièces par nom
            filteredPieces.sort((a, b) => (a.nom || '').localeCompare(b.nom || ''));

            // Ajouter chaque pièce comme option
            filteredPieces.forEach(piece => {
                const option = document.createElement('option');
                option.value = piece.nom || '';

                // Créer un affichage informatif avec repère seulement (plus de quantité du fichier)
                let affichage = piece.nom || '';


                option.textContent = affichage;
                selectElement.appendChild(option);
                console.log(`Option ajoutée: ${affichage}`);
            });

            // Si aucune pièce trouvée, afficher un message
            if (filteredPieces.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "Aucune entretoise ou plaque trouvée pour ce panneau";
                option.disabled = true;
                selectElement.appendChild(option);
                console.log("Aucune pièce trouvée, message affiché");
            }
        }



// Fonction pour ajouter une entretoise à la liste
        function addEntretoise() {
            const entretoiseSelect = getElement('entretoise-select');
            const quantityInput = getElement('entretoise-quantity-input');

            if (!entretoiseSelect || !quantityInput) return;

            const selectedIndex = entretoiseSelect.selectedIndex;
            if (selectedIndex < 1) { // L'index 0 est l'option "Sélectionnez une pièce..."
                alert("Veuillez sélectionner une pièce.");
                return;
            }

            const selectedOption = entretoiseSelect.options[selectedIndex];
            const selectedEntretoise = selectedOption.value;

            // Récupérer la quantité saisie par l'utilisateur
            const quantity = parseInt(quantityInput.value) || 1;

            if (quantity < 1) {
                alert("La quantité doit être au minimum de 1.");
                quantityInput.value = 1;
                return;
            }

            // Extraire le repère de l'option
            const repere = selectedOption.dataset.repere || "";

            // Vérifier si cette entretoise est déjà dans la liste
            const existingIndex = selectedEntretoises.findIndex(e => e.description === selectedEntretoise);

            if (existingIndex !== -1) {
                // Mettre à jour la quantité si l'entretoise existe déjà
                selectedEntretoises[existingIndex].quantity = quantity;
                console.log(`Quantité mise à jour pour ${selectedEntretoise}: ${quantity}`);
            } else {
                // Ajouter la nouvelle entretoise
                const entretoise = {
                    description: selectedEntretoise,
                    repere: repere,
                    quantity: quantity,
                    id: 'entretoise-' + Date.now()
                };

                selectedEntretoises.push(entretoise);
                console.log(`Nouvelle entretoise ajoutée: ${selectedEntretoise}, quantité: ${quantity}`);
            }

            // Afficher un message de confirmation
            alert(`Pièce "${selectedEntretoise}" ajoutée avec une quantité de ${quantity}.`);

            // Réinitialiser la sélection
            entretoiseSelect.value = '';
            quantityInput.value = 1;

            // Masquer le champ de quantité
            const quantityContainer = getElement('entretoise-quantity-container');
            if (quantityContainer) {
                quantityContainer.style.display = 'none';
            }

            // NOUVEAU: Mettre à jour l'affichage informatif des entretoises
            updateEntretoiseInfoExtended();
        }

// Fonction pour valider les options de transport pour un site
        function validateTransportOptions() {
            const selectedSite = document.getElementById('site-select').value;

            // Vérifier qu'un site est sélectionné
            if (!selectedSite) {
                alert("Veuillez sélectionner un site.");
                return;
            }

            // Si c'est la première fois que l'on ajoute un résultat
            if (!window.cumulativeResults) {
                window.cumulativeResults = [];
            }

            // Récupérer le nombre de demi-journées si la manutention est "oui"
            let nbDemiJournees = 0;
            if (manutention === "oui") {
                nbDemiJournees = parseInt(document.getElementById('manutention-days').value) || 1;
                if (nbDemiJournees < 1) {
                    nbDemiJournees = 1;
                    document.getElementById('manutention-days').value = 1;
                }
            }

            // Vérifier si une ligne d'options de transport existe déjà pour ce site
            const existingTransportIndex = window.cumulativeResults.findIndex(
                result => result.isTransportOnly && result.site === selectedSite
            );

            if (existingTransportIndex !== -1) {
                // Une entrée existe déjà, mettre à jour plutôt qu'ajouter
                window.cumulativeResults[existingTransportIndex].transportBarreaux = transportBarreaux;
                window.cumulativeResults[existingTransportIndex].transportPanneaux = transportPanneaux;
                window.cumulativeResults[existingTransportIndex].manutention = manutention;
                window.cumulativeResults[existingTransportIndex].dechargement = dechargement;
                window.cumulativeResults[existingTransportIndex].manutentionPanneaux = manutentionPanneaux;
                window.cumulativeResults[existingTransportIndex].grutagePanneaux = grutagePanneaux;
                window.cumulativeResults[existingTransportIndex].emballage = emballage;

                const entretoiseSelectionDiv = document.getElementById('entretoises-selection');
                if (entretoiseSelectionDiv) {
                    entretoiseSelectionDiv.style.display = 'none';
                }

                // Ajouter les options d'entretoises
                window.cumulativeResults[existingTransportIndex].entretoisesParCNR = entretoisesParCNR;
                window.cumulativeResults[existingTransportIndex].entretoisesType = entretoisesType;

                // Ajouter le nombre de demi-journées seulement si manutention est "oui"
                if (manutention === "oui") {
                    window.cumulativeResults[existingTransportIndex].manutentionDays = nbDemiJournees;
                } else {
                    // Supprimer la propriété si elle existe
                    delete window.cumulativeResults[existingTransportIndex].manutentionDays;
                }
            } else {
                // Aucune entrée existante, ajouter une nouvelle
                const entryId = 'transport-' + Date.now();

                const newEntry = {
                    id: entryId,
                    site: selectedSite,
                    isTransportOnly: true,
                    transportBarreaux: transportBarreaux,
                    transportPanneaux: transportPanneaux,
                    manutention: manutention,
                    dechargement: dechargement,
                    manutentionPanneaux: manutentionPanneaux,
                    grutagePanneaux: grutagePanneaux,
                    emballage: emballage,
                    entretoisesParCNR: entretoisesParCNR,
                    entretoisesType: entretoisesType
                };

                // Ajouter le nombre de demi-journées seulement si manutention est "oui"
                if (manutention === "oui") {
                    newEntry.manutentionDays = nbDemiJournees;
                }

                window.cumulativeResults.push(newEntry);
            }

            // Afficher le sélecteur de repère après validation des options
            document.getElementById('repere-filter').style.display = 'flex';

            // Mettre à jour l'affichage du tableau
            updateResultsTable();
        }





        // Fonction pour masquer les fichiers Excel
        function hideExcelData() {
            const excelDataContainer = document.getElementById('excel-data');
            if (excelDataContainer) {
                excelDataContainer.style.display = 'none';
            }

            // Masquer également le bouton de toggle qui contrôle l'affichage des tableaux
            const toggleButton = document.getElementById('toggle-all-btn');
            if (toggleButton) {
                toggleButton.style.display = 'none';
            }

            // Masquer le titre "Affichage des fichiers Excel"
            const titleElements = document.getElementsByTagName('h1');
            for (let i = 0; i < titleElements.length; i++) {
                if (titleElements[i].innerText === 'Affichage des fichiers Excel') {
                    titleElements[i].style.display = 'none';
                }
            }

            // Masquer le div de contrôle des tableaux
            const toggleControls = document.querySelector('.toggle-controls');
            if (toggleControls) {
                toggleControls.style.display = 'none';
            }
        }

        /**
         * Met à jour l'affichage informatif des entretoises sélectionnées
         * Cette fonction affiche une liste simple sous le sélecteur d'entretoises
         */
        function updateEntretoisesDisplay() {
            console.log("Mise à jour de l'affichage des entretoises sélectionnées");

            const entretoisesSelectedDiv = getElement('entretoises-selected');
            const entretoisesList = getElement('entretoises-list');

            if (!entretoisesSelectedDiv || !entretoisesList) {
                console.log("Éléments d'affichage des entretoises non trouvés");
                return;
            }

            // Vider la liste actuelle
            entretoisesList.innerHTML = '';

            // Si aucune entretoise sélectionnée, masquer la section
            if (!selectedEntretoises || selectedEntretoises.length === 0) {
                entretoisesSelectedDiv.style.display = 'none';
                console.log("Aucune entretoise sélectionnée, masquage de l'affichage");
                return;
            }

            // Afficher la section et remplir la liste
            entretoisesSelectedDiv.style.display = 'block';

            selectedEntretoises.forEach((entretoise, index) => {
                const entretoiseItem = createEntretoiseDisplayItem(entretoise, index);
                entretoisesList.appendChild(entretoiseItem);
            });

            console.log(`Affichage mis à jour avec ${selectedEntretoises.length} entretoise(s)`);
        }

        /**
         * Crée un élément d'affichage pour une entretoise sélectionnée
         * @param {Object} entretoise - L'entretoise à afficher
         * @param {number} index - Index de l'entretoise dans la liste
         * @return {HTMLElement} Élément DOM à ajouter à la liste
         */
        function createEntretoiseDisplayItem(entretoise, index) {
            // Créer l'élément li
            const listItem = document.createElement('li');
            listItem.style.cssText = `
        padding: 8px 12px;
        margin: 4px 0;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        font-size: 14px;
        color: #495057;
        display: flex;
        justify-content: space-between;
        align-items: center;
    `;

            // Nettoyer le nom de l'entretoise pour l'affichage
            const cleanName = cleanEntretoiseNameForDisplay(entretoise.description);

            // Créer le contenu principal
            const mainContent = document.createElement('span');
            mainContent.innerHTML = `
        <strong>${escapeHtml(cleanName)}</strong>
        <span style="color: #6c757d; margin-left: 8px;">Quantité: ${entretoise.quantity}</span>
    `;

            // Créer l'indicateur de statut (optionnel)
            const statusIndicator = document.createElement('span');
            statusIndicator.style.cssText = `
        font-size: 12px;
        color: #28a745;
        font-weight: bold;
    `;
            statusIndicator.textContent = '✓';

            // Assembler l'élément
            listItem.appendChild(mainContent);
            listItem.appendChild(statusIndicator);

            return listItem;
        }

        /**
         * Nettoie le nom de l'entretoise pour un affichage plus lisible
         * @param {string} entretoiseDescription - Description complète de l'entretoise
         * @return {string} Nom nettoyé pour l'affichage
         */
        function cleanEntretoiseNameForDisplay(entretoiseDescription) {
            if (!entretoiseDescription) return '';

            let cleanName = entretoiseDescription.trim();

            // Enlever le préfixe "ENTRETOISE" s'il existe (comme dans les autres fonctions)
            if (cleanName.toUpperCase().startsWith('ENTRETOISE ')) {
                cleanName = cleanName.substring(11);
            }

            return cleanName;
        }

        /**
         * Met à jour l'affichage des informations sur les entretoises et le panneau
         * Cette fonction remplace updateEntretoiseInfo() avec plus de détails
         */
        function updateEntretoiseInfoExtended() {
            const infoElement = getElement('entretoise-info');
            if (!infoElement) return;

            const quantityInput = getElement('quantity-input');
            const panneauQuantity = quantityInput ? (parseInt(quantityInput.value) || 1) : 1;

            let infoText = '';

            if (!selectedEntretoises || selectedEntretoises.length === 0) {
                infoText = `Veuillez sélectionner une pièce pour ce panneau (quantité de panneaux: ${panneauQuantity}).`;
            } else {
                let totalPieces = 0;
                selectedEntretoises.forEach(entretoise => {
                    totalPieces += entretoise.quantity;
                });

                const plurielType = selectedEntretoises.length > 1 ? 'types' : 'type';
                const plurielPiece = totalPieces > 1 ? 'pièces' : 'pièce';

                infoText = `${selectedEntretoises.length} ${plurielType} de pièces sélectionné(s) pour un total de ${totalPieces} ${plurielPiece}.`;
            }

            infoElement.textContent = infoText;

            // Mettre à jour également l'affichage des entretoises
            updateEntretoisesDisplay();
        }

        // Fonction pour réinitialiser les entretoises lors du changement de panneau
        function resetEntretoisesForNewPanneau(newPanneau) {
            // Si c'est un nouveau panneau différent, réinitialiser complètement
            if (currentPanneauWithEntretoises !== newPanneau) {
                currentPanneauWithEntretoises = newPanneau;
                selectedEntretoises = [];

                // Réinitialiser l'affichage des entretoises sélectionnées
                const entretoisesSelected = getElement('entretoises-selected');
                if (entretoisesSelected) {
                    entretoisesSelected.style.display = 'none';
                }

                const entretoisesList = getElement('entretoises-list');
                if (entretoisesList) {
                    entretoisesList.innerHTML = '';
                }

                const entretoiseSelect = getElement('entretoise-select');
                if (entretoiseSelect) {
                    entretoiseSelect.value = '';
                }

                const quantityContainer = getElement('entretoise-quantity-container');
                if (quantityContainer) {
                    quantityContainer.style.display = 'none';
                }

                // Mettre à jour l'affichage des informations
                updateEntretoiseInfoExtended();

                console.log(`Entretoises et affichage réinitialisés pour le nouveau panneau: ${newPanneau}`);
            }
        }

// Fonction de calcul avec quantité
        function calculateWithQuantity() {
            const resultDiv = document.getElementById('site-result');
            const quantityInput = document.getElementById('quantity-input');
            const selectedRepere = document.getElementById('repere-select').value;
            const selectedSite = document.getElementById('site-select').value;

            // Vérifier que la quantité est valide
            const quantity = parseInt(quantityInput.value, 10);
            if (isNaN(quantity) || quantity < 1) {
                quantityInput.value = 1;
                return;
            }

            // Vérifier que nous avons des items filtrés
            if (!window.currentFilteredItems || window.currentFilteredItems.length === 0) {
                return;
            }

            // Initialiser le tableau de résultats si nécessaire
            if (!window.cumulativeResults) {
                window.cumulativeResults = [];
            }

            // CORRECTION 3: Traiter les entretoises AVANT de réinitialiser la liste
            if (shouldShowEntretoiseSelection() && selectedEntretoises.length > 0) {
                addEntretoisesToResults(selectedSite, selectedRepere, quantity);

                // CORRECTION 4: Réinitialiser la liste des entretoises sélectionnées après ajout
                selectedEntretoises = [];
                const entretoisesList = getElement('entretoises-list');
                if (entretoisesList) {
                    entretoisesList.innerHTML = '';
                }
                const entretoisesSelected = getElement('entretoises-selected');
                if (entretoisesSelected) {
                    entretoisesSelected.style.display = 'none';
                }

                // Réinitialiser également le sélecteur d'entretoises
                const entretoiseSelect = getElement('entretoise-select');
                if (entretoiseSelect) {
                    entretoiseSelect.value = '';
                }

                // Masquer le champ de quantité d'entretoises
                const quantityContainer = getElement('entretoise-quantity-container');
                if (quantityContainer) {
                    quantityContainer.style.display = 'none';
                }
            }

            // Calculer le total pour les items filtrés avec la quantité
            let totalAmount = 0;
            window.currentFilteredItems.forEach(item => {
                totalAmount += parseFloat(item.sousTotal) || 0;
            });

            // Multiplier par la quantité
            const finalAmount = totalAmount * quantity;

            // Générer un ID unique pour l'entrée de produit
            const productEntryId = 'product-' + Date.now() + '-' + Math.floor(Math.random() * 1000);

            // Ajouter le produit au tableau cumulé
            window.cumulativeResults.push({
                id: productEntryId,
                site: selectedSite,
                description: selectedRepere,
                quantity: quantity,
                totalPrice: finalAmount
            });

            // Mettre à jour l'affichage du tableau
            updateResultsTable();
        }

        /**
         * Calcule et affiche les forfaits logistique et suivi
         * Cette fonction est appelée à chaque mise à jour du tableau récapitulatif
         */
        function calculerEtAfficherForfaits() {
            // Vérifier si nous avons des résultats dans le tableau récapitulatif
            if (!window.cumulativeResults || window.cumulativeResults.length === 0) {
                console.log("Aucun forfait (aucun panneau sélectionné)");
                return {
                    logistique: 0,
                    suivi: 0,
                    total: 0
                };
            }

            // Calculer la quantité totale de panneaux SEULEMENT (pas les entretoises)
            let quantiteTotalePanneaux = 0;

            window.cumulativeResults.forEach(result => {
                // NE COMPTER QUE LES PANNEAUX (ignorer les options et les entretoises)
                if (!result.isTransportOnly && !result.isEntretoise && result.quantity) {
                    quantiteTotalePanneaux += parseInt(result.quantity) || 0;
                }
            });

            // Déterminer les forfaits unitaires en fonction de la quantité
            let forfaitLogistiqueUnitaire = calculerForfaitLogistique(quantiteTotalePanneaux);
            let forfaitSuiviUnitaire = calculerForfaitSuivi(quantiteTotalePanneaux);

            // Calculer les forfaits totaux (forfait unitaire * quantité totale)
            let forfaitLogistiqueTotal = forfaitLogistiqueUnitaire * quantiteTotalePanneaux;
            let forfaitSuiviTotal = forfaitSuiviUnitaire * quantiteTotalePanneaux;
            let forfaitTotal = forfaitLogistiqueTotal + forfaitSuiviTotal;

            // Afficher les résultats dans la console
            console.log("Nombre total de panneaux (sans entretoises): " + quantiteTotalePanneaux);
            console.log("Forfait logistique unitaire: " + forfaitLogistiqueUnitaire.toFixed(2) + " €");
            console.log("Forfait logistique total: " + forfaitLogistiqueTotal.toFixed(2) + " €");
            console.log("Forfait suivi unitaire: " + forfaitSuiviUnitaire.toFixed(2) + " €");
            console.log("Forfait suivi total: " + forfaitSuiviTotal.toFixed(2) + " €");
            console.log("Total des forfaits: " + forfaitTotal.toFixed(2) + " €");

            return {
                logistique: forfaitLogistiqueTotal,
                suivi: forfaitSuiviTotal,
                total: forfaitTotal
            };
        }

        /**
         * Calcule le forfait logistique unitaire en fonction de la quantité totale de panneaux
         *
         * @param {number} quantiteTotalePanneaux - Nombre total de panneaux
         * @return {number} Le montant du forfait logistique unitaire
         */
        function calculerForfaitLogistique(quantiteTotalePanneaux) {
            // Déterminer le forfait en fonction de la quantité
            if (quantiteTotalePanneaux <= 0) {
                return 0; // Pas de forfait si pas de panneaux
            } else if (quantiteTotalePanneaux <= 25) {
                return 213.78; // 0 à 25 panneaux
            } else if (quantiteTotalePanneaux <= 50) {
                return 187.06; // 26 à 50 panneaux
            } else if (quantiteTotalePanneaux <= 75) {
                return 160.34; // 51 à 75 panneaux
            } else {
                return 133.61; // Au-delà de 75 panneaux
            }
        }

        /**
         * Calcule le forfait suivi unitaire en fonction de la quantité totale de panneaux
         *
         * @param {number} quantiteTotalePanneaux - Nombre total de panneaux
         * @return {number} Le montant du forfait suivi unitaire
         */
        function calculerForfaitSuivi(quantiteTotalePanneaux) {
            // Déterminer le forfait en fonction de la quantité
            if (quantiteTotalePanneaux <= 0) {
                return 0; // Pas de forfait si pas de panneaux
            } else if (quantiteTotalePanneaux <= 25) {
                return 394.88; // 0 à 25 panneaux
            } else if (quantiteTotalePanneaux <= 50) {
                return 334.88; // 26 à 50 panneaux
            } else if (quantiteTotalePanneaux <= 75) {
                return 274.88; // 51 à 75 panneaux
            } else {
                return 214.87; // Au-delà de 75 panneaux
            }
        }

        /**
         * Calcule le prix des soudages de barreaux pour les panneaux supérieurs à St-Vallier
         * Cette fonction est appelée à chaque mise à jour du tableau récapitulatif
         *
         * @return {number} Le prix total des soudages de barreaux
         */
        function calculerPrixSoudageBarreaux() {
            console.log("=== DÉBUT DU CALCUL DU PRIX DE SOUDAGE DES BARREAUX ===");

            // Vérifier si nous avons des résultats dans le tableau récapitulatif
            if (!window.cumulativeResults || window.cumulativeResults.length === 0) {
                console.log("Prix soudage barreaux: 0 € (aucun panneau sélectionné)");
                return 0;
            }

            // Compteur pour les panneaux supérieurs de St-Vallier
            let nbPanneauxSupStVallier = 0;

            // Parcourir tous les panneaux dans le tableau récapitulatif
            window.cumulativeResults.forEach(result => {
                // IGNORER les options de transport et les entretoises
                if (result.isTransportOnly || result.isEntretoise) {
                    return; // Passer à l'élément suivant
                }

                // Vérifier si c'est un panneau sur le site St-Vallier
                const estStVallier = result.site &&
                    (result.site.toUpperCase().includes("SAINT VALLIER") ||
                        result.site.toUpperCase().includes("ST VALLIER") ||
                        result.site.toUpperCase().includes("ST-VALLIER"));

                // Vérifier si c'est un panneau supérieur
                const estPanneauSuperieur = result.description &&
                    (result.description.toLowerCase().includes("supérieur") ||
                        result.description.toLowerCase().includes("superieur"));

                // Si c'est un panneau supérieur à St-Vallier, ajouter sa quantité au compteur
                if (estStVallier && estPanneauSuperieur) {
                    const quantite = parseInt(result.quantity) || 0;
                    nbPanneauxSupStVallier += quantite;
                }
            });

            // Calculer le prix total des soudages de barreaux
            const prixUnitaireSoudage = 533.56;
            const prixTotalSoudage = nbPanneauxSupStVallier * prixUnitaireSoudage;

            // Afficher les résultats dans la console
            console.log("Nombre de panneaux supérieurs à St-Vallier: " + nbPanneauxSupStVallier);
            console.log("Prix unitaire du soudage de barreaux: " + prixUnitaireSoudage.toFixed(2) + " €");
            console.log("Prix total des soudages de barreaux: " + prixTotalSoudage.toFixed(2) + " €");
            console.log("=== FIN DU CALCUL DU PRIX DE SOUDAGE DES BARREAUX ===");

            return prixTotalSoudage;
        }

        /**
         * Calcule le prix du transport des barreaux pour chaque site
         * Cette fonction est appelée à chaque mise à jour du tableau récapitulatif
         *
         * @return {Object} Objet contenant les prix de transport par site et le prix total
         */
        /**
         * Calcule le prix du transport des barreaux pour chaque site
         * Cette fonction est appelée à chaque mise à jour du tableau récapitulatif
         *
         * @return {Object} Objet contenant les prix de transport par site et le prix total
         */
        function calculerPrixTransportBarreaux() {
            console.log("=== DÉBUT DU CALCUL DU PRIX DE TRANSPORT DES BARREAUX ===");

            // Vérifier si nous avons des résultats dans le tableau récapitulatif
            if (!window.cumulativeResults || window.cumulativeResults.length === 0) {
                console.log("Prix transport barreaux: 0 € (aucun panneau sélectionné)");
                return { total: 0, detailParSite: {} };
            }

            console.log("Nombre d'éléments dans le tableau récapitulatif:", window.cumulativeResults.length);
            console.log("Contenu du tableau récapitulatif:", JSON.stringify(window.cumulativeResults, null, 2));

            // Objet pour stocker les informations par site
            const sitesInfo = {};
            // Objet pour suivre les sites qui ont l'option de transport des barreaux activée
            const sitesAvecTransportBarreaux = {};

            // Vérifier d'abord quels sites ont l'option "transport barreaux" sur "oui"
            console.log("Recherche des sites avec option transport barreaux...");
            window.cumulativeResults.forEach((result, index) => {
                console.log(`Analyse de l'élément ${index}:`, result);

                if (!result.site) {
                    console.log("  Pas de site spécifié, ignoré");
                    return;
                }

                // Vérifier si l'élément a la propriété transportBarreaux
                if (result.transportBarreaux) {
                    console.log(`  Trouvé option transport barreaux pour le site ${result.site}: ${result.transportBarreaux}`);

                    // Vérifier si l'option est sur "oui"
                    const estTransportActive = result.transportBarreaux.toLowerCase() === "oui";

                    console.log(`  Option transport active: ${estTransportActive}`);

                    // Marquer ce site comme ayant l'option de transport activée
                    if (estTransportActive) {
                        sitesAvecTransportBarreaux[result.site] = true;
                    }
                }
            });

            console.log("Sites avec transport barreaux activé:", sitesAvecTransportBarreaux);

            // Pour chaque panneau, calculer le poids selon le type (inférieur/supérieur)
            console.log("Calcul des poids par site...");
            window.cumulativeResults.forEach((result, index) => {
                if (!result.site) {
                    console.log(`Élément ${index} sans site, ignoré`);
                    return;
                }

                // Ignorer l'élément s'il a isTransportOnly = true (c'est une option, pas un panneau)
                if (result.isTransportOnly) {
                    console.log(`Élément ${index} est une option de transport, ignoré pour le calcul de poids`);
                    return;
                }

                // Ignorer les sites qui n'ont pas l'option transport barreaux activée
                if (!sitesAvecTransportBarreaux[result.site]) {
                    console.log(`Site ${result.site} n'a pas l'option transport barreaux activée, ignoré`);
                    return;
                }

                console.log(`Analyse panneau ${index}:`, result);

                // Initialiser les infos du site si nécessaire
                if (!sitesInfo[result.site]) {
                    sitesInfo[result.site] = {
                        poidsTotal: 0,
                        nombrePanneauxInferieurs: 0,
                        nombrePanneauxSuperieurs: 0,
                        prixUnitaire: 0
                    };
                    console.log(`  Initialisation des infos pour le site ${result.site}`);
                }

                // Déterminer le prix unitaire selon le site
                sitesInfo[result.site].prixUnitaire = getPrixUnitaireTransport(result.site);
                console.log(`  Prix unitaire pour ${result.site}: ${sitesInfo[result.site].prixUnitaire} €`);

                // Vérifier si c'est un panneau (il doit avoir une description)
                if (!result.description) {
                    console.log(`  Pas de description, ignoré`);
                    return;
                }

                // Ignorer les entrées qui ne sont pas des panneaux
                if (!result.description.toLowerCase().includes("panneau")) {
                    console.log(`  Pas un panneau, ignoré`);
                    return;
                }

                // Déterminer si c'est un panneau inférieur ou supérieur
                const estPanneauSuperieur = result.description.toLowerCase().includes("supérieur") ||
                    result.description.toLowerCase().includes("superieur");

                const estPanneauInferieur = result.description.toLowerCase().includes("inférieur") ||
                    result.description.toLowerCase().includes("inferieur");

                console.log(`  Est panneau supérieur: ${estPanneauSuperieur}`);
                console.log(`  Est panneau inférieur: ${estPanneauInferieur}`);

                // Obtenir la quantité
                const quantite = parseInt(result.quantity) || 0;
                console.log(`  Quantité: ${quantite}`);

                // Calculer le poids et l'ajouter au poids total du site
                if (estPanneauSuperieur) {
                    sitesInfo[result.site].nombrePanneauxSuperieurs += quantite;
                    const poidsAjoute = quantite * 0.4284;
                    sitesInfo[result.site].poidsTotal += poidsAjoute;
                    console.log(`  Ajout de ${quantite} panneaux supérieurs (${poidsAjoute.toFixed(4)} tonnes)`);
                } else if (estPanneauInferieur) {
                    sitesInfo[result.site].nombrePanneauxInferieurs += quantite;
                    const poidsAjoute = quantite * 0.2676;
                    sitesInfo[result.site].poidsTotal += poidsAjoute;
                    console.log(`  Ajout de ${quantite} panneaux inférieurs (${poidsAjoute.toFixed(4)} tonnes)`);
                } else {
                    console.log(`  Type de panneau non identifié, ignoré`);
                }
            });

            console.log("Résumé des informations par site après calcul des poids:", sitesInfo);

            // Calculer le prix de transport pour chaque site et le prix total
            let prixTotalTransport = 0;
            const detailParSite = {};

            console.log("Calcul des prix de transport par site...");
            for (const site in sitesInfo) {
                const info = sitesInfo[site];
                console.log(`Calcul pour le site ${site}:`);

                // Calculer le nombre de camions nécessaires (arrondi à l'entier supérieur)
                const nombreCamions = Math.ceil(info.poidsTotal / 19);
                console.log(`  Poids total: ${info.poidsTotal.toFixed(4)} tonnes`);
                console.log(`  Nombre de camions nécessaires: ${nombreCamions}`);

                // Calculer le prix de transport pour ce site
                const prixTransportSite = nombreCamions * info.prixUnitaire;
                console.log(`  Prix unitaire: ${info.prixUnitaire.toFixed(2)} €`);
                console.log(`  Prix transport pour ce site: ${prixTransportSite.toFixed(2)} €`);

                // Ajouter au prix total
                prixTotalTransport += prixTransportSite;
                console.log(`  Prix total cumulé: ${prixTotalTransport.toFixed(2)} €`);

                // Stocker les détails pour ce site
                detailParSite[site] = {
                    nombrePanneauxInferieurs: info.nombrePanneauxInferieurs,
                    nombrePanneauxSuperieurs: info.nombrePanneauxSuperieurs,
                    poidsTotal: info.poidsTotal,
                    nombreCamions: nombreCamions,
                    prixUnitaire: info.prixUnitaire,
                    prixTransport: prixTransportSite
                };

                // Afficher les détails dans la console
                console.log(`Site: ${site}`);
                console.log(`  Panneaux inférieurs: ${info.nombrePanneauxInferieurs} (${(info.nombrePanneauxInferieurs * 0.2676).toFixed(4)} tonnes)`);
                console.log(`  Panneaux supérieurs: ${info.nombrePanneauxSuperieurs} (${(info.nombrePanneauxSuperieurs * 0.4284).toFixed(4)} tonnes)`);
                console.log(`  Poids total: ${info.poidsTotal.toFixed(4)} tonnes`);
                console.log(`  Nombre de camions: ${nombreCamions}`);
                console.log(`  Prix unitaire: ${info.prixUnitaire.toFixed(2)} €`);
                console.log(`  Prix transport: ${prixTransportSite.toFixed(2)} €`);
            }

            console.log(`Prix total du transport des barreaux: ${prixTotalTransport.toFixed(2)} €`);
            console.log("=== FIN DU CALCUL DU PRIX DE TRANSPORT DES BARREAUX ===");

            return {
                total: prixTotalTransport,
                detailParSite: detailParSite
            };
        }

        /**
         * Détermine le prix unitaire du transport selon le site
         *
         * @param {string} site - Nom du site
         * @return {number} Prix unitaire du transport
         */
        function getPrixUnitaireTransport(site) {
            const siteUpper = site.toUpperCase();

            // Groupe 1 (1545.60 €)
            if (siteUpper.includes("SEYSSEL") ||
                siteUpper.includes("CHAUTAGNE") ||
                siteUpper.includes("BELLEY") ||
                siteUpper.includes("BREGNIER-CORDON") ||
                siteUpper.includes("SAULT-BRENAZ")) {
                return 1545.60;
            }

            // Groupe 2 (1360.80 €)
            if (siteUpper.includes("PIERRE-BENITE") ||
                siteUpper.includes("VAUGRIS") ||
                siteUpper.includes("PEAGE DE ROUSSILLON") ||
                siteUpper.includes("SAINT VALLIER") ||
                siteUpper.includes("ST VALLIER") ||
                siteUpper.includes("ST-VALLIER")) {
                return 1360.80;
            }

            // Groupe 3 (1108.80 €)
            if (siteUpper.includes("BOURG-LES-VALENCE") ||
                siteUpper.includes("MONTELIMAR") ||
                siteUpper.includes("BEAUCHASTEL") ||
                siteUpper.includes("LOGIS-NEUF")) {
                return 1108.80;
            }

            // Groupe 4 (947.52 €)
            if (siteUpper.includes("DONZERE MONDRAGON") ||
                siteUpper.includes("AVIGNON") ||
                siteUpper.includes("SAUVETERRE") ||
                siteUpper.includes("CADEROUSSE") ||
                siteUpper.includes("VALLABREGUES")) {
                return 947.52;
            }

            // Par défaut, retourner le prix le plus bas
            return 947.52;
        }

        /**
         * Calcule le prix de la manutention pour chaque site
         * Cette fonction est appelée à chaque mise à jour du tableau récapitulatif
         *
         * @return {Object} Objet contenant les prix de manutention par site et le prix total
         */
        function calculerPrixManutention() {
            console.log("=== DÉBUT DU CALCUL DU PRIX DE MANUTENTION ===");

            // Vérifier si nous avons des résultats dans le tableau récapitulatif
            if (!window.cumulativeResults || window.cumulativeResults.length === 0) {
                console.log("Prix manutention: 0 € (aucun site avec manutention activée)");
                return { total: 0, detailParSite: {} };
            }

            console.log("Contenu du tableau récapitulatif:", JSON.stringify(window.cumulativeResults, null, 2));

            // Calculer le prix de la manutention pour chaque site
            let prixTotalManutention = 0;
            const detailParSite = {};

            // Parcourir tous les éléments dans le tableau récapitulatif
            window.cumulativeResults.forEach((result, index) => {
                // Ignorer les éléments qui ne sont pas des options de transport
                if (!result.isTransportOnly) {
                    return;
                }

                // Ignorer les sites qui n'ont pas l'option manutention activée
                if (result.manutention !== "oui" || !result.manutentionDays) {
                    return;
                }

                const site = result.site;
                const nbDemiJournees = parseInt(result.manutentionDays) || 0;

                if (nbDemiJournees <= 0) {
                    return;
                }

                // Déterminer le prix unitaire selon le site
                const prixUnitaire = getPrixUnitaireManutention(site);
                console.log(`Site ${site}: prix unitaire manutention = ${prixUnitaire} €`);

                // Calculer le prix de manutention pour ce site
                const prixManutentionSite = nbDemiJournees * prixUnitaire;
                console.log(`Site ${site}: ${nbDemiJournees} demi-journée(s) * ${prixUnitaire} € = ${prixManutentionSite} €`);

                // Ajouter au prix total
                prixTotalManutention += prixManutentionSite;

                // Stocker les détails pour ce site
                detailParSite[site] = {
                    nbDemiJournees: nbDemiJournees,
                    prixUnitaire: prixUnitaire,
                    prixManutention: prixManutentionSite
                };
            });

            console.log(`Prix total de la manutention: ${prixTotalManutention.toFixed(2)} €`);
            console.log("=== FIN DU CALCUL DU PRIX DE MANUTENTION ===");

            return {
                total: prixTotalManutention,
                detailParSite: detailParSite
            };
        }

        /**
         * Détermine le prix unitaire de la manutention selon le site
         *
         * @param {string} site - Nom du site
         * @return {number} Prix unitaire de la manutention
         */
        function getPrixUnitaireManutention(site) {
            const siteUpper = site.toUpperCase();

            // Groupe 1 (1467.84 €)
            if (siteUpper.includes("SEYSSEL") ||
                siteUpper.includes("CHAUTAGNE") ||
                siteUpper.includes("BELLEY") ||
                siteUpper.includes("BREGNIER-CORDON") ||
                siteUpper.includes("SAULT-BRENAZ")) {
                return 1467.84;
            }

            // Groupe 2 (829.34 €)
            if (siteUpper.includes("PIERRE-BENITE") ||
                siteUpper.includes("VAUGRIS") ||
                siteUpper.includes("PEAGE DE ROUSSILLON") ||
                siteUpper.includes("SAINT VALLIER") ||
                siteUpper.includes("ST VALLIER") ||
                siteUpper.includes("ST-VALLIER")) {
                return 829.34;
            }

            // Groupe 3 (721.57 €)
            if (siteUpper.includes("BOURG-LES-VALENCE") ||
                siteUpper.includes("MONTELIMAR") ||
                siteUpper.includes("BEAUCHASTEL") ||
                siteUpper.includes("LOGIS-NEUF")) {
                return 721.57;
            }

            // Groupe 4 (584.60 €)
            if (siteUpper.includes("DONZERE MONDRAGON") ||
                siteUpper.includes("AVIGNON") ||
                siteUpper.includes("SAUVETERRE") ||
                siteUpper.includes("CADEROUSSE") ||
                siteUpper.includes("VALLABREGUES")) {
                return 584.60;
            }

            // Par défaut, retourner le prix le plus bas
            return 584.60;
        }

        /**
         * Calcule le prix du grutage et l'ajoute au prix total de la manutention
         * Cette fonction est appelée après calculerPrixManutention()
         *
         * @return {Object} Objet contenant les prix de grutage par site et le prix total
         */
        function calculerPrixGrutage() {
            console.log("=== DÉBUT DU CALCUL DU PRIX DE GRUTAGE ===");

            // Vérifier si nous avons des résultats dans le tableau récapitulatif
            if (!window.cumulativeResults || window.cumulativeResults.length === 0) {
                console.log("Prix grutage: 0 € (aucun site avec grutage activé)");
                return { total: 0, detailParSite: {} };
            }

            // Calculer le prix du grutage pour chaque site
            let prixTotalGrutage = 0;
            const detailParSite = {};

            // Parcourir tous les éléments dans le tableau récapitulatif
            window.cumulativeResults.forEach((result, index) => {
                // Ignorer les éléments qui ne sont pas des options de transport
                if (!result.isTransportOnly) {
                    return;
                }

                // Vérifier si l'option de déchargement (grutage) est activée
                if (result.dechargement !== "oui") {
                    return;
                }

                const site = result.site;

                // Pour le grutage, on utilise le même nombre de demi-journées que pour la manutention si elle est activée
                // Sinon, on considère une demi-journée par défaut
                let nbDemiJournees = 1;
                if (result.manutention === "oui" && result.manutentionDays) {
                    nbDemiJournees = parseInt(result.manutentionDays) || 1;
                }

                // Le prix unitaire du grutage est fixe: 882 €
                const prixUnitaireGrutage = 882;

                // Calculer le prix du grutage pour ce site
                const prixGrutageSite = nbDemiJournees * prixUnitaireGrutage;
                console.log(`Site ${site}: ${nbDemiJournees} demi-journée(s) * ${prixUnitaireGrutage} € = ${prixGrutageSite} €`);

                // Ajouter au prix total
                prixTotalGrutage += prixGrutageSite;

                // Stocker les détails pour ce site
                detailParSite[site] = {
                    nbDemiJournees: nbDemiJournees,
                    prixUnitaire: prixUnitaireGrutage,
                    prixGrutage: prixGrutageSite
                };
            });

            console.log(`Prix total du grutage: ${prixTotalGrutage.toFixed(2)} €`);
            console.log("=== FIN DU CALCUL DU PRIX DE GRUTAGE ===");

            return {
                total: prixTotalGrutage,
                detailParSite: detailParSite
            };
        }

        /**
         * Calcule le prix total en additionnant tous les prix calculés
         * Cette fonction est appelée après tous les autres calculs
         *
         * @return {Object} Objet contenant les détails de tous les prix et le prix total
         */
        function calculerPrixTotal() {
            console.log("=== DÉBUT DU CALCUL DU PRIX TOTAL (avec entretoises) ===");

            // Calculer tous les prix existants
            let prixForfaits = 0;
            try {
                const resultForfaits = calculerEtAfficherForfaits();
                prixForfaits = resultForfaits.total || 0;
            } catch (error) {
                console.error("Erreur lors du calcul des forfaits:", error);
            }

            let prixSoudage = 0;
            try {
                prixSoudage = calculerPrixSoudageBarreaux() || 0;
            } catch (error) {
                console.error("Erreur lors du calcul du prix des soudages de barreaux:", error);
            }

            let prixTransportBarreaux = 0;
            try {
                const resultTransport = calculerPrixTransportBarreaux();
                prixTransportBarreaux = resultTransport.total || 0;
            } catch (error) {
                console.error("Erreur lors du calcul du prix du transport des barreaux:", error);
            }

            let prixTransportPanneaux = 0;
            try {
                const resultTransportPanneaux = calculerPrixTransportPanneaux();
                prixTransportPanneaux = resultTransportPanneaux.total || 0;
            } catch (error) {
                console.error("Erreur lors du calcul du prix du transport des panneaux:", error);
            }

            let prixManutention = 0;
            try {
                const resultManutention = calculerPrixManutention();
                prixManutention = resultManutention.total || 0;
            } catch (error) {
                console.error("Erreur lors du calcul du prix de la manutention des barreaux:", error);
            }

            let prixManutentionPanneaux = 0;
            try {
                const resultManutentionPanneaux = calculerPrixManutentionPanneaux();
                prixManutentionPanneaux = resultManutentionPanneaux.total || 0;
            } catch (error) {
                console.error("Erreur lors du calcul du prix de la manutention des panneaux:", error);
            }

            let prixGrutage = 0;
            try {
                const resultGrutage = calculerPrixGrutage();
                prixGrutage = resultGrutage.total || 0;
            } catch (error) {
                console.error("Erreur lors du calcul du prix du grutage des barreaux:", error);
            }

            let prixGrutagePanneaux = 0;
            try {
                const resultGrutagePanneaux = calculerPrixGrutagePanneaux();
                prixGrutagePanneaux = resultGrutagePanneaux.total || 0;
            } catch (error) {
                console.error("Erreur lors du calcul du prix du grutage des panneaux:", error);
            }

            let prixEmballage = 0;
            try {
                prixEmballage = calculerPrixEmballage() || 0;
            } catch (error) {
                console.error("Erreur lors du calcul du prix d'emballage:", error);
            }

            let prixMontage = 0;
            try {
                prixMontage = calculerPrixMontage() || 0;
            } catch (error) {
                console.error("Erreur lors du calcul du prix de montage des panneaux:", error);
            }

            // NOUVEAU: Calculer le prix total des entretoises
            let prixEntretoises = 0;
            try {
                prixEntretoises = calculerPrixEntretoises() || 0;
            } catch (error) {
                console.error("Erreur lors du calcul du prix des entretoises:", error);
            }

            // Calculer le prix total en incluant les entretoises
            const prixTotal = prixForfaits + prixSoudage +
                prixTransportBarreaux + prixTransportPanneaux +
                prixManutention + prixManutentionPanneaux +
                prixGrutage + prixGrutagePanneaux +
                prixEmballage + prixMontage + prixEntretoises;

            console.log("Détail des prix:");
            console.log(`- Forfaits (logistique et suivi): ${prixForfaits.toFixed(2)} €`);
            console.log(`- Soudage des barreaux: ${prixSoudage.toFixed(2)} €`);
            console.log(`- Transport des barreaux: ${prixTransportBarreaux.toFixed(2)} €`);
            console.log(`- Transport des panneaux: ${prixTransportPanneaux.toFixed(2)} €`);
            console.log(`- Manutention des barreaux: ${prixManutention.toFixed(2)} €`);
            console.log(`- Manutention des panneaux: ${prixManutentionPanneaux.toFixed(2)} €`);
            console.log(`- Grutage des barreaux: ${prixGrutage.toFixed(2)} €`);
            console.log(`- Grutage des panneaux: ${prixGrutagePanneaux.toFixed(2)} €`);
            console.log(`- Emballage: ${prixEmballage.toFixed(2)} €`);
            console.log(`- Montage des panneaux: ${prixMontage.toFixed(2)} €`);
            console.log(`- ENTRETOISES: ${prixEntretoises.toFixed(2)} €`);  // NOUVEAU
            console.log(`PRIX TOTAL: ${prixTotal.toFixed(2)} €`);
            console.log("=== FIN DU CALCUL DU PRIX TOTAL ===");

            return {
                prixForfaits: prixForfaits,
                prixSoudage: prixSoudage,
                prixTransportBarreaux: prixTransportBarreaux,
                prixTransportPanneaux: prixTransportPanneaux,
                prixManutention: prixManutention,
                prixManutentionPanneaux: prixManutentionPanneaux,
                prixGrutage: prixGrutage,
                prixGrutagePanneaux: prixGrutagePanneaux,
                prixEmballage: prixEmballage,
                prixMontage: prixMontage,
                prixEntretoises: prixEntretoises,  // NOUVEAU
                prixTotal: prixTotal
            };
        }

        /**
         * Calcule le prix total de toutes les entretoises dans le tableau récapitulatif
         * @return {number} Prix total des entretoises
         */
        function calculerPrixEntretoises() {
            console.log("=== DÉBUT DU CALCUL DU PRIX DES ENTRETOISES ===");

            if (!window.cumulativeResults || window.cumulativeResults.length === 0) {
                console.log("Prix entretoises: 0 € (aucune entretoise sélectionnée)");
                return 0;
            }

            let prixTotalEntretoises = 0;

            // Parcourir tous les éléments du tableau récapitulatif
            window.cumulativeResults.forEach((result, index) => {
                // Ne traiter que les entretoises
                if (result.isEntretoise && result.totalPrice) {
                    const prixEntretoise = parseFloat(result.totalPrice) || 0;
                    prixTotalEntretoises += prixEntretoise;

                    console.log(`Entretoise ${index}: ${result.description} - ${prixEntretoise.toFixed(2)} €`);
                }
            });

            console.log(`Prix total des entretoises: ${prixTotalEntretoises.toFixed(2)} €`);
            console.log("=== FIN DU CALCUL DU PRIX DES ENTRETOISES ===");

            return prixTotalEntretoises;
        }


        /**
         * Calcule le prix du transport des panneaux pour chaque site
         * Cette fonction est appelée à chaque mise à jour du tableau récapitulatif
         *
         * @return {Object} Objet contenant les prix de transport des panneaux par site et le prix total
         */
        function calculerPrixTransportPanneaux() {
            console.log("=== DÉBUT DU CALCUL DU PRIX DE TRANSPORT DES PANNEAUX ===");

            // Vérifier si nous avons des résultats dans le tableau récapitulatif
            if (!window.cumulativeResults || window.cumulativeResults.length === 0) {
                console.log("Prix transport panneaux: 0 € (aucun panneau sélectionné)");
                return { total: 0, detailParSite: {} };
            }

            console.log("Nombre d'éléments dans le tableau récapitulatif:", window.cumulativeResults.length);

            // Objet pour stocker les informations par site
            const sitesInfo = {};
            // Objet pour suivre les sites qui ont l'option de transport des panneaux activée
            const sitesAvecTransportPanneaux = {};

            // Vérifier d'abord quels sites ont l'option "transport panneaux" sur "oui"
            console.log("Recherche des sites avec option transport panneaux...");
            window.cumulativeResults.forEach((result) => {
                if (!result.site) {
                    return;
                }

                // Vérifier si l'élément a la propriété transportPanneaux
                if (result.transportPanneaux) {
                    console.log(`Trouvé option transport panneaux pour le site ${result.site}: ${result.transportPanneaux}`);

                    // Vérifier si l'option est sur "oui"
                    const estTransportActive = result.transportPanneaux.toLowerCase() === "oui";
                    console.log(`Option transport panneaux active: ${estTransportActive}`);

                    // Marquer ce site comme ayant l'option de transport activée
                    if (estTransportActive) {
                        sitesAvecTransportPanneaux[result.site] = true;
                    }
                }
            });

            console.log("Sites avec transport panneaux activé:", sitesAvecTransportPanneaux);

            // Pour chaque panneau, compter la quantité par site
            console.log("Calcul des quantités par site...");
            window.cumulativeResults.forEach((result) => {
                if (!result.site) {
                    return;
                }

                // Ignorer l'élément s'il a isTransportOnly = true (c'est une option, pas un panneau)
                if (result.isTransportOnly) {
                    return;
                }

                // Ignorer les sites qui n'ont pas l'option transport panneaux activée
                if (!sitesAvecTransportPanneaux[result.site]) {
                    return;
                }

                // Vérifier si c'est un panneau (il doit avoir une description)
                if (!result.description) {
                    return;
                }

                // Ignorer les entrées qui ne sont pas des panneaux
                if (!result.description.toLowerCase().includes("panneau")) {
                    return;
                }

                // Initialiser les infos du site si nécessaire
                if (!sitesInfo[result.site]) {
                    sitesInfo[result.site] = {
                        quantiteTotale: 0,
                        prixUnitaire: 0
                    };
                }

                // Déterminer le prix unitaire selon le site
                sitesInfo[result.site].prixUnitaire = getPrixUnitaireTransport(result.site);

                // Obtenir la quantité
                const quantite = parseInt(result.quantity) || 0;
                console.log(`Site ${result.site}: Panneau "${result.description}" - Quantité: ${quantite}`);

                // Ajouter à la quantité totale du site
                sitesInfo[result.site].quantiteTotale += quantite;
            });

            console.log("Résumé des informations par site après calcul des quantités:", sitesInfo);

            // Calculer le prix de transport pour chaque site et le prix total
            let prixTotalTransport = 0;
            const detailParSite = {};

            console.log("Calcul des prix de transport par site...");
            for (const site in sitesInfo) {
                const info = sitesInfo[site];
                console.log(`Calcul pour le site ${site}:`);

                // Calculer le nombre de camions nécessaires (arrondi à l'entier supérieur)
                const nombreCamions = Math.ceil(info.quantiteTotale / 5);
                console.log(`Quantité totale: ${info.quantiteTotale} panneaux`);
                console.log(`Nombre de camions nécessaires (quantité/5): ${nombreCamions}`);

                // Calculer le prix de transport pour ce site
                const prixTransportSite = nombreCamions * info.prixUnitaire;
                console.log(`Prix unitaire: ${info.prixUnitaire.toFixed(2)} €`);
                console.log(`Prix transport pour ce site: ${prixTransportSite.toFixed(2)} €`);

                // Ajouter au prix total
                prixTotalTransport += prixTransportSite;

                // Stocker les détails pour ce site
                detailParSite[site] = {
                    quantiteTotale: info.quantiteTotale,
                    nombreCamions: nombreCamions,
                    prixUnitaire: info.prixUnitaire,
                    prixTransport: prixTransportSite
                };
            }

            console.log(`Prix total du transport des panneaux: ${prixTotalTransport.toFixed(2)} €`);
            console.log("=== FIN DU CALCUL DU PRIX DE TRANSPORT DES PANNEAUX ===");

            return {
                total: prixTotalTransport,
                detailParSite: detailParSite
            };
        }

        /**
         * Calcule le prix de la manutention des panneaux pour chaque site
         * Cette fonction est appelée à chaque mise à jour du tableau récapitulatif
         *
         * @return {Object} Objet contenant les prix de manutention des panneaux par site et le prix total
         */
        function calculerPrixManutentionPanneaux() {
            console.log("=== DÉBUT DU CALCUL DU PRIX DE MANUTENTION DES PANNEAUX ===");

            // Vérifier si nous avons des résultats dans le tableau récapitulatif
            if (!window.cumulativeResults || window.cumulativeResults.length === 0) {
                console.log("Prix manutention panneaux: 0 € (aucun site avec manutention panneaux activée)");
                return { total: 0, detailParSite: {} };
            }

            // Objet pour stocker les informations par site
            const sitesInfo = {};
            // Objet pour suivre les sites qui ont l'option de manutention des panneaux activée
            const sitesAvecManutentionPanneaux = {};

            // Vérifier d'abord quels sites ont l'option "manutention panneaux" sur "oui"
            console.log("Recherche des sites avec option manutention panneaux...");
            window.cumulativeResults.forEach((result) => {
                if (!result.site) {
                    return;
                }

                // Vérifier si l'élément a les propriétés nécessaires
                if (result.isTransportOnly && result.transportPanneaux && result.manutentionPanneaux) {
                    console.log(`Trouvé options pour le site ${result.site}: transport panneaux = ${result.transportPanneaux}, manutention panneaux = ${result.manutentionPanneaux}`);

                    // Ne traiter que les sites avec transport panneaux et manutention panneaux sur "oui"
                    if (result.transportPanneaux.toLowerCase() === "oui" && result.manutentionPanneaux.toLowerCase() === "oui") {
                        console.log(`Option manutention panneaux active pour le site ${result.site}`);
                        sitesAvecManutentionPanneaux[result.site] = true;
                    }
                }
            });

            console.log("Sites avec manutention panneaux activée:", sitesAvecManutentionPanneaux);

            // Si aucun site n'a l'option manutention panneaux activée, retourner 0
            if (Object.keys(sitesAvecManutentionPanneaux).length === 0) {
                console.log("Aucun site avec manutention panneaux activée");
                return { total: 0, detailParSite: {} };
            }

            // Calculer la quantité de panneaux par site pour déterminer le nombre de camions
            console.log("Calcul des quantités par site...");
            window.cumulativeResults.forEach((result) => {
                if (!result.site || result.isTransportOnly) {
                    return;
                }

                // Ignorer les sites qui n'ont pas l'option manutention panneaux activée
                if (!sitesAvecManutentionPanneaux[result.site]) {
                    return;
                }

                // Vérifier si c'est un panneau (il doit avoir une description)
                if (!result.description || !result.description.toLowerCase().includes("panneau")) {
                    return;
                }

                // Initialiser les infos du site si nécessaire
                if (!sitesInfo[result.site]) {
                    sitesInfo[result.site] = {
                        quantiteTotale: 0,
                        prixUnitaire: getPrixUnitaireManutention(result.site)
                    };
                }

                // Obtenir la quantité
                const quantite = parseInt(result.quantity) || 0;
                console.log(`Site ${result.site}: Panneau "${result.description}" - Quantité: ${quantite}`);

                // Ajouter à la quantité totale du site
                sitesInfo[result.site].quantiteTotale += quantite;
            });

            console.log("Résumé des informations par site après calcul des quantités:", sitesInfo);

            // Calculer le prix de manutention pour chaque site et le prix total
            let prixTotalManutention = 0;
            const detailParSite = {};

            console.log("Calcul des prix de manutention par site...");
            for (const site in sitesInfo) {
                const info = sitesInfo[site];
                console.log(`Calcul pour le site ${site}:`);

                // Calculer le nombre de camions nécessaires (arrondi à l'entier supérieur)
                const nombreCamions = Math.ceil(info.quantiteTotale / 5);
                console.log(`Quantité totale: ${info.quantiteTotale} panneaux`);
                console.log(`Nombre de camions (demi-journées): ${nombreCamions}`);

                // Calculer le prix de manutention pour ce site
                const prixManutentionSite = nombreCamions * info.prixUnitaire;
                console.log(`Prix unitaire manutention: ${info.prixUnitaire.toFixed(2)} €`);
                console.log(`Prix manutention pour ce site: ${prixManutentionSite.toFixed(2)} €`);

                // Ajouter au prix total
                prixTotalManutention += prixManutentionSite;

                // Stocker les détails pour ce site
                detailParSite[site] = {
                    quantiteTotale: info.quantiteTotale,
                    nombreCamions: nombreCamions,
                    prixUnitaire: info.prixUnitaire,
                    prixManutention: prixManutentionSite
                };
            }

            console.log(`Prix total de la manutention des panneaux: ${prixTotalManutention.toFixed(2)} €`);
            console.log("=== FIN DU CALCUL DU PRIX DE MANUTENTION DES PANNEAUX ===");

            return {
                total: prixTotalManutention,
                detailParSite: detailParSite
            };
        }

        /**
         * Calcule le prix du grutage des panneaux
         * Cette fonction est appelée à chaque mise à jour du tableau récapitulatif
         *
         * @return {Object} Objet contenant les prix de grutage des panneaux par site et le prix total
         */
        function calculerPrixGrutagePanneaux() {
            console.log("=== DÉBUT DU CALCUL DU PRIX DE GRUTAGE DES PANNEAUX ===");

            // Vérifier si nous avons des résultats dans le tableau récapitulatif
            if (!window.cumulativeResults || window.cumulativeResults.length === 0) {
                console.log("Prix grutage panneaux: 0 € (aucun site avec grutage panneaux activé)");
                return { total: 0, detailParSite: {} };
            }

            // Objet pour stocker les informations par site
            const sitesInfo = {};
            // Objet pour suivre les sites qui ont l'option de grutage des panneaux activée
            const sitesAvecGrutagePanneaux = {};

            // Vérifier d'abord quels sites ont l'option "grutage panneaux" sur "oui"
            console.log("Recherche des sites avec option grutage panneaux...");
            window.cumulativeResults.forEach((result) => {
                if (!result.site) {
                    return;
                }

                // Vérifier si l'élément a les propriétés nécessaires
                if (result.isTransportOnly && result.transportPanneaux && result.manutentionPanneaux && result.grutagePanneaux) {
                    console.log(`Trouvé options pour le site ${result.site}: transport panneaux = ${result.transportPanneaux}, manutention panneaux = ${result.manutentionPanneaux}, grutage panneaux = ${result.grutagePanneaux}`);

                    // Ne traiter que les sites avec transport panneaux, manutention panneaux et grutage panneaux sur "oui"
                    if (result.transportPanneaux.toLowerCase() === "oui" &&
                        result.manutentionPanneaux.toLowerCase() === "oui" &&
                        result.grutagePanneaux.toLowerCase() === "oui") {

                        console.log(`Option grutage panneaux active pour le site ${result.site}`);
                        sitesAvecGrutagePanneaux[result.site] = true;
                    }
                }
            });

            console.log("Sites avec grutage panneaux activé:", sitesAvecGrutagePanneaux);

            // Si aucun site n'a l'option grutage panneaux activée, retourner 0
            if (Object.keys(sitesAvecGrutagePanneaux).length === 0) {
                console.log("Aucun site avec grutage panneaux activé");
                return { total: 0, detailParSite: {} };
            }

            // Calculer la quantité de panneaux par site pour déterminer le nombre de camions (demi-journées)
            console.log("Calcul des quantités par site...");
            window.cumulativeResults.forEach((result) => {
                if (!result.site || result.isTransportOnly) {
                    return;
                }

                // Ignorer les sites qui n'ont pas l'option grutage panneaux activée
                if (!sitesAvecGrutagePanneaux[result.site]) {
                    return;
                }

                // Vérifier si c'est un panneau (il doit avoir une description)
                if (!result.description || !result.description.toLowerCase().includes("panneau")) {
                    return;
                }

                // Initialiser les infos du site si nécessaire
                if (!sitesInfo[result.site]) {
                    sitesInfo[result.site] = {
                        quantiteTotale: 0,
                        prixUnitaireGrutage: 882 // Prix fixe pour le grutage: 882 €
                    };
                }

                // Obtenir la quantité
                const quantite = parseInt(result.quantity) || 0;

                // Ajouter à la quantité totale du site
                sitesInfo[result.site].quantiteTotale += quantite;
            });

            console.log("Résumé des informations par site après calcul des quantités:", sitesInfo);

            // Calculer le prix de grutage pour chaque site et le prix total
            let prixTotalGrutage = 0;
            const detailParSite = {};

            console.log("Calcul des prix de grutage par site...");
            for (const site in sitesInfo) {
                const info = sitesInfo[site];
                console.log(`Calcul pour le site ${site}:`);

                // Calculer le nombre de camions nécessaires (arrondi à l'entier supérieur)
                const nombreCamions = Math.ceil(info.quantiteTotale / 5);
                console.log(`Quantité totale: ${info.quantiteTotale} panneaux`);
                console.log(`Nombre de camions (demi-journées): ${nombreCamions}`);

                // Calculer le prix de grutage pour ce site
                const prixGrutageSite = nombreCamions * info.prixUnitaireGrutage;
                console.log(`Prix unitaire grutage: ${info.prixUnitaireGrutage.toFixed(2)} €`);
                console.log(`Prix grutage pour ce site: ${prixGrutageSite.toFixed(2)} €`);

                // Ajouter au prix total
                prixTotalGrutage += prixGrutageSite;

                // Stocker les détails pour ce site
                detailParSite[site] = {
                    quantiteTotale: info.quantiteTotale,
                    nombreCamions: nombreCamions,
                    prixUnitaire: info.prixUnitaireGrutage,
                    prixGrutage: prixGrutageSite
                };
            }

            console.log(`Prix total du grutage des panneaux: ${prixTotalGrutage.toFixed(2)} €`);
            console.log("=== FIN DU CALCUL DU PRIX DE GRUTAGE DES PANNEAUX ===");

            return {
                total: prixTotalGrutage,
                detailParSite: detailParSite
            };
        }

        /**
         * Calcule le prix de l'emballage pour tous les panneaux
         * Cette fonction est appelée à chaque mise à jour du tableau récapitulatif
         *
         * @return {number} Le prix total de l'emballage
         */
        function calculerPrixEmballage() {
            console.log("=== DÉBUT DU CALCUL DU PRIX D'EMBALLAGE ===");

            // Vérifier si l'option emballage est activée
            let emballageActive = false;

            // Parcourir tous les éléments dans le tableau récapitulatif pour trouver si l'emballage est activé
            if (window.cumulativeResults) {
                for (const result of window.cumulativeResults) {
                    if (result.isTransportOnly && result.emballage === "oui") {
                        emballageActive = true;
                        break;
                    }
                }
            }

            // Si l'emballage n'est pas activé, retourner 0
            if (!emballageActive) {
                console.log("Prix emballage: 0 € (option non activée)");
                return 0;
            }

            // Calculer la quantité totale de panneaux SEULEMENT (pas les entretoises)
            let quantiteTotalePanneaux = 0;

            if (window.cumulativeResults) {
                for (const result of window.cumulativeResults) {
                    // NE COMPTER QUE LES PANNEAUX (ignorer les options et les entretoises)
                    if (!result.isTransportOnly && !result.isEntretoise && result.quantity) {
                        quantiteTotalePanneaux += parseInt(result.quantity, 10);
                    }
                }
            }

            // Prix unitaire de l'emballage
            const prixUnitaireEmballage = 235.94;

            // Calculer le prix total d'emballage
            const prixTotalEmballage = quantiteTotalePanneaux * prixUnitaireEmballage;

            console.log(`Nombre total de panneaux (sans entretoises): ${quantiteTotalePanneaux}`);
            console.log(`Prix unitaire de l'emballage: ${prixUnitaireEmballage.toFixed(2)} €`);
            console.log(`Prix total de l'emballage: ${prixTotalEmballage.toFixed(2)} €`);
            console.log("=== FIN DU CALCUL DU PRIX D'EMBALLAGE ===");

            return prixTotalEmballage;
        }

        /**
         * Calcule le prix du montage des panneaux
         * Cette fonction est appelée à chaque mise à jour du tableau récapitulatif
         *
         * @return {number} Le prix total du montage des panneaux
         */
        function calculerPrixMontage() {
            console.log("=== DÉBUT DU CALCUL DU PRIX DE MONTAGE ===");

            // Vérifier si nous avons des résultats dans le tableau récapitulatif
            if (!window.cumulativeResults || window.cumulativeResults.length === 0) {
                console.log("Prix montage: 0 € (aucun panneau sélectionné)");
                return 0;
            }

            let prixTotalMontage = 0;

            // Parcourir tous les panneaux dans le tableau récapitulatif
            window.cumulativeResults.forEach((result) => {
                // Ignorer les lignes qui sont des options de transport
                if (result.isTransportOnly) {
                    return;
                }

                // Vérifier si c'est un panneau (il doit avoir une description)
                if (!result.description || !result.description.toLowerCase().includes("panneau")) {
                    return;
                }

                // Récupérer la quantité et le prix unitaire (totalPrice contient déjà le sous-total multiplié par la quantité)
                const quantite = parseInt(result.quantity) || 0;
                const sousTotal = result.totalPrice || 0;

                console.log(`Panneau "${result.description}" - Quantité: ${quantite}, Prix: ${sousTotal.toFixed(2)} €`);

                // Ajouter au prix total de montage
                prixTotalMontage += sousTotal;
            });

            console.log(`Prix total du montage des panneaux: ${prixTotalMontage.toFixed(2)} €`);
            console.log("=== FIN DU CALCUL DU PRIX DE MONTAGE ===");

            return prixTotalMontage;
        }

        /**
         * Nettoie le nom de l'entretoise pour la recherche dans le BPU
         * @param {string} entretoiseName - Nom original de l'entretoise
         * @return {string} Nom nettoyé pour la recherche
         */
        /**
         * Version améliorée du nettoyage des noms d'entretoises
         * Gère tous les types de préfixes possibles
         */
        function cleanEntretoiseName(entretoiseName) {
            if (!entretoiseName) return '';

            let cleaned = entretoiseName.trim();
            console.log(`Nettoyage initial: "${entretoiseName}"`);

            // Liste étendue des préfixes à enlever (du plus long au plus court pour éviter les conflits)
            const prefixesToRemove = [
                'ENTRETOISE ',
                'ECROU ',
                'PLAQUE ',
                'BISAUTEE ',
                'BISAUTÉE ',
                'TIRANT ',
                'CAPOT ',
                'BARREAU ',
                'ENT ',
                'ENT.',
                'PL ',
                'PL.',
                'ECR ',
                'ECR.',
                // Ajout de combinaisons communes
                'PLAQUE BISAUTEE ',
                'PLAQUE BISAUTÉE ',
                'ECROU PLAQUE ',
                'TIRANT CAPOT ',
                'CAPOT BARREAU '
            ];

            // Nettoyer de manière itérative jusqu'à ce qu'aucun préfixe ne soit trouvé
            let previousCleaned = '';
            let iterations = 0;
            const maxIterations = 10; // Éviter les boucles infinies

            while (cleaned !== previousCleaned && iterations < maxIterations) {
                previousCleaned = cleaned;
                iterations++;

                console.log(`  Itération ${iterations}: "${cleaned}"`);

                // Essayer d'enlever chaque préfixe
                for (const prefix of prefixesToRemove) {
                    const upperCleaned = cleaned.toUpperCase();
                    const upperPrefix = prefix.toUpperCase();

                    if (upperCleaned.startsWith(upperPrefix)) {
                        const newCleaned = cleaned.substring(prefix.length).trim();
                        if (newCleaned.length > 0) { // S'assurer qu'il reste quelque chose
                            cleaned = newCleaned;
                            console.log(`    Préfixe "${prefix.trim()}" enlevé → "${cleaned}"`);
                            break; // Recommencer depuis le début après chaque modification
                        }
                    }
                }
            }

            // Nettoyage final : enlever les espaces multiples et caractères spéciaux en début/fin
            cleaned = cleaned.replace(/\s+/g, ' ').trim();

            console.log(`Nettoyage final: "${entretoiseName}" → "${cleaned}"`);
            return cleaned;
        }

        /**
         * Version alternative avec regex pour les cas complexes
         */
        function cleanEntretoiseNameAdvanced(entretoiseName) {
            if (!entretoiseName) return '';

            let cleaned = entretoiseName.trim();
            console.log(`Nettoyage avancé initial: "${entretoiseName}"`);

            // Patterns regex pour identifier et extraire la partie principale
            const extractionPatterns = [
                // Pattern pour capturer des codes alphanumériques (ex: "AZD 14", "DARC 2C")
                /([A-Z]+\s*\d+[A-Z]*)/i,
                /([A-Z]{2,}\s*[A-Z0-9]+)/i,
                // Pattern pour capturer des références avec espaces
                /([A-Z]+\s+[A-Z0-9]+\s*[A-Z]*)/i,
                // Pattern pour capturer tout après le dernier préfixe connu
                /(?:ENTRETOISE|ECROU|PLAQUE|BISAUTEE|BISAUTÉE|TIRANT|CAPOT|BARREAU)\s+(.+)/i
            ];

            // Essayer chaque pattern
            for (const pattern of extractionPatterns) {
                const match = cleaned.match(pattern);
                if (match && match[1]) {
                    const extracted = match[1].trim();
                    if (extracted.length >= 3) { // Minimum 3 caractères pour être valide
                        console.log(`Pattern trouvé: "${pattern}" → "${extracted}"`);
                        cleaned = extracted;
                        break;
                    }
                }
            }

            // Si aucun pattern ne fonctionne, utiliser la méthode traditionnelle
            if (cleaned === entretoiseName.trim()) {
                cleaned = cleanEntretoiseName(entretoiseName);
            }

            console.log(`Nettoyage avancé final: "${entretoiseName}" → "${cleaned}"`);
            return cleaned;
        }


        /**
         * Recherche le prix d'une entretoise dans le BPU pour un site donné
         * @param {string} entretoiseName - Nom de l'entretoise à rechercher (ex: "DARC 2C")
         * @param {string} siteName - Nom du site pour lequel chercher le prix
         * @return {number|null} Le prix de l'entretoise ou null si non trouvé
         */
        function getEntretoisePrice(entretoiseName, siteName) {
            console.log(`=== RECHERCHE PRIX ENTRETOISE ===`);
            console.log(`Entretoise: "${entretoiseName}", Site: "${siteName}"`);

            // Nettoyer le nom de l'entretoise
            const cleanedEntretoiseName = cleanEntretoiseNameAdvanced(entretoiseName);
            console.log(`Nom nettoyé: "${cleanedEntretoiseName}"`);

            // [Le code de recherche reste identique...]
            // Vérifier que les données BPU sont disponibles
            if (!filesDataGlobal || !filesDataGlobal.file1 || !filesDataGlobal.file1.data) {
                console.warn("Données BPU non disponibles");
                return null;
            }

            // Récupérer les données de la première (et unique) feuille du BPU
            const bpuData = filesDataGlobal.file1.data;
            const firstSheetName = Object.keys(bpuData)[0];
            const sheetData = bpuData[firstSheetName];

            if (!sheetData || sheetData.length === 0) {
                console.warn("Feuille BPU vide");
                return null;
            }

            console.log(`Recherche dans la feuille: ${firstSheetName} (${sheetData.length} lignes)`);

            // Liste des noms à essayer (du plus spécifique au plus général)
            const namesToTry = [cleanedEntretoiseName];
            let alternativeName = cleanEntretoiseName(entretoiseName);
            if (alternativeName && alternativeName !== cleanedEntretoiseName) {
                namesToTry.push(alternativeName);
            }

            // Variables pour la recherche
            let foundPrice = null;

            // Essayer chaque nom nettoyé
            for (const nameToSearch of namesToTry) {
                if (!nameToSearch || nameToSearch.length < 2) continue;

                console.log(`Essai de recherche avec: "${nameToSearch}"`);
                let currentSearchRow = 0;

                // Boucle de recherche pour ce nom
                while (currentSearchRow < sheetData.length && foundPrice === null) {
                    const entretoiseRowIndex = searchInBPU(nameToSearch, 0, currentSearchRow, sheetData);

                    if (entretoiseRowIndex === -1) {
                        console.log(`Aucune occurrence trouvée pour "${nameToSearch}"`);
                        break;
                    }

                    console.log(`Entretoise trouvée à la ligne ${entretoiseRowIndex}: "${sheetData[entretoiseRowIndex][0]}"`);

                    const siteFound = findSiteForRow(entretoiseRowIndex, siteName, sheetData);

                    if (siteFound) {
                        const priceValue = sheetData[entretoiseRowIndex][8]; // Colonne I = index 8

                        if (priceValue !== undefined && priceValue !== null && priceValue !== '') {
                            // NOUVEAU: Fixer la précision à exactement 2 décimales
                            foundPrice = parseFloat((parseFloat(priceValue) || 0).toFixed(2));
                            console.log(`✓ Prix trouvé: ${foundPrice} € pour le site ${siteName} avec le nom "${nameToSearch}"`);
                            break;
                        } else {
                            console.log(`Pas de prix en colonne I pour cette ligne`);
                        }
                    } else {
                        console.log(`Site ${siteName} non trouvé pour cette occurrence`);
                    }

                    currentSearchRow = entretoiseRowIndex + 1;
                }

                if (foundPrice !== null) {
                    break;
                }
            }

            if (foundPrice === null) {
                console.log(`❌ Aucun prix trouvé pour l'entretoise "${entretoiseName}" sur le site "${siteName}"`);
                console.log(`   Noms essayés:`, namesToTry);
            }

            console.log(`=== FIN RECHERCHE PRIX ENTRETOISE ===`);
            return foundPrice;
        }

        /**
         * Recherche un terme dans une colonne spécifique du BPU à partir d'une ligne donnée
         * @param {string} searchTerm - Terme à rechercher
         * @param {number} columnIndex - Index de la colonne à rechercher (0 pour colonne A)
         * @param {number} startRow - Ligne de départ pour la recherche
         * @param {Array} sheetData - Données de la feuille BPU
         * @return {number} Index de la ligne trouvée ou -1 si non trouvé
         */
        function searchInBPU(searchTerm, columnIndex, startRow, sheetData) {
            console.log(`Recherche de "${searchTerm}" en colonne ${columnIndex} à partir de la ligne ${startRow}`);

            // Vérifier les paramètres
            if (!searchTerm || !sheetData || startRow < 0) {
                return -1;
            }

            // Normaliser le terme de recherche
            const searchTermLower = searchTerm.toLowerCase().trim();

            // Parcourir les lignes à partir de startRow
            for (let rowIndex = startRow; rowIndex < sheetData.length; rowIndex++) {
                const row = sheetData[rowIndex];

                // Vérifier que la ligne et la colonne existent
                if (!row || columnIndex >= row.length) {
                    continue;
                }

                const cellValue = row[columnIndex];

                // Vérifier que la cellule a une valeur
                if (cellValue === undefined || cellValue === null) {
                    continue;
                }

                // Convertir en string et normaliser
                const cellValueStr = String(cellValue).toLowerCase().trim();

                // Vérifier si le terme recherché est contenu dans la cellule
                if (cellValueStr.includes(searchTermLower)) {
                    console.log(`  ✓ Trouvé à la ligne ${rowIndex}: "${cellValue}"`);
                    return rowIndex;
                }
            }

            console.log(`  ❌ "${searchTerm}" non trouvé en colonne ${columnIndex}`);
            return -1;
        }

        /**
         * Remonte depuis une ligne donnée pour trouver le site correspondant
         * @param {number} rowIndex - Index de la ligne de départ (ligne de l'entretoise)
         * @param {string} siteName - Nom du site à rechercher
         * @param {Array} sheetData - Données de la feuille BPU
         * @return {boolean} true si le site correspond, false sinon
         */
        function findSiteForRow(rowIndex, siteName, sheetData) {
            console.log(`  Recherche du site "${siteName}" en remontant depuis la ligne ${rowIndex}`);

            // Vérifier les paramètres
            if (rowIndex < 0 || !siteName || !sheetData) {
                return false;
            }

            // Liste des sites connus du projet (réutiliser la liste existante)
            const knownSites = [
                "DTHR", "DTRS", "DTRI", "DTRM",
                "SEYSSEL", "CHAUTAGNE_BELLEY_BREGNIER-CORDON", "CHAUTAGNE", "BELLEY", "BREGNIER-CORDON", "SAULT-BRENAZ",
                "PIERRE-BENITE", "VAUGRIS", "PEAGE DE ROUSSILLON", "SAINT VALLIER", "ST VALLIER",
                "BOURG-LES-VALENCE", "BEAUCHASTEL", "LOGIS-NEUF",
                "MONTELIMAR", "DONZERE MONDRAGON",
                "AVIGNON", "SAUVETERRE", "CADEROUSSE", "VALLABREGUES"
            ];

            // Normaliser le site recherché
            const siteNameLower = siteName.toLowerCase().trim();

            // Remonter ligne par ligne depuis rowIndex vers le haut
            for (let currentRow = rowIndex; currentRow >= 0; currentRow--) {
                const row = sheetData[currentRow];

                // Vérifier que la ligne existe et a une colonne A
                if (!row || row.length === 0) {
                    continue;
                }

                const cellValue = row[0]; // Colonne A

                // Vérifier que la cellule a une valeur
                if (cellValue === undefined || cellValue === null) {
                    continue;
                }

                const cellValueStr = String(cellValue).toLowerCase().trim();

                // Vérifier si cette cellule contient un site connu
                for (const knownSite of knownSites) {
                    const knownSiteLower = knownSite.toLowerCase();

                    if (cellValueStr.includes(knownSiteLower)) {
                        console.log(`    Site trouvé à la ligne ${currentRow}: "${cellValue}" (${knownSite})`);

                        // Vérifier si c'est le site recherché
                        if (knownSiteLower === siteNameLower ||
                            cellValueStr.includes(siteNameLower) ||
                            siteNameLower.includes(knownSiteLower)) {

                            console.log(`    ✓ Site correspondant trouvé: ${knownSite}`);
                            return true;
                        } else {
                            console.log(`    ❌ Site différent: ${knownSite} ≠ ${siteName}`);
                            // On a trouvé un site, mais ce n'est pas le bon
                            // On arrête la recherche car on est dans une section différente
                            return false;
                        }
                    }
                }
            }

            console.log(`    ❌ Aucun site trouvé en remontant depuis la ligne ${rowIndex}`);
            return false;
        }

        /**
         * Version mise à jour de calculateEntretoiseTotalPrice  pour calculer TOUTES les entretoises d'un panneau
         * @param {string} panneauName - Nom du panneau
         * @param {string} siteName - Nom du site
         * @return {number} Prix total de TOUTES les entretoises que CNR doit fournir pour ce panneau
         */
        function calculateEntretoisesTotalPrice(panneauName, siteName, quantitePanneaux) {
            console.log(`=== CALCUL PRIX TOTAL TOUTES ENTRETOISES PANNEAU ===`);
            console.log(`Panneau: "${panneauName}"`);
            console.log(`Site: "${siteName}"`);
            console.log(`Quantité de panneaux: ${quantitePanneaux}`);

            // Étape 1: Récupérer TOUTES les entretoises nécessaires pour ce panneau
            const toutesEntretoises = getAllEntretoisesForPanneau(panneauName, siteName);
            console.log(`Entretoises nécessaires trouvées: ${toutesEntretoises.length}`);

            if (toutesEntretoises.length === 0) {
                console.log("Aucune entretoise nécessaire trouvée pour ce panneau");
                return 0;
            }

            let prixTotalPanneau = 0;

            // Étape 2: Pour chaque entretoise nécessaire, calculer ce que CNR doit fournir
            toutesEntretoises.forEach((entretoiseNecessaire, index) => {
                console.log(`\n--- Entretoise ${index + 1}: ${entretoiseNecessaire.nom} ---`);

                // Vérifier si l'utilisateur fournit cette entretoise
                const entretoiseFournieParUser = selectedEntretoises.find(selected =>
                    selected.description.toLowerCase().includes(entretoiseNecessaire.nom.toLowerCase()) ||
                    cleanEntretoiseNameForDisplay(selected.description).toLowerCase() === entretoiseNecessaire.nom.toLowerCase()
                );

                let quantiteFournieParUser = 0;
                if (entretoiseFournieParUser) {
                    quantiteFournieParUser = entretoiseFournieParUser.quantity || 0;
                    console.log(`  Quantité fournie par utilisateur: ${quantiteFournieParUser}`);
                } else {
                    console.log(`  Pas fournie par utilisateur`);
                }

                // Calculer la quantité que CNR doit fournir POR UN SEUL panneau
                const quantiteNecessaireParPanneau = entretoiseNecessaire.quantite || 0;
                const quantiteAFournirParCNRParPanneau = Math.max(0, quantiteNecessaireParPanneau - quantiteFournieParUser);

                // NOUVEAU: Multiplier par la quantité de panneaux
                const quantiteAFournirParCNRTotal = quantiteAFournirParCNRParPanneau * quantitePanneaux;

                console.log(`  Quantité nécessaire par panneau: ${quantiteNecessaireParPanneau}`);
                console.log(`  Quantité à fournir par CNR par panneau: ${quantiteAFournirParCNRParPanneau}`);
                console.log(`  Quantité à fournir par CNR TOTAL (${quantitePanneaux} panneaux): ${quantiteAFournirParCNRTotal}`);

                if (quantiteAFournirParCNRTotal > 0) {
                    // Récupérer le prix unitaire de cette entretoise
                    const prixUnitaire = getEntretoisePrice(entretoiseNecessaire.nom, siteName);

                    if (prixUnitaire && prixUnitaire > 0) {
                        // NOUVEAU: Calcul avec la quantité totale d'entretoises
                        const prixCetteEntretoise = prixUnitaire * quantiteAFournirParCNRTotal;
                        prixTotalPanneau += prixCetteEntretoise;

                        console.log(`  Prix unitaire: ${prixUnitaire} €`);
                        console.log(`  Prix cette entretoise: ${quantiteAFournirParCNRTotal} × ${prixUnitaire} = ${prixCetteEntretoise} €`);
                    } else {
                        console.log(`  ❌ Prix unitaire non trouvé pour ${entretoiseNecessaire.nom}`);
                    }
                } else {
                    console.log(`  Aucune quantité à fournir par CNR`);
                }
            });

            console.log(`\nPrix total pour ${quantitePanneaux} panneau(x) ${panneauName}: ${prixTotalPanneau} €`);
            console.log(`=== FIN CALCUL PRIX TOTAL TOUTES ENTRETOISES PANNEAU ===`);

            return prixTotalPanneau;
        }

        /**
         * Récupère toutes les entretoises nécessaires pour un panneau donné
         * @param {string} panneauName - Nom du panneau
         * @param {string} siteName - Nom du site
         * @return {Array} Liste des entretoises nécessaires avec leurs quantités
         */
        function getAllEntretoisesForPanneau(panneauName, siteName) {
            console.log(`  Recherche toutes entretoises pour: ${panneauName} sur ${siteName}`);

            // Utiliser les données de nomenclature déjà extraites
            if (!entretoisesParPanneaux || Object.keys(entretoisesParPanneaux).length === 0) {
                console.log(`  ❌ Données de nomenclature non disponibles`);
                return [];
            }

            // Construire les clés possibles pour ce panneau/site
            const possibleKeys = buildPossibleKeys(siteName, panneauName);
            console.log(`  Clés possibles:`, possibleKeys);

            // Chercher dans toutes les clés possibles
            for (const key of possibleKeys) {
                if (entretoisesParPanneaux[key]) {
                    const entretoises = entretoisesParPanneaux[key];
                    console.log(`  Trouvé ${entretoises.length} entretoises pour la clé: ${key}`);

                    // Filtrer pour ne garder que les vraies entretoises (pas les panneaux)
                    const entretoisesFiltered = entretoises.filter(item => {
                        const nomLower = (item.nom || '').toLowerCase();
                        return nomLower.includes('entretoise') ||
                            nomLower.includes('plaque') ||
                            nomLower.includes('ecrou') ||
                            nomLower.includes('tirant') ||
                            nomLower.includes('capot') ||
                            nomLower.includes('barreau');
                    });

                    console.log(`  Entretoises filtrées: ${entretoisesFiltered.length}`);
                    return entretoisesFiltered;
                }
            }

            console.log(`  ❌ Aucune entretoise trouvée pour ${panneauName}`);
            return [];
        }

        /**
         * Version mise à jour de addEntretoisesToResults - remplace l'ancienne logique
         */
        function addEntretoisesToResults(site, panneau, panneauQuantity) {
            console.log(`=== AJOUT ENTRETOISES AVEC CALCUL COMPLET ===`);
            console.log(`Site: ${site}, Panneau: ${panneau}, Quantité panneaux: ${panneauQuantity}`);

            // Supprimer toutes les anciennes entretoises pour ce panneau/site
            window.cumulativeResults = window.cumulativeResults.filter(result =>
                !(result.isEntretoise && result.site === site && result.linkedPanneau === panneau)
            );

            // NOUVEAU: Calculer le prix total de TOUTES les entretoises en incluant la quantité de panneaux
            const prixTotalToutesEntretoises = calculateEntretoisesTotalPrice(panneau, site, panneauQuantity);

            console.log(`Prix total toutes entretoises calculé pour ${panneauQuantity} panneau(x): ${prixTotalToutesEntretoises} €`);

            if (prixTotalToutesEntretoises > 0) {
                // Créer une seule entrée consolidée pour toutes les entretoises de ce panneau
                const entretoiseEntryId = 'entretoises-' + Date.now() + '-' + Math.floor(Math.random() * 10000);

                // Créer un résumé des entretoises sélectionnées par l'utilisateur
                let descriptionResume = "Entretoises panneau";
                if (selectedEntretoises && selectedEntretoises.length > 0) {
                    const nomsEntretoises = selectedEntretoises.map(e => cleanEntretoiseNameForDisplay(e.description));
                    descriptionResume = `Entretoises (${nomsEntretoises.join(', ')})`;
                }

                // Calculer la quantité totale d'entretoises que l'utilisateur fournit
                let quantiteTotaleFournie = 0;
                if (selectedEntretoises && selectedEntretoises.length > 0) {
                    quantiteTotaleFournie = selectedEntretoises.reduce((sum, e) => sum + (e.quantity || 0), 0);
                }

                // Ajouter l'entrée consolidée au tableau cumulé
                window.cumulativeResults.push({
                    id: entretoiseEntryId,
                    site: site,
                    description: descriptionResume,
                    repere: "",
                    quantity: quantiteTotaleFournie, // Quantité fournie par l'utilisateur
                    totalPrice: prixTotalToutesEntretoises, // Prix de ce que CNR doit fournir
                    isEntretoise: true,
                    linkedPanneau: panneau,
                    quantitePanneaux: panneauQuantity, // NOUVEAU: Stocker la quantité de panneaux
                    // Informations supplémentaires pour debug/suivi
                    prixCalculeComplete: true,
                    nombreEntretoisesSelectionnees: selectedEntretoises ? selectedEntretoises.length : 0
                });

                console.log(`Entrée consolidée ajoutée: ${descriptionResume}, prix total: ${prixTotalToutesEntretoises} €`);
            } else {
                console.log(`Aucune entretoise à facturer pour ce panneau`);
            }

            console.log(`=== FIN AJOUT ENTRETOISES ===`);
        }

        /**
         * Version mise à jour de addEntretoise pour déclencher le recalcul
         */
        function addEntretoise() {
            const entretoiseSelect = getElement('entretoise-select');
            const quantityInput = getElement('entretoise-quantity-input');

            if (!entretoiseSelect || !quantityInput) return;

            const selectedIndex = entretoiseSelect.selectedIndex;
            if (selectedIndex < 1) {
                alert("Veuillez sélectionner une pièce.");
                return;
            }

            const selectedOption = entretoiseSelect.options[selectedIndex];
            const selectedEntretoise = selectedOption.value;
            const quantity = parseInt(quantityInput.value) || 1;

            if (quantity < 1) {
                alert("La quantité doit être au minimum de 1.");
                quantityInput.value = 1;
                return;
            }

            const repere = selectedOption.dataset.repere || "";

            // Vérifier si cette entretoise est déjà dans la liste
            const existingIndex = selectedEntretoises.findIndex(e => e.description === selectedEntretoise);

            if (existingIndex !== -1) {
                selectedEntretoises[existingIndex].quantity = quantity;
                console.log(`Quantité mise à jour pour ${selectedEntretoise}: ${quantity}`);
            } else {
                const entretoise = {
                    description: selectedEntretoise,
                    repere: repere,
                    quantity: quantity,
                    id: 'entretoise-' + Date.now()
                };
                selectedEntretoises.push(entretoise);
                console.log(`Nouvelle entretoise ajoutée: ${selectedEntretoise}, quantité: ${quantity}`);
            }

            alert(`Pièce "${selectedEntretoise}" ajoutée avec une quantité de ${quantity}.`);

            // Réinitialiser la sélection
            entretoiseSelect.value = '';
            quantityInput.value = 1;

            const quantityContainer = getElement('entretoise-quantity-container');
            if (quantityContainer) {
                quantityContainer.style.display = 'none';
            }

            // Mettre à jour l'affichage informatif des entretoises
            if (typeof updateEntretoiseInfoExtended === 'function') {
                updateEntretoiseInfoExtended();
            }

            // NOUVEAU: Déclencher le recalcul complet des entretoises pour ce panneau
            // On ne fait rien ici car le recalcul se fera au moment du calculateWithQuantity()
        }



        /**
         * Récupère la quantité nécessaire d'une entretoise depuis la nomenclature
         * @param {string} entretoiseName - Nom de l'entretoise
         * @param {string} panneauName - Nom du panneau associé
         * @param {string} siteName - Nom du site
         * @return {number|null} Quantité nécessaire ou null si non trouvée
         */
        function getQuantiteNecessaireFromNomenclature(entretoiseName, panneauName, siteName) {
            console.log(`  Recherche quantité nécessaire pour: ${entretoiseName}`);

            // Utiliser les données de nomenclature déjà extraites dans entretoisesParPanneaux
            if (!entretoisesParPanneaux || Object.keys(entretoisesParPanneaux).length === 0) {
                console.log(`  ❌ Données de nomenclature non disponibles`);
                return null;
            }

            // Construire les clés possibles pour ce panneau/site
            const possibleKeys = buildPossibleKeys(siteName, panneauName);
            console.log(`  Clés possibles:`, possibleKeys);

            // Chercher dans toutes les clés possibles
            for (const key of possibleKeys) {
                if (entretoisesParPanneaux[key]) {
                    const entretoises = entretoisesParPanneaux[key];
                    console.log(`  Recherche dans la clé: ${key} (${entretoises.length} entretoises)`);

                    // Chercher l'entretoise par nom
                    for (const entretoise of entretoises) {
                        if (entretoise.nom && entretoise.nom.toLowerCase().includes(entretoiseName.toLowerCase())) {
                            console.log(`  ✓ Entretoise trouvée: ${entretoise.nom}, QTE: ${entretoise.quantite}`);
                            return entretoise.quantite || 1;
                        }
                    }
                }
            }

            console.log(`  ❌ Quantité nécessaire non trouvée pour ${entretoiseName}`);
            return null;
        }

        /**
         * Construit les clés possibles pour rechercher dans entretoisesParPanneaux
         * @param {string} siteName - Nom du site
         * @param {string} panneauName - Nom du panneau
         * @return {Array} Liste des clés possibles
         */
        function buildPossibleKeys(siteName, panneauName) {
            const keys = [];

            // Normaliser les noms
            const siteNormalized = siteName.toUpperCase().trim();
            const panneauNormalized = panneauName.toUpperCase().trim();

            // Clé directe
            keys.push(`${siteNormalized}|${panneauNormalized}`);

            // Gestion des sites combinés
            if (siteNormalized === "CHAUTAGNE_BELLEY_BREGNIER-CORDON" ||
                siteNormalized === "CHAUTAGNE" ||
                siteNormalized === "BELLEY" ||
                siteNormalized === "BREGNIER-CORDON") {

                const combinedSites = ["CHAUTAGNE", "BELLEY", "BREGNIER-CORDON", "CHAUTAGNE_BELLEY_BREGNIER-CORDON"];
                for (const site of combinedSites) {
                    keys.push(`${site}|${panneauNormalized}`);
                }
            }

            // Cas spécial pour BEAUCHASTEL / LOGIS - NEUF
            if (siteNormalized === "BEAUCHASTEL / LOGIS - NEUF") {
                keys.push(`BEAUCHASTEL|${panneauNormalized}`);
                keys.push(`LOGIS-NEUF|${panneauNormalized}`);
            }

            // Variantes des noms de panneaux
            if (panneauNormalized.includes("INFERIEUR") || panneauNormalized.includes("INF")) {
                keys.push(`${siteNormalized}|PANNEAU INFERIEUR`);
                keys.push(`${siteNormalized}|PANNEAU INF`);
            }

            if (panneauNormalized.includes("SUPERIEUR") || panneauNormalized.includes("SUP")) {
                keys.push(`${siteNormalized}|PANNEAU SUPERIEUR`);
                keys.push(`${siteNormalized}|PANNEAU SUP`);
            }

            // Cas spécial AVIGNON G1, G2, etc.
            if (siteNormalized === "AVIGNON") {
                const panneauCodeMatch = panneauNormalized.match(/G\d+/i);
                if (panneauCodeMatch) {
                    keys.push(`AVIGNON|${panneauCodeMatch[0].toUpperCase()}`);
                }
            }

            return keys;
        }


// Fonction pour mettre à jour l'affichage du tableau de résultats
        function updateResultsTable() {
            const resultDiv = document.getElementById('site-result');

            // Si aucun résultat, masquer le tableau
            if (!window.cumulativeResults || window.cumulativeResults.length === 0) {
                resultDiv.style.display = 'none';
                return;
            }

            // Calculer la quantité totale de panneaux
            let totalQuantity = 0;
            for (const result of window.cumulativeResults) {
                // Ne compter que les lignes qui ne sont pas des transports et qui ont une quantité
                if (!result.isTransportOnly && !result.isEntretoise && result.quantity) {
                    totalQuantity += parseInt(result.quantity, 10);
                }
            }

            // Calculer le prix total
            let prixTotalDetails = { prixTotal: 0 };
            try {
                prixTotalDetails = calculerPrixTotal();
            } catch (error) {
                console.error("Erreur lors du calcul du prix total:", error);
            }

            // Préparer le HTML des résultats cumulés avec les totaux
            let totalInfoHtml = `
        <div class="total-quantity-display">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>Quantité totale de panneaux:</strong>
                    <span id="total-quantity-value">${totalQuantity}</span>
                </div>
                <div>
                    <strong>Prix total:</strong>
                    <span id="total-price-value" style="font-size: 20px; color: #e01b24;">${formatNumber(prixTotalDetails.prixTotal)} €</span>
                </div>
            </div>
        </div>
    `;

            // Préparation du tableau récapitulatif avec une colonne pour les entretoises
            let finalResultsHtml = `
        <div class="result-title">Récapitulatif total</div>
        ${totalInfoHtml}
        <table class="result-table">
            <tr>
                <th>Site</th>
                <th>Repère de panneaux</th>
                <th>Quantité</th>
                <th>Entretoise</th>
                <th>Transport Barreaux</th>
                <th>Transport Panneaux</th>
                <th>Emballage</th>
                <th>Action</th>
            </tr>
    `;

            // Afficher tous les items du tableau cumulatif dans le bon ordre
            for (const result of window.cumulativeResults) {
                // Pour les entrées qui sont uniquement de transport
                if (result.isTransportOnly) {
                    // Préparation de l'affichage de la manutention barreaux
                    let manutentionDisplay = result.manutention || 'non';
                    if (result.manutention === 'oui' && result.manutentionDays) {
                        manutentionDisplay = `${result.manutention} (${result.manutentionDays} demi-journée${result.manutentionDays > 1 ? 's' : ''})`;
                    }

                    finalResultsHtml += `
                <tr id="row-${result.id}" style="background-color: #f0f8ff;">
                    <td>${escapeHtml(result.site)}</td>
                    <td colspan="2" style="text-align: center; font-style: italic;">Options</td>
                    <td></td>
                    <td>
                        <div>Barreaux: ${result.transportBarreaux}</div>
                        <div>Manutention: ${manutentionDisplay}</div>
                        <div>Grutage: ${result.dechargement || 'non'}</div>
                    </td>
                    <td>
                        <div>Panneaux: ${result.transportPanneaux}</div>
                        <div>Manutention: ${result.manutentionPanneaux || 'non'}</div>
                        <div>Grutage: ${result.grutagePanneaux || 'non'}</div>
                    </td>
                    <td>
                        <div>${result.emballage || 'non'}</div>
                        <div>Entretoises CNR: ${result.entretoisesParCNR || 'non'}</div>
                        ${result.entretoisesParCNR === 'oui' ? `<div>Type: ${result.entretoisesType || 'partiel'}</div>` : ''}
                    </td>
                    <td>
                        <button class="delete-row-btn" data-id="${result.id}"
                                style="background-color: #f44336; color: white; border: none;
                                       padding: 5px 10px; border-radius: 3px; cursor: pointer;">
                            Supprimer
                        </button>
                    </td>
                </tr>
            `;
                }
                // Pour les entrées normales (produits/panneaux) - AFFICHÉ EN PREMIER
                else if (!result.isEntretoise) {
                    finalResultsHtml += `
                <tr id="row-${result.id}">
                    <td>${escapeHtml(result.site)}</td>
                    <td><strong>${escapeHtml(result.description || '')}</strong></td>
                    <td>${result.quantity || ''}</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td>
                        <button class="delete-row-btn" data-id="${result.id}"
                                style="background-color: #f44336; color: white; border: none;
                                       padding: 5px 10px; border-radius: 3px; cursor: pointer;">
                            Supprimer
                        </button>
                    </td>
                </tr>
            `;

                    // NOUVEAU: Chercher et afficher immédiatement les entretoises liées à ce panneau
                    const entretoises = window.cumulativeResults.filter(item =>
                        item.isEntretoise &&
                        item.site === result.site &&
                        item.linkedPanneau === result.description
                    );

                    for (const entretoise of entretoises) {
                        finalResultsHtml += `
                    <tr id="row-${entretoise.id}" style="background-color: #f5f5f5;">
                        <td>${escapeHtml(entretoise.site)}</td>
                        <td></td>
                        <td>${entretoise.quantity || ''}</td>
                        <td>${escapeHtml(entretoise.description || '')}</td>
                        <td colspan="3"></td>
                        <td>
                            <button class="delete-row-btn" data-id="${entretoise.id}"
                                    style="background-color: #f44336; color: white; border: none;
                                           padding: 5px 10px; border-radius: 3px; cursor: pointer;">
                                Supprimer
                            </button>
                        </td>
                    </tr>
                `;
                    }
                }
                // Note: Les entretoises sont maintenant affichées avec leur panneau parent,
                // donc on ignore les entretoises dans cette boucle principale
            }

            finalResultsHtml += `
        </table>
        <div style="display: flex; gap: 15px; margin-top: 15px;">
        <button id="reset-results" class="reset-button">Tout réinitialiser</button>
        <button id="export-excel" class="export-button">Exporter vers Excel</button>
    </div>
    `;

            // Afficher les résultats finaux
            resultDiv.innerHTML = finalResultsHtml;
            resultDiv.style.display = 'block';

            // Ajouter événements pour les boutons
            setupResultButtonEvents();

            // Calculer le prix total (tous les calculs sont gérés dans cette fonction)
            try {
                calculerPrixTotal();
            } catch (error) {
                console.error("Erreur lors du calcul du prix total:", error);
            }
        }

// Fonction pour configurer les événements des boutons de résultat
        function setupResultButtonEvents() {
            console.log("Configuration des événements des boutons de résultat");

            // Réinitialisation
            const resetButton = document.getElementById('reset-results');
            if (resetButton) {
                resetButton.addEventListener('click', function() {
                    console.log("=== DÉBUT RÉINITIALISATION COMPLÈTE ===");

                    // Vider le tableau des résultats
                    window.cumulativeResults = [];

                    // Masquer le tableau de résultats
                    const resultDiv = document.getElementById('site-result');
                    if (resultDiv) {
                        resultDiv.style.display = 'none';
                        console.log("Tableau de résultats masqué");
                    }

                    // Réinitialiser le sélecteur de site
                    const siteSelect = document.getElementById('site-select');
                    if (siteSelect) {
                        siteSelect.value = '';
                        console.log("Sélecteur de site réinitialisé");
                    }

                    // Masquer et réinitialiser le filtre de repère
                    const repereFilterDiv = document.getElementById('repere-filter');
                    if (repereFilterDiv) {
                        repereFilterDiv.style.display = 'none';
                    }
                    const repereSelect = document.getElementById('repere-select');
                    if (repereSelect) {
                        repereSelect.value = '';
                    }

                    // Masquer et réinitialiser le formulaire de quantité
                    const quantityFilterDiv = document.getElementById('quantity-filter');
                    if (quantityFilterDiv) {
                        quantityFilterDiv.style.display = 'none';
                    }
                    const quantityInput = document.getElementById('quantity-input');
                    if (quantityInput) {
                        quantityInput.value = 1;
                    }

                    // Masquer les options de transport
                    const transportOptionsDiv = document.getElementById('transport-options');
                    if (transportOptionsDiv) {
                        transportOptionsDiv.style.display = 'none';
                        console.log("Options de transport masquées");
                    }

                    // Masquer les options de transport panneaux
                    const transportPanneauxOptionsDiv = document.getElementById('transport-panneaux-options');
                    if (transportPanneauxOptionsDiv) {
                        transportPanneauxOptionsDiv.style.display = 'none';
                    }

                    // Masquer les options d'emballage
                    const emballageOptionsDiv = document.getElementById('emballage-options');
                    if (emballageOptionsDiv) {
                        emballageOptionsDiv.style.display = 'none';
                    }

                    // Masquer les options d'entretoises
                    const entretoiseOptionsDiv = document.getElementById('entretoises-options');
                    if (entretoiseOptionsDiv) {
                        entretoiseOptionsDiv.style.display = 'none';
                    }

                    // Masquer la sélection d'entretoises spécifiques
                    const entretoiseSelectionDiv = document.getElementById('entretoises-selection');
                    if (entretoiseSelectionDiv) {
                        entretoiseSelectionDiv.style.display = 'none';
                    }

                    // Réinitialiser toutes les options de transport à "non"
                    const transportBarreauxNon = document.getElementById('transport-barreaux-non');
                    const transportPanneauxNon = document.getElementById('transport-panneaux-non');
                    const manutentionNon = document.getElementById('manutention-non');
                    const dechargementNon = document.getElementById('dechargement-non');
                    const manutentionPanneauxNon = document.getElementById('manutention-panneaux-non');
                    const grutagePanneauxNon = document.getElementById('grutage-panneaux-non');
                    const emballageNon = document.getElementById('emballage-non');
                    const entretoisesCnrNon = document.getElementById('entretoises-cnr-non');
                    const entretoisesTypePartiel = document.getElementById('entretoises-type-partiel');

                    if (transportBarreauxNon) transportBarreauxNon.checked = true;
                    if (transportPanneauxNon) transportPanneauxNon.checked = true;
                    if (manutentionNon) manutentionNon.checked = true;
                    if (dechargementNon) dechargementNon.checked = true;
                    if (manutentionPanneauxNon) manutentionPanneauxNon.checked = true;
                    if (grutagePanneauxNon) grutagePanneauxNon.checked = true;
                    if (emballageNon) emballageNon.checked = true;
                    if (entretoisesCnrNon) entretoisesCnrNon.checked = true;
                    if (entretoisesTypePartiel) entretoisesTypePartiel.checked = true;

                    // Réinitialiser les variables globales de transport
                    transportBarreaux = "non";
                    transportPanneaux = "non";
                    manutention = "non";
                    dechargement = "non";
                    manutentionPanneaux = "non";
                    grutagePanneaux = "non";
                    emballage = "non";
                    entretoisesParCNR = "non";
                    entretoisesType = "partiel";

                    // Masquer les options dépendantes
                    const manutentionContainer = document.getElementById('manutention-container');
                    const manutentionDaysContainer = document.getElementById('manutention-days-container');
                    const dechargementContainer = document.getElementById('dechargement-container');
                    const manutentionPanneauxContainer = document.getElementById('manutention-panneaux-container');
                    const grutagePanneauxContainer = document.getElementById('grutage-panneaux-container');
                    const entretoisesTypeContainer = document.getElementById('entretoises-type-container');

                    if (manutentionContainer) manutentionContainer.style.display = 'none';
                    if (manutentionDaysContainer) manutentionDaysContainer.style.display = 'none';
                    if (dechargementContainer) dechargementContainer.style.display = 'none';
                    if (manutentionPanneauxContainer) manutentionPanneauxContainer.style.display = 'none';
                    if (grutagePanneauxContainer) grutagePanneauxContainer.style.display = 'none';
                    if (entretoisesTypeContainer) entretoisesTypeContainer.style.display = 'none';

                    // Réinitialiser les entretoises sélectionnées
                    selectedEntretoises = [];
                    currentPanneauWithEntretoises = null;

                    // Nettoyer l'affichage des entretoises
                    const entretoisesList = document.getElementById('entretoises-list');
                    if (entretoisesList) {
                        entretoisesList.innerHTML = '';
                    }
                    const entretoisesSelected = document.getElementById('entretoises-selected');
                    if (entretoisesSelected) {
                        entretoisesSelected.style.display = 'none';
                    }

                    // Réinitialiser les sélecteurs d'entretoises
                    const entretoiseSelect = document.getElementById('entretoise-select');
                    if (entretoiseSelect) {
                        entretoiseSelect.value = '';
                    }
                    const entretoiseQuantityContainer = document.getElementById('entretoise-quantity-container');
                    if (entretoiseQuantityContainer) {
                        entretoiseQuantityContainer.style.display = 'none';
                    }

                    // Réinitialiser les variables globales
                    window.currentFilteredItems = null;

                    console.log("=== RÉINITIALISATION COMPLÈTE EFFECTUÉE ===");
                    console.log("Retour à l'état initial - Seulement le sélecteur de site visible");
                });
            } else {
                console.log("Bouton reset-results non trouvé");
            }

            // Boutons de suppression
            document.querySelectorAll('.delete-row-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const idToRemove = this.getAttribute('data-id');
                    window.cumulativeResults = window.cumulativeResults.filter(item => item.id !== idToRemove);
                    updateResultsTable();
                });
            });

            // Bouton d'exportation
            const exportButton = document.getElementById('export-excel');
            if (exportButton) {
                console.log("Bouton d'exportation trouvé, ajout du gestionnaire d'événements");

                // Ajouter le gestionnaire
                exportButton.addEventListener('click', function() {
                    console.log("Clic sur le bouton d'exportation");
                    // Désactiver le bouton pendant l'exportation
                    this.disabled = true;
                    this.textContent = "Exportation en cours...";

                    // Appeler la fonction d'exportation
                    exportToExcel().then(() => {
                        console.log("Exportation terminée avec succès");
                        this.disabled = false;
                        this.textContent = "Exporter vers Excel";
                    }).catch(error => {
                        console.error("Erreur lors de l'exportation:", error);
                        this.disabled = false;
                        this.textContent = "Exporter vers Excel";
                        alert("Une erreur est survenue lors de l'exportation: " + error.message);
                    });
                });
            } else {
                console.log("Bouton d'exportation non trouvé");
            }
        }

        // Fonction pour configurer les gestionnaires d'événements
        function setupEventHandlers() {
            // Gestionnaire pour le bouton de recherche par site
            document.getElementById('search-site-button').addEventListener('click', function() {
                searchBySite();
                // Masquer le formulaire de quantité
                document.getElementById('quantity-filter').style.display = 'none';

                // Réinitialiser les boutons radio à leur valeur par défaut
                document.getElementById('transport-barreaux-non').checked = true;
                document.getElementById('dechargement-non').checked = true;
                transportBarreaux = "non";
                dechargement = "non";
            });

            // Gestionnaires d'événements pour les boutons radio de transport barreaux
            document.querySelectorAll('input[name="transport-barreaux"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    transportBarreaux = this.value;
                    console.log("Transport barreaux:", transportBarreaux);

                    // Récupérer tous les conteneurs concernés
                    const manutentionContainer = document.getElementById('manutention-container');
                    const manutentionDaysContainer = document.getElementById('manutention-days-container');
                    const dechargementContainer = document.getElementById('dechargement-container');

                    if (transportBarreaux === "oui") {
                        // Si transport barreaux est activé, afficher l'option de manutention
                        manutentionContainer.style.display = "flex";
                    } else {
                        // Si transport barreaux est désactivé, masquer toutes les options dépendantes
                        manutentionContainer.style.display = "none";
                        manutentionDaysContainer.style.display = "none";
                        dechargementContainer.style.display = "none";

                        // Réinitialiser toutes les options à "non"
                        document.getElementById('manutention-non').checked = true;
                        document.getElementById('dechargement-non').checked = true;
                        manutention = "non";
                        dechargement = "non";
                    }
                });
            });

            document.getElementById('entretoise-select').addEventListener('change', function() {
                handleEntretoiseSelection();
            });

            // Gestionnaires d'événements pour les boutons radio de déchargement
            document.querySelectorAll('input[name="dechargement"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    dechargement = this.value;
                    console.log("Déchargement:", dechargement);
                });
            });

            // Gestionnaires d'événements pour les boutons radio de manutention
            document.querySelectorAll('input[name="manutention"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    manutention = this.value;
                    console.log("Manutention:", manutention);

                    // Afficher ou masquer le champ de nombre de demi-journées
                    const manutentionDaysContainer = document.getElementById('manutention-days-container');
                    const dechargementContainer = document.getElementById('dechargement-container');

                    if (manutention === "oui") {
                        manutentionDaysContainer.style.display = "flex";
                        dechargementContainer.style.display = "flex";  // Afficher l'option de grue
                    } else {
                        manutentionDaysContainer.style.display = "none";
                        dechargementContainer.style.display = "none";   // Masquer l'option de grue

                        // Réinitialiser l'option de déchargement à "non"
                        document.getElementById('dechargement-non').checked = true;
                        dechargement = "non";
                    }
                });
            });

            document.getElementById('manutention-days').addEventListener('change', function() {
                manutentionDays = parseInt(this.value) || 1;
                if (manutentionDays < 1) {
                    this.value = 1;
                    manutentionDays = 1;
                }
                console.log("Nombre de demi-journées de manutention:", manutentionDays);

                // Si le tableau récapitulatif est déjà affiché, le mettre à jour
                if (window.cumulativeResults && window.cumulativeResults.length > 0) {
                    updateResultsTable();
                }
            });

            // Dans la fonction setupEventHandlers()

// Gestionnaires d'événements pour les boutons radio de transport panneaux
            document.querySelectorAll('input[name="transport-panneaux"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    transportPanneaux = this.value;
                    console.log("Transport panneaux:", transportPanneaux);

                    // Récupérer les conteneurs concernés
                    const manutentionPanneauxContainer = document.getElementById('manutention-panneaux-container');
                    const grutagePanneauxContainer = document.getElementById('grutage-panneaux-container');

                    if (transportPanneaux === "oui") {
                        // Si transport panneaux est activé, afficher l'option de manutention panneaux
                        manutentionPanneauxContainer.style.display = "flex";
                    } else {
                        // Si transport panneaux est désactivé, masquer toutes les options dépendantes
                        manutentionPanneauxContainer.style.display = "none";
                        grutagePanneauxContainer.style.display = "none";

                        // Réinitialiser toutes les options à "non"
                        document.getElementById('manutention-panneaux-non').checked = true;
                        document.getElementById('grutage-panneaux-non').checked = true;
                        manutentionPanneaux = "non";
                        grutagePanneaux = "non";
                    }
                });
            });

// Gestionnaires d'événements pour les boutons radio de manutention panneaux
            document.querySelectorAll('input[name="manutention-panneaux"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    manutentionPanneaux = this.value;
                    console.log("Manutention panneaux:", manutentionPanneaux);

                    // Récupérer le conteneur de grutage panneaux
                    const grutagePanneauxContainer = document.getElementById('grutage-panneaux-container');

                    if (manutentionPanneaux === "oui") {
                        // Si manutention panneaux est activée, afficher l'option de grutage panneaux
                        grutagePanneauxContainer.style.display = "flex";
                    } else {
                        // Si manutention panneaux est désactivée, masquer l'option de grutage panneaux
                        grutagePanneauxContainer.style.display = "none";

                        // Réinitialiser l'option à "non"
                        document.getElementById('grutage-panneaux-non').checked = true;
                        grutagePanneaux = "non";
                    }
                });
            });

// Gestionnaires d'événements pour les boutons radio de grutage panneaux
            document.querySelectorAll('input[name="grutage-panneaux"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    grutagePanneaux = this.value;
                    console.log("Grutage panneaux:", grutagePanneaux);
                });
            });

            // Dans setupEventHandlers()
            document.getElementById('validate-transport-button').addEventListener('click', function() {
                validateTransportOptions();
            });

            // Gestionnaires d'événements pour les boutons radio d'emballage
            document.querySelectorAll('input[name="emballage"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    emballage = this.value;
                    console.log("Emballage:", emballage);
                });
            });

            // Afficher les options d'entretoises
            document.getElementById('entretoises-options').style.display = 'flex';

            const entretoiseOptionsDiv = document.getElementById('entretoises-options');
            if (entretoiseOptionsDiv) {
                entretoiseOptionsDiv.style.display = 'none';
            }

            // Gestionnaires d'événements pour les boutons radio d'entretoises CNR
            document.querySelectorAll('input[name="entretoises-cnr"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    entretoisesParCNR = this.value;
                    console.log("Entretoises fournies par CNR:", entretoisesParCNR);

                    // Afficher ou masquer les options de type d'entretoises
                    const entretoisesTypeContainer = document.getElementById('entretoises-type-container');

                    if (entretoisesParCNR === "oui") {
                        entretoisesTypeContainer.style.display = "flex";
                    } else {
                        entretoisesTypeContainer.style.display = "none";
                        // Réinitialiser l'option à "partiel"
                        document.getElementById('entretoises-type-partiel').checked = true;
                        entretoisesType = "partiel";
                    }
                });
            });

            // Gestionnaires d'événements pour les boutons radio de type d'entretoises
            document.querySelectorAll('input[name="entretoises-type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    entretoisesType = this.value;
                    console.log("Type d'entretoises:", entretoisesType);
                });
            });


// Gestionnaire pour la touche Entrée dans le sélecteur de site
            document.getElementById('site-select').addEventListener('change', function() {
                searchBySite();
                // Réinitialiser le sélecteur de repère
                document.getElementById('repere-select').value = '';

                const entretoiseSelectionDiv = document.getElementById('entretoises-selection');
                if (entretoiseSelectionDiv) {
                    entretoiseSelectionDiv.style.display = 'none';
                }

                // Obtenir le site sélectionné
                const selectedSite = document.getElementById('site-select').value;

                // Vérifier si le site a déjà une ligne d'options dans le tableau récapitulatif
                if (!siteHasOptionsInRecap(selectedSite)) {
                    // Si non, masquer le filtre de repère
                    document.getElementById('repere-filter').style.display = 'none';
                }

                document.getElementById('quantity-filter').style.display = 'none';
                document.getElementById('dechargement-container').style.display = 'none';

                document.getElementById('transport-barreaux-non').checked = true;
                document.getElementById('dechargement-non').checked = true;
                transportBarreaux = "non";
                dechargement = "non";

                document.getElementById('transport-panneaux-non').checked = true;
                document.getElementById('manutention-panneaux-non').checked = true;
                document.getElementById('grutage-panneaux-non').checked = true;
                transportPanneaux = "non";
                manutentionPanneaux = "non";
                grutagePanneaux = "non";

                // Masquer les options dépendantes
                document.getElementById('manutention-panneaux-container').style.display = "none";
                document.getElementById('grutage-panneaux-container').style.display = "none";
            });

            const selectedRepere = document.getElementById('repere-select').value;
            if (selectedRepere && shouldShowEntretoiseSelection()) {
                document.getElementById('entretoises-selection').style.display = 'block';
                populateEntretoiseSelect(document.getElementById('site-select').value, selectedRepere);
            } else {
                document.getElementById('entretoises-selection').style.display = 'none';
            }


// Gestionnaire pour le bouton d'ajout d'entretoise
            const addEntretoiseBtn = document.getElementById('add-entretoise-button');
            if (addEntretoiseBtn) {
                addEntretoiseBtn.addEventListener('click', function() {
                    try {
                        addEntretoise();
                    } catch (error) {
                        console.error("Erreur dans addEntretoise:", error);
                    }
                });
            } else {
                console.log("Bouton add-entretoise-button non trouvé (normal au chargement)");
            }

// Gestionnaire pour le changement de quantité de panneaux
            const quantityInput = document.getElementById('quantity-input');
            if (quantityInput) {
                quantityInput.addEventListener('change', function() {
                    try {
                        // Mettre à jour uniquement le texte d'information si des entretoises sont sélectionnées
                        if (selectedEntretoises && selectedEntretoises.length > 0) {
                            updateEntretoiseInfo();
                        }
                    } catch (error) {
                        console.error("Erreur dans quantity-input change:", error);
                    }
                });
            }

// Gestionnaire pour le changement de quantité d'entretoises
            const entretoiseQuantityInput = document.getElementById('entretoise-quantity');
            if (entretoiseQuantityInput) {
                entretoiseQuantityInput.addEventListener('change', function() {
                    const value = parseInt(this.value);
                    if (isNaN(value) || value < 1) {
                        this.value = 1;
                    }
                });
            } else {
                console.log("Input entretoise-quantity non trouvé (peut être normal)");
            }


            // Gestionnaire pour le bouton de filtrage par repère
            document.getElementById('search-repere-button').addEventListener('click', function() {
                filterByRepere();
            });

            // Gestionnaire pour le changement de sélection de repère
            document.getElementById('repere-select').addEventListener('change', function() {
                filterByRepere();
            });

            // Gestionnaire pour le bouton de calcul
            document.getElementById('calculate-button').addEventListener('click', function() {
                calculateWithQuantity();
            });

            // Gestionnaire pour la touche Entrée dans le champ de quantité
            document.getElementById('quantity-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    calculateWithQuantity();
                }
            });

            // Gestionnaire pour le changement de valeur dans le champ de quantité
            document.getElementById('quantity-input').addEventListener('input', function() {
            });

            // Gestionnaire pour les titres de fichiers
            document.querySelectorAll('.file-title').forEach(fileTitle => {
                fileTitle.addEventListener('click', function() {
                    const contentId = this.getAttribute('data-target');
                    const contentElement = document.getElementById(contentId);
                    const iconElement = this.querySelector('.toggle-icon');

                    if (contentElement.style.display === 'block') {
                        contentElement.style.display = 'none';
                        iconElement.classList.add('collapsed');
                    } else {
                        contentElement.style.display = 'block';
                        iconElement.classList.remove('collapsed');
                    }
                });
            });

            // Gestionnaire pour les titres de feuilles
            document.querySelectorAll('.sheet-title').forEach(sheetTitle => {
                sheetTitle.addEventListener('click', function() {
                    const contentId = this.getAttribute('data-target');
                    const contentElement = document.getElementById(contentId);
                    const iconElement = this.querySelector('.toggle-icon');

                    if (contentElement.style.display === 'block') {
                        contentElement.style.display = 'none';
                        iconElement.classList.add('collapsed');
                    } else {
                        contentElement.style.display = 'block';
                        iconElement.classList.remove('collapsed');
                    }
                });
            });

            // Gestionnaire pour le bouton "Afficher/Masquer tous"
            document.getElementById('toggle-all-btn').addEventListener('click', function() {
                const fileContents = document.querySelectorAll('.file-content');
                const sheetContents = document.querySelectorAll('.sheet-content');
                const fileIcons = document.querySelectorAll('.file-title .toggle-icon');
                const sheetIcons = document.querySelectorAll('.sheet-title .toggle-icon');

                if (allTablesVisible) {
                    // Masquer tous les tableaux
                    fileContents.forEach(content => {
                        content.style.display = 'none';
                    });
                    sheetContents.forEach(content => {
                        content.style.display = 'none';
                    });
                    fileIcons.forEach(icon => {
                        icon.classList.add('collapsed');
                    });
                    sheetIcons.forEach(icon => {
                        icon.classList.add('collapsed');
                    });
                    this.textContent = 'Afficher tous les tableaux';
                } else {
                    // Afficher tous les tableaux
                    fileContents.forEach(content => {
                        content.style.display = 'block';
                    });
                    sheetContents.forEach(content => {
                        content.style.display = 'block';
                    });
                    fileIcons.forEach(icon => {
                        icon.classList.remove('collapsed');
                    });
                    sheetIcons.forEach(icon => {
                        icon.classList.remove('collapsed');
                    });
                    this.textContent = 'Masquer tous les tableaux';
                }

                allTablesVisible = !allTablesVisible;
            });
        }

        /**
         * Exporte les données du tableau récapitulatif vers un fichier Excel
         * @returns {Promise} Une promesse qui est résolue lorsque l'exportation est terminée
         */
// Fonction pour exporter les données vers Excel
        function exportToExcel() {
            console.log("Début de la fonction exportToExcel");
            return new Promise((resolve, reject) => {
                // Vérifier qu'il y a des données à exporter
                if (!window.cumulativeResults || window.cumulativeResults.length === 0) {
                    console.log("Aucune donnée à exporter");
                    alert("Aucune donnée à exporter. Veuillez d'abord sélectionner des panneaux.");
                    reject(new Error("Aucune donnée à exporter"));
                    return;
                }

                console.log("Préparation des données pour l'export");
                // Préparer les données du récapitulatif pour l'export
                const recapData = prepareRecapDataForExport();

                // Collecter les informations sur les prix calculés
                const priceData = collectPriceData();

                // Créer l'objet de données à envoyer
                const exportData = {
                    recap: recapData,
                    prices: priceData
                };
                console.log("Données préparées:", exportData);

                console.log("Envoi des données au serveur");
                // Envoyer les données au serveur
                fetch('export_excel.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(exportData)
                })
                    .then(response => {
                        console.log("Réponse du serveur reçue", response);
                        if (!response.ok) {
                            console.error("Erreur HTTP:", response.status);
                            return response.text().then(text => {
                                throw new Error(`Erreur HTTP ${response.status}: ${text}`);
                            });
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        console.log("Blob reçu", blob);
                        // Créer un lien de téléchargement pour le fichier
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = `Export_Panneaux_${formatDateForFileName(new Date())}.xlsx`;
                        document.body.appendChild(a);
                        console.log("Déclenchement du téléchargement");
                        a.click();

                        // Nettoyer
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);

                        resolve();
                    })
                    .catch(error => {
                        console.error("Erreur lors de l'exportation:", error);
                        reject(error);
                    });
            });
        }

        /**
         * Formate la date pour le nom de fichier (AAAAMMJJ_HHMMSS)
         * @param {Date} date - La date à formater
         * @returns {string} La date formatée
         */
        function formatDateForFileName(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');

            return `${year}${month}${day}_${hours}${minutes}${seconds}`;
        }

        /**
         * Prépare les données du tableau récapitulatif pour l'export
         * @returns {Array} Un tableau d'objets contenant les données formatées
         */
// Fonction pour préparer les données pour l'export Excel
        function prepareRecapDataForExport() {
            if (!window.cumulativeResults) {
                return [];
            }

            return window.cumulativeResults.map(item => {
                // Pour les lignes d'options de transport
                if (item.isTransportOnly) {
                    return {
                        site: item.site,
                        description: "Options",
                        quantity: "",
                        pieceAssociee: "",  // Nouvelle colonne ajoutée
                        transportBarreaux: item.transportBarreaux || "non",
                        manutentionBarreaux: item.manutention || "non",
                        manutentionDays: item.manutentionDays || "",
                        dechargementBarreaux: item.dechargement || "non",
                        transportPanneaux: item.transportPanneaux || "non",
                        manutentionPanneaux: item.manutentionPanneaux || "non",
                        grutagePanneaux: item.grutagePanneaux || "non",
                        emballage: item.emballage || "non"
                    };
                }
                // Pour les lignes de pièces
                else if (item.isEntretoise) {
                    return {
                        site: item.site,
                        description: "",  // Laissez vide pour les pièces
                        quantity: item.quantity || "",
                        pieceAssociee: item.description || "",  // Utilisez la description comme pièce associée
                        transportBarreaux: "",
                        manutentionBarreaux: "",
                        manutentionDays: "",
                        dechargementBarreaux: "",
                        transportPanneaux: "",
                        manutentionPanneaux: "",
                        grutagePanneaux: "",
                        emballage: "",
                        totalPrice: item.totalPrice || 0
                    };
                }
                // Pour les lignes de panneaux
                else {
                    return {
                        site: item.site,
                        description: item.description || "",
                        quantity: item.quantity || "",
                        pieceAssociee: "",  // Vide pour les panneaux
                        transportBarreaux: "",
                        manutentionBarreaux: "",
                        manutentionDays: "",
                        dechargementBarreaux: "",
                        transportPanneaux: "",
                        manutentionPanneaux: "",
                        grutagePanneaux: "",
                        emballage: "",
                        totalPrice: item.totalPrice || 0
                    };
                }
            });
        }

        /**
         * Collecte les informations sur les prix calculés avec détails pour l'export Excel
         * @returns {Object} Un objet contenant les différents prix calculés avec détails
         */
        /**
         * Version mise à jour de collectPriceData pour collecter les détails complets des entretoises
         */
        function collectPriceData() {
            // Calculer les prix avec les entretoises incluses
            const priceDetails = calculerPrixTotal();

            // Calculer le nombre total de panneaux SEULEMENT (pas les entretoises)
            let totalPanneaux = 0;
            let nbPanneauxSupStVallier = 0;
            let detailMontage = [];
            let detailEntretoisesComplet = {}; // NOUVEAU: Structure complète des entretoises

            // Compter les panneaux par type et site, et collecter les détails complets des entretoises
            if (window.cumulativeResults) {
                for (const result of window.cumulativeResults) {
                    if (result.isEntretoise && result.prixCalculeComplete) {
                        // NOUVEAU: Collecter les détails complets pour les entretoises calculées avec le nouveau système
                        const detailsEntretoises = collectDetailledEntretoiseInfo(result.site, result.linkedPanneau);

                        if (detailsEntretoises && detailsEntretoises.detailParEntretoise.length > 0) {
                            const panneauKey = `${result.site}|${result.linkedPanneau}`;
                            detailEntretoisesComplet[panneauKey] = detailsEntretoises;

                            console.log(`Détails entretoises collectés pour ${panneauKey}:`, detailsEntretoises);
                        }
                    } else if (!result.isTransportOnly && !result.isEntretoise && result.quantity) {
                        // Traitement des panneaux (code existant)
                        const quantity = parseInt(result.quantity, 10);
                        totalPanneaux += quantity;

                        // Compter les panneaux supérieurs de St-Vallier
                        const estStVallier = result.site &&
                            (result.site.toUpperCase().includes("SAINT VALLIER") ||
                                result.site.toUpperCase().includes("ST VALLIER") ||
                                result.site.toUpperCase().includes("ST-VALLIER"));

                        const estPanneauSuperieur = result.description &&
                            (result.description.toLowerCase().includes("supérieur") ||
                                result.description.toLowerCase().includes("superieur"));

                        if (estStVallier && estPanneauSuperieur) {
                            nbPanneauxSupStVallier += quantity;
                        }

                        // Ajouter les détails de montage SEULEMENT pour les panneaux
                        if (quantity > 0 && result.totalPrice > 0) {
                            const prixUnitaire = result.totalPrice / quantity;
                            detailMontage.push({
                                site: result.site,
                                description: result.description,
                                quantity: quantity,
                                prixUnitaire: prixUnitaire,
                                sousTotal: result.totalPrice
                            });
                        }
                    }
                }
            }

            // Consolider tous les détails d'entretoises en un seul résumé
            const entretoisesConsolide = consolidateEntretoiseDetails(detailEntretoisesComplet);

            // Collecter les détails des forfaits (code existant)
            const forfaitLogistique = {
                prixUnitaire: calculerForfaitLogistique(totalPanneaux).toFixed(2).replace('.', ','),
                montant: calculerForfaitLogistique(totalPanneaux) * totalPanneaux
            };

            const forfaitSuivi = {
                prixUnitaire: calculerForfaitSuivi(totalPanneaux).toFixed(2).replace('.', ','),
                montant: calculerForfaitSuivi(totalPanneaux) * totalPanneaux
            };

            // Collecter tous les détails (code existant)
            const transportBarreaux = calculerPrixTransportBarreaux();
            const transportPanneaux = calculerPrixTransportPanneaux();
            const manutention = calculerPrixManutention();
            const manutentionPanneaux = calculerPrixManutentionPanneaux();
            const grutage = calculerPrixGrutage();
            const grutagePanneaux = calculerPrixGrutagePanneaux();

            console.log(`Export: Total panneaux: ${totalPanneaux}, Entretoises détaillées: ${Object.keys(detailEntretoisesComplet).length} panneaux`);

            return {
                // Prix existants
                prixForfaits: priceDetails.prixForfaits || 0,
                prixSoudage: priceDetails.prixSoudage || 0,
                prixTransportBarreaux: priceDetails.prixTransportBarreaux || 0,
                prixTransportPanneaux: priceDetails.prixTransportPanneaux || 0,
                prixManutention: priceDetails.prixManutention || 0,
                prixManutentionPanneaux: priceDetails.prixManutentionPanneaux || 0,
                prixGrutage: priceDetails.prixGrutage || 0,
                prixGrutagePanneaux: priceDetails.prixGrutagePanneaux || 0,
                prixEmballage: priceDetails.prixEmballage || 0,
                prixMontage: priceDetails.prixMontage || 0,
                prixEntretoises: priceDetails.prixEntretoises || 0,
                prixTotal: priceDetails.prixTotal || 0,

                // Données détaillées existantes
                totalPanneaux: totalPanneaux,
                nbPanneauxSupStVallier: nbPanneauxSupStVallier,
                forfaitLogistique: forfaitLogistique,
                forfaitSuivi: forfaitSuivi,
                transportBarreaux: transportBarreaux,
                transportPanneaux: transportPanneaux,
                manutention: manutention,
                manutentionPanneaux: manutentionPanneaux,
                grutage: grutage,
                grutagePanneaux: grutagePanneaux,
                detailMontage: detailMontage,

                // NOUVEAU: Données consolidées des entretoises pour l'export Excel
                entretoisesSummary: entretoisesConsolide
            };
        }

        /**
         * Collecte les détails complets des entretoises pour un panneau donné
         * @param {string} site - Site du panneau
         * @param {string} panneau - Nom du panneau
         * @return {Object} Détails complets des entretoises
         */
        function collectDetailledEntretoiseInfo(site, panneau) {
            console.log(`Collecte détails entretoises pour ${site} - ${panneau}`);

            // Récupérer toutes les entretoises nécessaires pour ce panneau
            const toutesEntretoisesNecessaires = getAllEntretoisesForPanneau(panneau, site);

            if (toutesEntretoisesNecessaires.length === 0) {
                console.log("Aucune entretoise nécessaire trouvée");
                return null;
            }

            const detailParEntretoise = [];
            let totalQuantiteFournie = 0;
            let montantTotal = 0;

            // Pour chaque entretoise nécessaire, calculer les détails
            toutesEntretoisesNecessaires.forEach(entretoiseNecessaire => {
                // Trouver si l'utilisateur fournit cette entretoise
                const entretoiseFournieParUser = selectedEntretoises.find(selected =>
                    selected.description.toLowerCase().includes(entretoiseNecessaire.nom.toLowerCase()) ||
                    cleanEntretoiseNameForDisplay(selected.description).toLowerCase() === entretoiseNecessaire.nom.toLowerCase()
                );

                const quantiteFournie = entretoiseFournieParUser ? (entretoiseFournieParUser.quantity || 0) : 0;
                const quantiteNecessaire = entretoiseNecessaire.quantite || 0;
                const quantiteAFournirCNR = Math.max(0, quantiteNecessaire - quantiteFournie);

                // Récupérer le prix unitaire
                const prixUnitaire = getEntretoisePrice(entretoiseNecessaire.nom, site) || 0;
                const sousTotal = prixUnitaire * quantiteAFournirCNR;

                if (quantiteNecessaire > 0) { // Inclure même si quantiteAFournirCNR = 0 pour l'affichage
                    detailParEntretoise.push({
                        nom: cleanEntretoiseNameForDisplay(entretoiseNecessaire.nom),
                        necessaire: quantiteNecessaire,
                        fournie: quantiteFournie,
                        aFournirCNR: quantiteAFournirCNR,
                        prixUnitaire: prixUnitaire,
                        sousTotal: sousTotal
                    });

                    totalQuantiteFournie += quantiteFournie;
                    montantTotal += sousTotal;
                }
            });

            console.log(`Détails collectés: ${detailParEntretoise.length} entretoises, Total fourni: ${totalQuantiteFournie}, Montant: ${montantTotal}`);

            return {
                site: site,
                panneau: panneau,
                totalQuantiteFournie: totalQuantiteFournie,
                detailParEntretoise: detailParEntretoise,
                montantTotal: montantTotal
            };
        }

        /**
         * Consolide tous les détails d'entretoises de tous les panneaux en un résumé global
         * @param {Object} detailEntretoisesComplet - Détails par panneau
         * @return {Object} Résumé consolidé pour l'export Excel
         */
        function consolidateEntretoiseDetails(detailEntretoisesComplet) {
            console.log("Consolidation des détails d'entretoises pour l'export");

            const panneauxKeys = Object.keys(detailEntretoisesComplet);

            if (panneauxKeys.length === 0) {
                return {
                    totalQuantiteFournie: 0,
                    nombrePanneaux: 0,
                    detailFormule: "Aucune entretoise",
                    montantTotal: 0,
                    details: []
                };
            }

            let totalQuantiteFournieGlobal = 0;
            let montantTotalGlobal = 0;
            const formuleParts = [];
            const detailsGlobaux = [];

            // Consolider les données de tous les panneaux
            panneauxKeys.forEach(panneauKey => {
                const detail = detailEntretoisesComplet[panneauKey];
                totalQuantiteFournieGlobal += detail.totalQuantiteFournie;
                montantTotalGlobal += detail.montantTotal;

                // Construire la partie de formule pour ce panneau
                const formulesPanneau = detail.detailParEntretoise
                    .filter(e => e.aFournirCNR > 0) // Seulement les entretoises que CNR doit fournir
                    .map(e => `${e.nom}: (${e.necessaire}-${e.fournie}) × ${e.prixUnitaire.toFixed(2)}€`);

                if (formulesPanneau.length > 0) {
                    formuleParts.push(`[${detail.panneau}] ${formulesPanneau.join(' + ')}`);
                }

                // Ajouter aux détails globaux
                detail.detailParEntretoise.forEach(e => {
                    detailsGlobaux.push({
                        ...e,
                        panneau: detail.panneau,
                        site: detail.site
                    });
                });
            });

            const detailFormule = formuleParts.length > 0 ? formuleParts.join(' | ') : "Toutes entretoises fournies par utilisateur";

            console.log(`Consolidation terminée: ${panneauxKeys.length} panneau(s), Total fourni: ${totalQuantiteFournieGlobal}, Montant: ${montantTotalGlobal}`);

            return {
                totalQuantiteFournie: totalQuantiteFournieGlobal,
                nombrePanneaux: panneauxKeys.length,
                detailFormule: detailFormule,
                montantTotal: montantTotalGlobal,
                details: detailsGlobaux
            };
        }

// Remplacer l'ancienne fonction collectPriceData par cette nouvelle version

        /**
         * Collecte les informations sur les sites et repères sélectionnés
         * @returns {Object} Un objet contenant les informations sur les sélections
         */
        function collectSelectionData() {
            // Créer un objet qui regroupe les panneaux par site
            const panneauxParSite = {};

            if (window.cumulativeResults) {
                window.cumulativeResults.forEach(item => {
                    // Ne considérer que les lignes de panneaux (pas les options)
                    if (!item.isTransportOnly && item.site && item.description) {
                        if (!panneauxParSite[item.site]) {
                            panneauxParSite[item.site] = [];
                        }

                        panneauxParSite[item.site].push({
                            description: item.description,
                            quantity: item.quantity || 0,
                            totalPrice: item.totalPrice || 0
                        });
                    }
                });
            }

            return {
                panneauxParSite: panneauxParSite
            };
        }
// Récupérer les données Excel via AJAX
        fetch('get_excel_data.php')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erreur réseau: ' + response.status);
                }
                return response.json();
            })
            .then(response => {
                if (getElement('loading')) {
                    getElement('loading').style.display = 'none';
                }

                // Stocker les données pour la recherche
                filesDataGlobal = response;

                try {
                    // Extraire les correspondances entretoises-panneaux
                    entretoisesParPanneaux = extractEntretoisesMapping(response);
                } catch (error) {
                    console.error("Erreur lors de l'extraction des entretoises:", error);
                    entretoisesParPanneaux = {};
                }

                // Extraire les sites et leurs items associés
                try {
                    const siteData = extractSiteData(response);
                    allSites = siteData.sites;
                    allItemsBySite = siteData.itemsBySite;
                } catch (error) {
                    console.error("Erreur lors de l'extraction des données des sites:", error);
                }

                // Remplir le sélecteur de sites
                try {
                    populateSiteSelect(allSites);
                } catch (error) {
                    console.error("Erreur lors du remplissage du sélecteur de sites:", error);
                }

                // Rendre les données Excel
                try {
                    if (getElement('excel-data')) {
                        getElement('excel-data').innerHTML = renderExcelFiles(response);
                    }
                } catch (error) {
                    console.error("Erreur lors du rendu des données Excel:", error);
                }

                // Configuration des gestionnaires d'événements après le rendu
                try {
                    setupEventHandlers();
                } catch (error) {
                    console.error("Erreur lors de la configuration des gestionnaires d'événements:", error);
                }

                // Masquer les données Excel
                try {
                    hideExcelData();
                } catch (error) {
                    console.error("Erreur lors du masquage des données Excel:", error);
                }
            })
            .catch(error => {
                console.error("Erreur lors du chargement des données Excel:", error);

                if (getElement('loading')) {
                    getElement('loading').style.display = 'none';
                }

                const excelDataDiv = getElement('excel-data');
                if (excelDataDiv) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error';
                    errorDiv.style.display = 'block';
                    errorDiv.textContent = 'Erreur: ' + error.message;
                    excelDataDiv.appendChild(errorDiv);
                }
            });
    });
</script>
</body>
</html>